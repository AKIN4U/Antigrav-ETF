This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.agent/workflows/deploy-to-vercel.md
.env.example
.gitignore
.vercelignore
docs/ADR-001-package-manager-migration.md
docs/AUTH_FIX_SUMMARY.md
docs/DEPLOYMENT_SUMMARY.md
docs/README.md
eslint.config.mjs
migration.sql
next-env.d.ts
next.config.ts
package.json
postcss.config.mjs
prisma/migrations/20260114134113_init_local_postgres/migration.sql
prisma/migrations/migration_lock.toml
prisma/schema.prisma
public/file.svg
public/globe.svg
public/hero-generated.png
public/hero-new.png
public/hero.png
public/next.svg
public/vercel.svg
public/window.svg
README.md
scripts/check-env.js
scripts/db-push.js
scripts/make-superadmin.js
src/app/about/page.tsx
src/app/admin/(dashboard)/applications/[id]/page.tsx
src/app/admin/(dashboard)/applications/page.tsx
src/app/admin/(dashboard)/disbursements/page.tsx
src/app/admin/(dashboard)/donations/page.tsx
src/app/admin/(dashboard)/finance/page.tsx
src/app/admin/(dashboard)/layout.tsx
src/app/admin/(dashboard)/page.tsx
src/app/admin/(dashboard)/reports/page.tsx
src/app/admin/assessments/page.tsx
src/app/admin/login/page.tsx
src/app/admin/register/committee/page.tsx
src/app/admin/users/page.tsx
src/app/api/admin/applications/[id]/route.ts
src/app/api/admin/applications/route.ts
src/app/api/admin/disbursements/route.ts
src/app/api/admin/donations/route.ts
src/app/api/admin/finance/route.ts
src/app/api/admin/register/route.ts
src/app/api/admin/reports/route.ts
src/app/api/admin/stats/route.ts
src/app/api/admin/users/check-status/route.ts
src/app/api/admin/users/route.ts
src/app/api/applications/[id]/assessments/route.ts
src/app/api/apply/route.ts
src/app/api/assessments/route.ts
src/app/api/dashboard/route.ts
src/app/apply/form/page.tsx
src/app/apply/page.tsx
src/app/dashboard/page.tsx
src/app/favicon.ico
src/app/globals.css
src/app/layout.tsx
src/app/login/page.tsx
src/app/page.tsx
src/app/register/page.tsx
src/components/apply/AcademicInfoStep.tsx
src/components/apply/DocumentUploadStep.tsx
src/components/apply/FamilyInfoStep.tsx
src/components/apply/PersonalInfoStep.tsx
src/components/apply/StepIndicator.tsx
src/components/AssessmentForm.tsx
src/components/AssessmentList.tsx
src/components/layout/Footer.tsx
src/components/layout/Header.tsx
src/components/layout/UserNav.tsx
src/lib/email.ts
src/lib/prisma.ts
src/lib/supabase.ts
src/lib/supabase/client.ts
src/lib/supabase/server.ts
src/lib/utils.ts
src/middleware.ts
src/types/index.ts
src/types/supabase.ts
tailwind.config.ts
tsconfig.json
vercel.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="prisma/migrations/20260114134113_init_local_postgres/migration.sql">
-- CreateTable
CREATE TABLE "Applicant" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "surname" TEXT NOT NULL,
    "firstName" TEXT NOT NULL,
    "middleName" TEXT,
    "age" INTEGER NOT NULL,
    "dob" TIMESTAMP(3) NOT NULL,
    "sex" TEXT NOT NULL,
    "stateOrigin" TEXT NOT NULL,
    "lga" TEXT NOT NULL,
    "town" TEXT NOT NULL,
    "address" TEXT NOT NULL,
    "phone" TEXT NOT NULL,
    "email" TEXT,
    "parish" TEXT NOT NULL DEFAULT 'Central Cathedral Abuja',
    "prevScholarship" BOOLEAN NOT NULL DEFAULT false,
    "prevScholarshipDate" TEXT,

    CONSTRAINT "Applicant_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "FamilyInfo" (
    "id" TEXT NOT NULL,
    "applicantId" TEXT NOT NULL,
    "fatherSurname" TEXT,
    "fatherFirstName" TEXT,
    "fatherMiddleName" TEXT,
    "fatherAddress" TEXT,
    "fatherPhone" TEXT,
    "fatherState" TEXT,
    "fatherLga" TEXT,
    "fatherTown" TEXT,
    "fatherOccupation" TEXT,
    "fatherEmployer" TEXT,
    "fatherSalaryGrade" TEXT,
    "fatherIncome" TEXT,
    "fatherObligations" TEXT,
    "fatherSpouse" TEXT,
    "fatherNumChildren" INTEGER,
    "fatherChildrenAges" TEXT,
    "fatherYearsServed" TEXT,
    "fatherChurchPosition" TEXT,
    "fatherChurchDuties" TEXT,
    "motherSurname" TEXT,
    "motherFirstName" TEXT,
    "motherMiddleName" TEXT,
    "motherAddress" TEXT,
    "motherPhone" TEXT,
    "motherState" TEXT,
    "motherLga" TEXT,
    "motherTown" TEXT,
    "motherOccupation" TEXT,
    "motherEmployer" TEXT,
    "motherSalaryGrade" TEXT,
    "motherIncome" TEXT,
    "motherObligations" TEXT,
    "motherSpouse" TEXT,
    "motherNumChildren" INTEGER,
    "motherChildrenAges" TEXT,
    "motherYearsServed" TEXT,
    "motherChurchPosition" TEXT,
    "motherChurchDuties" TEXT,

    CONSTRAINT "FamilyInfo_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Application" (
    "id" TEXT NOT NULL,
    "applicantId" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'Pending',
    "schoolName" TEXT NOT NULL,
    "schoolAddress" TEXT NOT NULL,
    "presentClass" TEXT NOT NULL,
    "classPosition" TEXT,
    "classSize" INTEGER,
    "schoolFees" TEXT NOT NULL,
    "textBooksCost" TEXT,
    "enoughBooks" BOOLEAN NOT NULL DEFAULT false,
    "libraryAccess" BOOLEAN NOT NULL DEFAULT false,
    "sentAway" BOOLEAN NOT NULL DEFAULT false,
    "repeatedClass" BOOLEAN NOT NULL DEFAULT false,
    "lastResult" TEXT,
    "schoolBillUrl" TEXT,
    "birthCertUrl" TEXT,
    "primaryCertUrl" TEXT,
    "schoolResultUrl" TEXT,
    "assistanceLetterUrl" TEXT,
    "admissionLetterUrl" TEXT,
    "passportUrl" TEXT,
    "scoreFinancial" INTEGER,
    "scoreAcademic" INTEGER,
    "scoreChurch" INTEGER,
    "committeeNotes" TEXT,
    "approvedAmount" TEXT,
    "voucherCode" TEXT,
    "disbursedDate" TIMESTAMP(3),
    "paymentReference" TEXT,

    CONSTRAINT "Application_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "AdminUser" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT,
    "role" TEXT NOT NULL DEFAULT 'Admin',
    "status" TEXT NOT NULL DEFAULT 'Pending',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "AdminUser_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Assessment" (
    "id" TEXT NOT NULL,
    "applicationId" TEXT NOT NULL,
    "adminUserId" TEXT NOT NULL,
    "financialScore" INTEGER NOT NULL DEFAULT 0,
    "academicScore" INTEGER NOT NULL DEFAULT 0,
    "churchScore" INTEGER NOT NULL DEFAULT 0,
    "totalScore" INTEGER NOT NULL DEFAULT 0,
    "notes" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Assessment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Budget" (
    "id" TEXT NOT NULL,
    "year" INTEGER NOT NULL,
    "quarter" INTEGER,
    "category" TEXT NOT NULL,
    "allocated" DECIMAL(12,2) NOT NULL,
    "spent" DECIMAL(12,2) NOT NULL DEFAULT 0,
    "description" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Budget_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Transaction" (
    "id" TEXT NOT NULL,
    "budgetId" TEXT,
    "type" TEXT NOT NULL,
    "category" TEXT NOT NULL,
    "amount" DECIMAL(12,2) NOT NULL,
    "description" TEXT NOT NULL,
    "reference" TEXT,
    "date" TIMESTAMP(3) NOT NULL,
    "createdBy" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Transaction_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Donation" (
    "id" TEXT NOT NULL,
    "transactionId" TEXT NOT NULL,
    "donorName" TEXT NOT NULL,
    "donorEmail" TEXT,
    "donorPhone" TEXT,
    "donorAddress" TEXT,
    "donationType" TEXT NOT NULL,
    "isAnonymous" BOOLEAN NOT NULL DEFAULT false,
    "purpose" TEXT,
    "receiptIssued" BOOLEAN NOT NULL DEFAULT false,
    "receiptNumber" TEXT,
    "notes" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Donation_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "Applicant_email_key" ON "Applicant"("email");

-- CreateIndex
CREATE UNIQUE INDEX "FamilyInfo_applicantId_key" ON "FamilyInfo"("applicantId");

-- CreateIndex
CREATE UNIQUE INDEX "AdminUser_email_key" ON "AdminUser"("email");

-- CreateIndex
CREATE UNIQUE INDEX "Assessment_applicationId_adminUserId_key" ON "Assessment"("applicationId", "adminUserId");

-- CreateIndex
CREATE UNIQUE INDEX "Budget_year_quarter_category_key" ON "Budget"("year", "quarter", "category");

-- CreateIndex
CREATE UNIQUE INDEX "Donation_transactionId_key" ON "Donation"("transactionId");

-- AddForeignKey
ALTER TABLE "FamilyInfo" ADD CONSTRAINT "FamilyInfo_applicantId_fkey" FOREIGN KEY ("applicantId") REFERENCES "Applicant"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Application" ADD CONSTRAINT "Application_applicantId_fkey" FOREIGN KEY ("applicantId") REFERENCES "Applicant"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Assessment" ADD CONSTRAINT "Assessment_applicationId_fkey" FOREIGN KEY ("applicationId") REFERENCES "Application"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Assessment" ADD CONSTRAINT "Assessment_adminUserId_fkey" FOREIGN KEY ("adminUserId") REFERENCES "AdminUser"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Transaction" ADD CONSTRAINT "Transaction_budgetId_fkey" FOREIGN KEY ("budgetId") REFERENCES "Budget"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Donation" ADD CONSTRAINT "Donation_transactionId_fkey" FOREIGN KEY ("transactionId") REFERENCES "Transaction"("id") ON DELETE CASCADE ON UPDATE CASCADE;
</file>

<file path=".agent/workflows/deploy-to-vercel.md">
---
description: Deploy the ETF platform to Vercel for pre-production testing
---

# Deploy to Vercel Workflow

This workflow guides you through deploying the ETF platform to Vercel for pre-production testing with committee members.

## Prerequisites

Before deploying, ensure:
1. You have a Vercel account (sign up at https://vercel.com if needed)
2. Vercel CLI is installed (`npm i -g vercel`)
3. All environment variables are documented
4. The application builds successfully locally

## Step 1: Verify Local Build

First, ensure the application builds without errors:

```bash
npm run build
```

This will catch any build-time errors before deploying.

## Step 2: Login to Vercel

If not already logged in, authenticate with Vercel:

```bash
vercel login
```

This will open a browser window for authentication.

## Step 3: Review Environment Variables

Check your `.env` file and identify which variables need to be set in Vercel:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `RESEND_API_KEY`
- Any other custom environment variables

**Important**: Never commit `.env` to git. Environment variables will be set in Vercel dashboard.

## Step 4: Deploy to Vercel (Preview)

Deploy to a preview environment first:

// turbo
```bash
vercel
```

This command will:
- Link your project to Vercel (first time only)
- Ask you to confirm project settings
- Deploy to a preview URL
- Provide a URL for testing

**During first deployment**, you'll be asked:
- Set up and deploy? (Y)
- Which scope? (Select your account/team)
- Link to existing project? (N for new project)
- Project name? (Accept default or customize)
- In which directory is your code located? (./)
- Want to override settings? (N)

## Step 5: Set Environment Variables in Vercel

After deployment, add environment variables:

**Option A: Via Vercel Dashboard**
1. Go to https://vercel.com/dashboard
2. Select your project
3. Go to Settings → Environment Variables
4. Add each variable for Production, Preview, and Development environments

**Option B: Via CLI**
```bash
vercel env add NEXT_PUBLIC_SUPABASE_URL
vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY
vercel env add SUPABASE_SERVICE_ROLE_KEY
vercel env add RESEND_API_KEY
```

## Step 6: Redeploy with Environment Variables

After adding environment variables, redeploy:

```bash
vercel --prod
```

This deploys to production with all environment variables.

## Step 7: Test the Deployment

1. Visit the deployment URL provided by Vercel
2. Test key functionality:
   - Homepage loads correctly
   - Application form works
   - Admin portal is accessible
   - Database connections work
   - Email notifications work (if applicable)

## Step 8: Share with Committee Members

Once testing is successful:
1. Copy the production URL from Vercel
2. Share with committee members for pre-production testing
3. Monitor the deployment for any issues

## Troubleshooting

### Build Fails
- Check build logs in Vercel dashboard
- Ensure all dependencies are in `package.json`
- Verify TypeScript types are correct

### Environment Variables Not Working
- Ensure variables are set for the correct environment (Production/Preview)
- Redeploy after adding new variables
- Check variable names match exactly (case-sensitive)

### Database Connection Issues
- Verify Supabase URL and keys are correct
- Check Supabase project is active
- Ensure database migrations are applied

### 404 Errors
- Check `vercel.json` configuration
- Verify Next.js routing is correct
- Check build output directory

## Continuous Deployment

Vercel automatically deploys:
- **Production**: When you push to `main` branch
- **Preview**: When you push to other branches or open PRs

To enable this, connect your GitHub repository in Vercel dashboard.

## Useful Commands

- `vercel` - Deploy to preview
- `vercel --prod` - Deploy to production
- `vercel logs` - View deployment logs
- `vercel env ls` - List environment variables
- `vercel domains` - Manage custom domains
- `vercel inspect <url>` - Get deployment details
</file>

<file path=".vercelignore">
.next
node_modules
build_log.txt
build_error.log
*.log
.env.local
.env.*.local
</file>

<file path="docs/ADR-001-package-manager-migration.md">
# ADR 001: Package Manager Migration to PNPM

**Date**: 2025-01-13

**Status**: Accepted

## Context and Problem Statement

The project was previously using npm and its `package-lock.json` for dependency management. While functional, npm can lead to slower installation times and large `node_modules` directories, especially as the project scales. We needed a more performant, disk-efficient, and strict package manager to ensure consistency and speed up our CI/CD pipelines and local development setup.

## Decision Drivers

1.  **Performance**: `pnpm` is significantly faster than npm and yarn due to its content-addressable storage and symlinking strategy.
2.  **Disk Space Efficiency**: Dependencies are stored in a global, on-disk store and linked into projects. This means we don't duplicate packages across different projects on the same machine.
3.  **Strictness**: `pnpm` creates a non-flat `node_modules` directory, preventing packages from accessing dependencies they don't explicitly declare in `package.json`. This avoids phantom dependency issues.

## Considered Options

-   **npm**: The default, but slower and less efficient.
-   **Yarn**: A solid alternative, but pnpm's performance and efficiency advantages are more pronounced.
-   **pnpm**: Chosen for its superior speed, disk efficiency, and strict dependency resolution.

## Decision Outcome

We have officially migrated the project to use `pnpm` as the sole package manager.

### Consequences

-   **Positive**:
    -   Faster dependency installation for both local development and CI/CD environments.
    -   Reduced disk space usage.
    -   Improved reliability by eliminating phantom dependency risks.
-   **Negative**:
    -   All developers must now have `pnpm` installed and use `pnpm` commands (e.g., `pnpm add`, `pnpm install`, `pnpm dev`). The old `npm` commands will not work correctly with the `pnpm-lock.yaml` file.

## Implementation Steps

1.  The `package-lock.json` file was removed from the project.
2.  The `node_modules` directory was deleted to ensure a clean slate.
3.  `pnpm install` was run to generate a `pnpm-lock.yaml` file and install dependencies.
4.  All team members have been notified of the change and instructed to use `pnpm`.
</file>

<file path="docs/AUTH_FIX_SUMMARY.md">
# Authentication Fix - Deployment Update

## Issue Resolved
The register and login pages were failing with "Failed to fetch" errors because the Supabase client-side environment variables were missing from Vercel's production environment.

## Root Cause
While `DATABASE_URL` and `RESEND_API_KEY` were configured on Vercel, the client-side Supabase variables were missing:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

These are required for the `@supabase/auth-helpers-nextjs` package to work in the browser.

## Fix Applied
1. Added `NEXT_PUBLIC_SUPABASE_URL` to Vercel production environment
2. Added `NEXT_PUBLIC_SUPABASE_ANON_KEY` to Vercel production environment
3. Redeployed the application to apply the new environment variables

## New Production URL
https://antigrav-oigi8p33i-akin-sowemimos-projects.vercel.app

## Testing
You should now be able to:
- ✅ Register new accounts
- ✅ Login with existing accounts
- ✅ Use all Supabase authentication features

The Supabase client will now properly initialize in the browser with the correct project URL and anonymous key.
</file>

<file path="docs/DEPLOYMENT_SUMMARY.md">
# Deployment Summary

## Status: SUCCESS
The application has been successfully deployed to Vercel.

**Production URL:** https://antigrav-fsi0gfufv-akin-sowemimos-projects.vercel.app

## Key Fixes Implemented

1.  **Prisma Client Initialization**:
    *   Created `src/lib/prisma.ts` to export a singleton `PrismaClient` instance.
    *   This prevents multiple connections and ensures the client is reused, which is critical for serverless environments like Vercel.
    *   Updated all API routes to use this shared client.

2.  **Supabase Client Safety**:
    *   Modified `src/lib/supabase/client.ts` to wrap `createClientComponentClient` in a try-catch block.
    *   This prevents the build from crashing during static export of client components when the Supabase environment is not fully available.

3.  **TypeScript Build Errors**:
    *   Simplified helper types in `src/types/supabase.ts` to resolve complex conditional type errors that were failing the build.

4.  **API Route Fixes**:
    *   **`src/app/api/admin/applications/route.ts`**: Restored the correct `GET` handler for fetching the applications list.
    *   **`src/app/api/admin/applications/[id]/route.ts`**:
        *   Fixed `params` handling for Next.js 15+ (awaited the `params` object).
        *   Implemented `PATCH` handler for status updates.
        *   Added email notification logic using `Resend` when application status changes.

5.  **Vercel Configuration**:
    *   Added `postinstall: "prisma generate"` to `package.json` to ensure the Prisma client is generated during the Vercel build process.
    *   Added necessary environment variables (`DATABASE_URL`, `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `RESEND_API_KEY`) to the Vercel project.

## Next Steps for User
1.  **Verify Functionality**: Log in to the deployed application and test the admin dashboard, application submission, and status updates.
2.  **Email Testing**: Verify that email notifications are being sent via Resend when an application status is updated.
3.  **Database Migrations**: Ensure your production database schema is up to date (Vercel deployment doesn't automatically run migrations, though `prisma generate` updates the client). You might need to run `npx prisma migrate deploy` against your production database if you haven't already.
</file>

<file path="docs/README.md">
# Project Documentation and Logs\n\nThis directory contains build artifacts, deployment summaries, and historical logs for debugging purposes.
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="migration.sql">
-- CreateTable
CREATE TABLE "Applicant" (
    "id" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "surname" TEXT NOT NULL,
    "firstName" TEXT NOT NULL,
    "middleName" TEXT,
    "age" INTEGER NOT NULL,
    "dob" TIMESTAMP(3) NOT NULL,
    "sex" TEXT NOT NULL,
    "stateOrigin" TEXT NOT NULL,
    "lga" TEXT NOT NULL,
    "town" TEXT NOT NULL,
    "address" TEXT NOT NULL,
    "phone" TEXT NOT NULL,
    "email" TEXT,
    "parish" TEXT NOT NULL DEFAULT 'Central Cathedral Abuja',
    "prevScholarship" BOOLEAN NOT NULL DEFAULT false,
    "prevScholarshipDate" TEXT,

    CONSTRAINT "Applicant_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "FamilyInfo" (
    "id" TEXT NOT NULL,
    "applicantId" TEXT NOT NULL,
    "fatherSurname" TEXT,
    "fatherFirstName" TEXT,
    "fatherMiddleName" TEXT,
    "fatherAddress" TEXT,
    "fatherPhone" TEXT,
    "fatherState" TEXT,
    "fatherLga" TEXT,
    "fatherTown" TEXT,
    "fatherOccupation" TEXT,
    "fatherEmployer" TEXT,
    "fatherSalaryGrade" TEXT,
    "fatherIncome" TEXT,
    "fatherObligations" TEXT,
    "fatherSpouse" TEXT,
    "fatherNumChildren" INTEGER,
    "fatherChildrenAges" TEXT,
    "fatherYearsServed" TEXT,
    "fatherChurchPosition" TEXT,
    "fatherChurchDuties" TEXT,
    "motherSurname" TEXT,
    "motherFirstName" TEXT,
    "motherMiddleName" TEXT,
    "motherAddress" TEXT,
    "motherPhone" TEXT,
    "motherState" TEXT,
    "motherLga" TEXT,
    "motherTown" TEXT,
    "motherOccupation" TEXT,
    "motherEmployer" TEXT,
    "motherSalaryGrade" TEXT,
    "motherIncome" TEXT,
    "motherObligations" TEXT,
    "motherSpouse" TEXT,
    "motherNumChildren" INTEGER,
    "motherChildrenAges" TEXT,
    "motherYearsServed" TEXT,
    "motherChurchPosition" TEXT,
    "motherChurchDuties" TEXT,

    CONSTRAINT "FamilyInfo_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Application" (
    "id" TEXT NOT NULL,
    "applicantId" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "status" TEXT NOT NULL DEFAULT 'Pending',
    "schoolName" TEXT NOT NULL,
    "schoolAddress" TEXT NOT NULL,
    "presentClass" TEXT NOT NULL,
    "classPosition" TEXT,
    "classSize" INTEGER,
    "schoolFees" TEXT NOT NULL,
    "textBooksCost" TEXT,
    "enoughBooks" BOOLEAN NOT NULL DEFAULT false,
    "libraryAccess" BOOLEAN NOT NULL DEFAULT false,
    "sentAway" BOOLEAN NOT NULL DEFAULT false,
    "repeatedClass" BOOLEAN NOT NULL DEFAULT false,
    "lastResult" TEXT,
    "schoolBillUrl" TEXT,
    "birthCertUrl" TEXT,
    "primaryCertUrl" TEXT,
    "schoolResultUrl" TEXT,
    "assistanceLetterUrl" TEXT,
    "admissionLetterUrl" TEXT,
    "passportUrl" TEXT,
    "scoreFinancial" INTEGER,
    "scoreAcademic" INTEGER,
    "scoreChurch" INTEGER,
    "committeeNotes" TEXT,
    "approvedAmount" TEXT,
    "voucherCode" TEXT,

    CONSTRAINT "Application_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "Applicant_email_key" ON "Applicant"("email");

-- CreateIndex
CREATE UNIQUE INDEX "FamilyInfo_applicantId_key" ON "FamilyInfo"("applicantId");

-- AddForeignKey
ALTER TABLE "FamilyInfo" ADD CONSTRAINT "FamilyInfo_applicantId_fkey" FOREIGN KEY ("applicantId") REFERENCES "Applicant"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Application" ADD CONSTRAINT "Application_applicantId_fkey" FOREIGN KEY ("applicantId") REFERENCES "Applicant"("id") ON DELETE CASCADE ON UPDATE CASCADE;
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="prisma/migrations/migration_lock.toml">
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="scripts/check-env.js">
/* eslint-disable @typescript-eslint/no-require-imports */
const fs = require('fs');
const path = require('path');
const dotenv = require('dotenv');

const envPath = path.resolve(__dirname, '../.env');
console.log(`Checking for .env at: ${envPath}`);

if (fs.existsSync(envPath)) {
    console.log('.env file exists.');
    const result = dotenv.config({ path: envPath });

    if (result.error) {
        console.error('Error loading .env file:', result.error);
    } else {
        console.log('.env loaded successfully.');
        const dbUrl = process.env.DATABASE_URL;
        if (dbUrl) {
            console.log('DATABASE_URL is PRESENT.');
            // Check if it looks valid-ish (starts with postgres:// or postgresql://)
            if (dbUrl.startsWith('postgres')) {
                console.log('DATABASE_URL format looks correct (starts with postgres...).');
            } else {
                console.log('WARNING: DATABASE_URL does not start with "postgres".');
            }
        } else {
            console.error('ERROR: DATABASE_URL is MISSING from .env.');
        }
    }
} else {
    console.error('ERROR: .env file NOT found at expected path.');
}
</file>

<file path="scripts/db-push.js">
/* eslint-disable @typescript-eslint/no-require-imports */
const { execSync } = require('child_process');
require('dotenv').config();

console.log('Current directory:', process.cwd());
console.log('DATABASE_URL loaded:', !!process.env.DATABASE_URL);
if (process.env.DATABASE_URL) {
    console.log('DATABASE_URL prefix:', process.env.DATABASE_URL.substring(0, 15));
    if (process.env.DATABASE_URL.includes('YOUR_PASSWORD')) {
        console.error('ERROR: DATABASE_URL contains placeholder password "YOUR_PASSWORD"');
    }
}

try {
    console.log('Running prisma db push...');
    execSync('npx prisma db push --accept-data-loss', { stdio: 'inherit' });
} catch (error) {
    console.error('Failed to run prisma db push');
    if (error.stdout) console.log('Stdout:', error.stdout.toString());
    if (error.stderr) console.error('Stderr:', error.stderr.toString());
    process.exit(1);
}
</file>

<file path="scripts/make-superadmin.js">
/* eslint-disable @typescript-eslint/no-require-imports */
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();
const email = process.argv[2];

if (!email) {
    console.log('Please provide an email address: node scripts/make-superadmin.js <email>');
    process.exit(1);
}

async function main() {
    console.log(`Promoting ${email} to SuperAdmin...`);

    // Check if user exists
    const user = await prisma.adminUser.findUnique({
        where: { email },
    });

    if (!user) {
        console.log(`User ${email} not found in AdminUser table.`);
        // Optionally create them?
        console.log('Creating new AdminUser...');
        await prisma.adminUser.create({
            data: {
                email,
                role: 'SuperAdmin',
                name: 'SuperAdmin (Script)',
            },
        });
        console.log('Created and set to SuperAdmin.');
    } else {
        await prisma.adminUser.update({
            where: { email },
            data: { role: 'SuperAdmin' },
        });
        console.log(`User ${email} updated to SuperAdmin.`);
    }
}

main()
    .catch((e) => {
        console.error(e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });
</file>

<file path="src/app/about/page.tsx">
import { CheckCircle, AlertCircle } from "lucide-react";

export default function AboutPage() {
    return (
        <div className="container mx-auto px-4 py-12 max-w-4xl">
            <div className="space-y-8">
                <div className="text-center space-y-4">
                    <h1 className="text-4xl font-bold tracking-tight text-primary">About the ETF</h1>
                    <p className="text-xl text-muted-foreground">
                        The CCC Central Cathedral Abuja Education Trust Fund (ETF) is designed to support the educational aspirations of our youth.
                    </p>
                </div>

                <div className="grid gap-8 md:grid-cols-2">
                    <div className="bg-card rounded-lg border p-6 shadow-sm">
                        <h2 className="text-2xl font-semibold mb-4 flex items-center gap-2">
                            <CheckCircle className="h-6 w-6 text-secondary" />
                            Eligibility Criteria
                        </h2>
                        <ul className="space-y-3 text-muted-foreground">
                            <li className="flex items-start gap-2">
                                <span className="mt-1.5 h-1.5 w-1.5 rounded-full bg-primary flex-shrink-0" />
                                Must be a registered member of CCC Central Cathedral Abuja.
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="mt-1.5 h-1.5 w-1.5 rounded-full bg-primary flex-shrink-0" />
                                Genuine student in an eligible institution (Primary, Secondary, or Tertiary).
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="mt-1.5 h-1.5 w-1.5 rounded-full bg-primary flex-shrink-0" />
                                Demonstrable financial need (indigent status).
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="mt-1.5 h-1.5 w-1.5 rounded-full bg-primary flex-shrink-0" />
                                One child per family policy applies.
                            </li>
                        </ul>
                    </div>

                    <div className="bg-card rounded-lg border p-6 shadow-sm">
                        <h2 className="text-2xl font-semibold mb-4 flex items-center gap-2">
                            <AlertCircle className="h-6 w-6 text-secondary" />
                            Funding Ceilings
                        </h2>
                        <ul className="space-y-4">
                            <li className="flex justify-between items-center border-b pb-2">
                                <span>Primary School</span>
                                <span className="font-bold text-primary">Up to ₦30,000</span>
                            </li>
                            <li className="flex justify-between items-center border-b pb-2">
                                <span>JSS / SSS</span>
                                <span className="font-bold text-primary">Up to ₦50,000</span>
                            </li>
                            <li className="flex justify-between items-center border-b pb-2">
                                <span>Tertiary Institution</span>
                                <span className="font-bold text-primary">Up to ₦60,000</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div className="bg-muted/30 rounded-lg p-8">
                    <h2 className="text-2xl font-bold mb-4">Application Process</h2>
                    <div className="grid gap-6 md:grid-cols-4">
                        <div className="space-y-2">
                            <div className="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center font-bold">1</div>
                            <h3 className="font-semibold">Apply</h3>
                            <p className="text-sm text-muted-foreground">Submit application online or offline with required documents.</p>
                        </div>
                        <div className="space-y-2">
                            <div className="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center font-bold">2</div>
                            <h3 className="font-semibold">Screening</h3>
                            <p className="text-sm text-muted-foreground">Committee reviews eligibility and conducts interviews.</p>
                        </div>
                        <div className="space-y-2">
                            <div className="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center font-bold">3</div>
                            <h3 className="font-semibold">Verification</h3>
                            <p className="text-sm text-muted-foreground">School bills and enrollment status are verified.</p>
                        </div>
                        <div className="space-y-2">
                            <div className="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center font-bold">4</div>
                            <h3 className="font-semibold">Disbursement</h3>
                            <p className="text-sm text-muted-foreground">Funds paid directly to the school account.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/(dashboard)/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Users, FileText, CheckCircle, AlertCircle, Loader2 } from "lucide-react";
import Link from "next/link";

export default function AdminDashboardPage() {
    const [stats, setStats] = useState({
        totalApplications: 0,
        pendingReview: 0,
        approvedScholars: 0,
        totalBeneficiaries: 0,
    });
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        const fetchStats = async () => {
            try {
                const response = await fetch("/api/admin/stats");
                const result = await response.json();
                if (result.success) {
                    setStats(result.data);
                }
            } catch (error) {
                console.error("Error fetching stats:", error);
            } finally {
                setIsLoading(false);
            }
        };

        fetchStats();
    }, []);

    if (isLoading) {
        return (
            <div className="flex h-[50vh] items-center justify-center">
                <Loader2 className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    return (
        <div className="space-y-8 animate-fade-in">
            <div>
                <h1 className="text-3xl font-bold text-primary">Dashboard Overview</h1>
                <p className="text-muted-foreground">Welcome back, Committee Member.</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-card p-6 rounded-xl border shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-sm font-medium text-muted-foreground">Total Applications</h3>
                        <FileText className="h-5 w-5 text-blue-500" />
                    </div>
                    <p className="text-3xl font-bold">{stats.totalApplications}</p>
                    <p className="text-xs text-muted-foreground mt-1">+12% from last month</p>
                </div>

                <div className="bg-card p-6 rounded-xl border shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-sm font-medium text-muted-foreground">Pending Review</h3>
                        <AlertCircle className="h-5 w-5 text-yellow-500" />
                    </div>
                    <p className="text-3xl font-bold">{stats.pendingReview}</p>
                    <p className="text-xs text-muted-foreground mt-1">Requires attention</p>
                </div>

                <div className="bg-card p-6 rounded-xl border shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-sm font-medium text-muted-foreground">Approved Scholars</h3>
                        <CheckCircle className="h-5 w-5 text-green-500" />
                    </div>
                    <p className="text-3xl font-bold">{stats.approvedScholars}</p>
                    <p className="text-xs text-muted-foreground mt-1">For this session</p>
                </div>

                <div className="bg-card p-6 rounded-xl border shadow-sm hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-sm font-medium text-muted-foreground">Total Beneficiaries</h3>
                        <Users className="h-5 w-5 text-purple-500" />
                    </div>
                    <p className="text-3xl font-bold">{stats.totalBeneficiaries}</p>
                    <p className="text-xs text-muted-foreground mt-1">Lifetime impact</p>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-card border rounded-xl shadow-sm p-6">
                    <h3 className="text-lg font-semibold mb-4">Recent Applications</h3>
                    <div className="space-y-4">
                        <div className="text-center py-8 text-muted-foreground">
                            <Link href="/admin/applications" className="text-primary hover:underline">
                                View all applications
                            </Link>
                        </div>
                    </div>
                </div>

                <div className="bg-card border rounded-xl shadow-sm p-6">
                    <h3 className="text-lg font-semibold mb-4">Quick Actions</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <button className="p-4 border rounded-lg hover:bg-accent text-left transition-colors">
                            <span className="block font-medium">Generate Report</span>
                            <span className="text-xs text-muted-foreground">Download PDF summary</span>
                        </button>
                        <button className="p-4 border rounded-lg hover:bg-accent text-left transition-colors">
                            <span className="block font-medium">Review Pending</span>
                            <span className="text-xs text-muted-foreground">Go to screening</span>
                        </button>
                        <button className="p-4 border rounded-lg hover:bg-accent text-left transition-colors">
                            <span className="block font-medium">Disburse Funds</span>
                            <span className="text-xs text-muted-foreground">Process payments</span>
                        </button>
                        <button className="p-4 border rounded-lg hover:bg-accent text-left transition-colors">
                            <span className="block font-medium">Settings</span>
                            <span className="text-xs text-muted-foreground">System config</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/assessments/page.tsx">
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";

export default function AssessmentsPage() {
    const [assessments, setAssessments] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchAssessments();
    }, []);

    const fetchAssessments = async () => {
        try {
            const res = await fetch("/api/assessments");
            if (res.ok) {
                const data = await res.json();
                setAssessments(data.assessments || []);
            }
        } catch (error) {
            console.error("Failed to fetch assessments", error);
        } finally {
            setLoading(false);
        }
    };

    if (loading) return <div className="p-8">Loading assessments...</div>;

    return (
        <div className="p-6">
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-gray-800 dark:text-white">My Assessments</h1>
                <Link
                    href="/admin/applications"
                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                    Score New Application
                </Link>
            </div>

            <div className="bg-white rounded-lg shadow overflow-hidden dark:bg-gray-800">
                <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead className="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Applicant</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Financial</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Academic</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Church</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Total</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                        {assessments.map((assessment) => (
                            <tr key={assessment.id}>
                                <td className="px-6 py-4 whitespace-nowrap">
                                    <div className="text-sm font-medium text-gray-900 dark:text-white">
                                        {assessment.application?.applicant?.surname} {assessment.application?.applicant?.firstName}
                                    </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                                    {assessment.financialScore}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                                    {assessment.academicScore}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                                    {assessment.churchScore}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">
                                    {assessment.totalScore}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <Link
                                        href={`/admin/applications/${assessment.applicationId}`}
                                        className="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                                    >
                                        Edit
                                    </Link>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {assessments.length === 0 && (
                    <div className="p-6 text-center text-gray-500">
                        No assessments found. Go to Applications to start scoring.
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/register/committee/page.tsx">
"use client";

import { useState } from "react";
import { UserPlus, Loader2, CheckCircle, AlertCircle, Shield } from "lucide-react";
import Link from "next/link";

export default function CommitteeRegistrationPage() {
    const [isLoading, setIsLoading] = useState(false);
    const [success, setSuccess] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const [formData, setFormData] = useState({
        name: "",
        email: "",
        password: "",
        confirmPassword: "",
    });

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError(null);

        if (formData.password !== formData.confirmPassword) {
            setError("Passwords do not match");
            return;
        }

        if (formData.password.length < 8) {
            setError("Password must be at least 8 characters");
            return;
        }

        try {
            setIsLoading(true);
            const response = await fetch("/api/admin/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: formData.name,
                    email: formData.email,
                    password: formData.password
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Registration failed");
            }

            setSuccess(true);
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        } finally {
            setIsLoading(false);
        }
    };

    if (success) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
                <div className="w-full max-w-md bg-card border rounded-xl shadow-lg p-8 text-center space-y-6">
                    <div className="flex justify-center">
                        <div className="h-16 w-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                            <CheckCircle className="h-10 w-10 text-green-600 dark:text-green-500" />
                        </div>
                    </div>
                    <div>
                        <h2 className="text-2xl font-bold">Registration Successful!</h2>
                        <p className="text-muted-foreground mt-2">
                            Your account has been created and is currently <strong>Pending Approval</strong> by a Super Admin.
                            You will be notified once your account is active.
                        </p>
                    </div>
                    <div className="pt-4">
                        <Link
                            href="/admin/login"
                            className="inline-flex w-full items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 transition-colors"
                        >
                            Return to Login
                        </Link>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
            <div className="w-full max-w-md space-y-8">
                <div className="text-center">
                    <div className="flex justify-center mb-4">
                        <div className="h-12 w-12 bg-primary/10 rounded-full flex items-center justify-center">
                            <Shield className="h-8 w-8 text-primary" />
                        </div>
                    </div>
                    <h1 className="text-2xl font-bold tracking-tight">Committee Registration</h1>
                    <p className="text-muted-foreground mt-2">Create an account to join the ETF Committee</p>
                </div>

                <div className="bg-card border rounded-xl shadow-sm p-8">
                    {error && (
                        <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md flex items-center gap-2 text-red-600 dark:text-red-400 text-sm">
                            <AlertCircle className="h-4 w-4 shrink-0" />
                            {error}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Full Name</label>
                            <input
                                type="text"
                                required
                                value={formData.name}
                                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary bg-background"
                                placeholder="John Doe"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Email Address</label>
                            <input
                                type="email"
                                required
                                value={formData.email}
                                onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary bg-background"
                                placeholder="john@cccabuja.org"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Password</label>
                            <input
                                type="password"
                                required
                                minLength={8}
                                value={formData.password}
                                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary bg-background"
                                placeholder="Min. 8 characters"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-1">Confirm Password</label>
                            <input
                                type="password"
                                required
                                value={formData.confirmPassword}
                                onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
                                className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary bg-background"
                                placeholder="Confirm password"
                            />
                        </div>

                        <button
                            type="submit"
                            disabled={isLoading}
                            className="w-full flex items-center justify-center gap-2 bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors disabled:opacity-50 font-medium"
                        >
                            {isLoading ? (
                                <>
                                    <Loader2 className="h-4 w-4 animate-spin" />
                                    Creating Account...
                                </>
                            ) : (
                                <>
                                    <UserPlus className="h-4 w-4" />
                                    Register
                                </>
                            )}
                        </button>
                    </form>

                    <div className="mt-6 text-center text-sm">
                        <span className="text-muted-foreground">Already have an account? </span>
                        <Link href="/admin/login" className="text-primary hover:underline font-medium">
                            Sign in
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/api/admin/register/route.ts">
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

export const dynamic = "force-dynamic";

// Initialize Supabase Admin Client for Privileged Ops
const getSupabaseAdmin = () => {
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY || "",
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false,
            },
        }
    );
};

// Helper to check for configuration
function checkConfig() {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        throw new Error("SUPABASE_SERVICE_ROLE_KEY is not defined");
    }
}

export async function POST(req: NextRequest) {
    try {
        checkConfig();
        const body = await req.json();
        const { email, name, password } = body;

        // Basic validation
        if (!email || !name || !password) {
            return NextResponse.json(
                { error: "Email, name, and password are required" },
                { status: 400 }
            );
        }

        if (password.length < 8) {
            return NextResponse.json(
                { error: "Password must be at least 8 characters" },
                { status: 400 }
            );
        }

        // Initialize Admin Client
        const supabaseAdmin = getSupabaseAdmin();

        // 1. Check if user already exists in AdminUser table
        const { data: existingAdmin } = await supabaseAdmin
            .from("AdminUser")
            .select("id")
            .eq("email", email)
            .single();

        if (existingAdmin) {
            return NextResponse.json(
                { error: "An account with this email already exists" },
                { status: 409 }
            );
        }

        // 2. Create Supabase Auth User
        // We set email_confirm to true for simplicity, but mark 'status' as Pending in our DB
        const { data: authUser, error: authError } = await supabaseAdmin.auth.admin.createUser({
            email,
            password,
            email_confirm: true,
            user_metadata: {
                name,
                role: "Committee",
            },
        });

        if (authError) {
            console.error("Error creating auth user:", authError);
            return NextResponse.json(
                { error: authError.message },
                { status: 400 }
            );
        }

        // 3. Create AdminUser entry with "Pending" status
        const { error: dbError } = await supabaseAdmin
            .from("AdminUser")
            .insert({
                email,
                name,
                role: "Committee",
                status: "Pending", // Explicitly pending
            });

        if (dbError) {
            console.error("Error creating database entry:", dbError);
            // Rollback: Delete the auth user
            if (authUser.user) {
                await supabaseAdmin.auth.admin.deleteUser(authUser.user.id);
            }
            return NextResponse.json(
                { error: "Failed to create account profile. Please try again." },
                { status: 500 }
            );
        }

        return NextResponse.json(
            { message: "Registration successful. Pending approval." },
            { status: 201 }
        );

    } catch (error: any) {
        console.error("Error in registration:", error);
        return NextResponse.json(
            { error: "Internal server error" },
            { status: 500 }
        );
    }
}
</file>

<file path="src/app/api/admin/users/check-status/route.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { cookies } from "next/headers";
import { NextRequest, NextResponse } from "next/server";

export const dynamic = "force-dynamic";

// Helper to create a Supabase client ensuring async cookies are handled
async function createSupabaseServerClient() {
    const cookieStore = await cookies();

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value;
                },
                set(name: string, value: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value, ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
                remove(name: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value: "", ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
            },
        }
    );
}

export async function GET(req: NextRequest) {
    try {
        const supabase = await createSupabaseServerClient();

        // Check if user is authenticated
        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session || !session.user?.email) {
            return NextResponse.json(
                { approved: false, status: "Unauthorized" },
                { status: 401 }
            );
        }

        // Check AdminUser status
        const { data: adminUser } = await supabase
            .from("AdminUser")
            .select("status")
            .eq("email", session.user.email)
            .single();

        if (!adminUser) {
            return NextResponse.json(
                { approved: false, status: "Not Found" },
                { status: 403 }
            );
        }

        if (adminUser.status !== "Approved") {
            return NextResponse.json(
                { approved: false, status: adminUser.status },
                { status: 403 }
            );
        }

        return NextResponse.json({ approved: true, status: "Approved" });
    } catch (error: any) {
        console.error("Error checking user status:", error);
        return NextResponse.json(
            { approved: false, status: "Error" },
            { status: 500 }
        );
    }
}
</file>

<file path="src/app/api/applications/[id]/assessments/route.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { cookies } from "next/headers";
import { NextRequest, NextResponse } from "next/server";

export const dynamic = "force-dynamic";

async function createSupabaseServerClient() {
    const cookieStore = await cookies();

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value;
                },
                set(name: string, value: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value, ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
                remove(name: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value: "", ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
            },
        }
    );
}

export async function GET(req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
    try {
        const { id } = await params;
        const supabase = await createSupabaseServerClient();
        const { data: { session } } = await supabase.auth.getSession();

        if (!session || !session.user?.email) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        // Get current admin user
        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("id, role")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin) {
            return NextResponse.json({ error: "Forbidden" }, { status: 403 });
        }

        // Fetch assessments for this application
        const { data: assessments, error } = await supabase
            .from("Assessment")
            .select("*, adminUser:AdminUser(name, email)")
            .eq("applicationId", id);

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({ assessments });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="src/app/api/assessments/route.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { cookies } from "next/headers";
import { NextRequest, NextResponse } from "next/server";

export const dynamic = "force-dynamic";

async function createSupabaseServerClient() {
    const cookieStore = await cookies();

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value;
                },
                set(name: string, value: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value, ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
                remove(name: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value: "", ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
            },
        }
    );
}

// GET - List assessments for the current user (if Committee) or all (if SuperAdmin)
export async function GET(req: NextRequest) {
    try {
        const supabase = await createSupabaseServerClient();
        const { data: { session } } = await supabase.auth.getSession();

        if (!session || !session.user?.email) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        // Get current admin user
        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("id, role")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin) {
            return NextResponse.json({ error: "Forbidden" }, { status: 403 });
        }

        let query = supabase.from("Assessment").select("*, application:Application(id, applicant:Applicant(firstName, surname, middleName))");

        // If not SuperAdmin, only show own assessments
        if (currentAdmin.role !== "SuperAdmin") {
            query = query.eq("adminUserId", currentAdmin.id);
        }

        const { data: assessments, error } = await query;

        if (error) {
            console.error("Error fetching assessments:", error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({ assessments });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

// POST - Create or Update Assessment
export async function POST(req: NextRequest) {
    try {
        const supabase = await createSupabaseServerClient();
        const { data: { session } } = await supabase.auth.getSession();

        if (!session || !session.user?.email) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("id, role")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin) {
            return NextResponse.json({ error: "Forbidden" }, { status: 403 });
        }

        const body = await req.json();
        const { applicationId, financialScore, academicScore, churchScore, notes } = body;

        if (!applicationId) {
            return NextResponse.json({ error: "Application ID is required" }, { status: 400 });
        }

        // Calculate total score
        const totalScore = (financialScore || 0) + (academicScore || 0) + (churchScore || 0);

        // Upsert assessment
        const { data, error } = await supabase
            .from("Assessment")
            .upsert({
                applicationId,
                adminUserId: currentAdmin.id,
                financialScore: financialScore || 0,
                academicScore: academicScore || 0,
                churchScore: churchScore || 0,
                totalScore,
                notes,
            }, {
                onConflict: "applicationId,adminUserId"
            })
            .select()
            .single();

        if (error) {
            console.error("Error saving assessment:", error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({ assessment: data });

    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="src/app/apply/form/page.tsx">
"use client";

import { useState } from "react";
import { StepIndicator } from "@/components/apply/StepIndicator";
import { PersonalInfoStep } from "@/components/apply/PersonalInfoStep";
import { AcademicInfoStep } from "@/components/apply/AcademicInfoStep";
import { FamilyInfoStep } from "@/components/apply/FamilyInfoStep";
import { DocumentUploadStep } from "@/components/apply/DocumentUploadStep";
import { Loader2 } from "lucide-react";

const STEPS = ["Personal Info", "Academic Info", "Family Info", "Documents", "Review"];

export default function ApplicationFormPage() {
    const [currentStep, setCurrentStep] = useState(0);
    const [isLoading, setIsLoading] = useState(false);
    const [formData, setFormData] = useState({});

    const handleNext = () => {
        if (currentStep < STEPS.length - 1) {
            setCurrentStep((prev) => prev + 1);
        } else {
            handleSubmit();
        }
    };

    const handleBack = () => {
        if (currentStep > 0) {
            setCurrentStep((prev) => prev - 1);
        }
    };

    const handleSubmit = async () => {
        setIsLoading(true);
        try {
            const response = await fetch("/api/apply", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (result.success) {
                alert("Application Submitted Successfully! ID: " + result.applicantId);
                // Ideally redirect to dashboard or success page
                window.location.href = "/dashboard";
            } else {
                alert("Failed to submit application: " + result.error);
            }
        } catch (error) {
            console.error("Submission error:", error);
            alert("An error occurred during submission.");
        } finally {
            setIsLoading(false);
        }
    };

    const updateFormData = (data: any) => {
        setFormData((prev) => ({ ...prev, ...data }));
    };

    return (
        <div className="container mx-auto px-4 py-12 max-w-3xl">
            <h1 className="text-3xl font-bold text-center mb-8">Scholarship Application</h1>
            <StepIndicator steps={STEPS} currentStep={currentStep} />

            <div className="bg-card border rounded-lg p-6 shadow-sm min-h-[400px]">
                {currentStep === 0 && <PersonalInfoStep updateData={updateFormData} data={formData} />}
                {currentStep === 1 && <AcademicInfoStep updateData={updateFormData} data={formData} />}
                {currentStep === 2 && <FamilyInfoStep updateData={updateFormData} data={formData} />}
                {currentStep === 3 && <DocumentUploadStep updateData={updateFormData} data={formData} />}
                {currentStep === 4 && (
                    <div className="text-center space-y-4">
                        <h2 className="text-xl font-semibold">Review Application</h2>
                        <p className="text-muted-foreground">Please review your details before submitting.</p>
                        <pre className="text-left bg-muted p-4 rounded-md overflow-auto text-xs max-h-[400px]">
                            {JSON.stringify(formData, null, 2)}
                        </pre>
                    </div>
                )}
            </div>

            <div className="flex justify-between mt-8">
                <button
                    onClick={handleBack}
                    disabled={currentStep === 0 || isLoading}
                    className="px-4 py-2 rounded-md border border-input bg-background hover:bg-accent hover:text-accent-foreground disabled:opacity-50"
                >
                    Back
                </button>
                <button
                    onClick={handleNext}
                    disabled={isLoading}
                    className="px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 disabled:opacity-50 flex items-center"
                >
                    {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                    {currentStep === STEPS.length - 1 ? "Submit Application" : "Next Step"}
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/app/apply/page.tsx">
import Link from "next/link";
import { ArrowRight, FileText, Upload, UserCheck } from "lucide-react";

export default function ApplyPage() {
    return (
        <div className="container mx-auto px-4 py-12 max-w-4xl">
            <div className="text-center space-y-6 mb-12">
                <h1 className="text-4xl font-bold tracking-tight text-primary">Scholarship Application</h1>
                <p className="text-xl text-muted-foreground max-w-2xl mx-auto">
                    Begin your journey to educational support. Please review the requirements below before starting your application.
                </p>
            </div>

            <div className="grid gap-8 md:grid-cols-3 mb-12">
                <div className="flex flex-col items-center text-center p-6 bg-card border rounded-lg shadow-sm">
                    <div className="h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center mb-4">
                        <UserCheck className="h-6 w-6 text-primary" />
                    </div>
                    <h3 className="font-semibold mb-2">Check Eligibility</h3>
                    <p className="text-sm text-muted-foreground">Ensure you meet all criteria outlined in the About section.</p>
                </div>
                <div className="flex flex-col items-center text-center p-6 bg-card border rounded-lg shadow-sm">
                    <div className="h-12 w-12 rounded-full bg-secondary/10 flex items-center justify-center mb-4">
                        <FileText className="h-6 w-6 text-secondary" />
                    </div>
                    <h3 className="font-semibold mb-2">Prepare Documents</h3>
                    <p className="text-sm text-muted-foreground">Have your school bill, admission letter, and passport photo ready.</p>
                </div>
                <div className="flex flex-col items-center text-center p-6 bg-card border rounded-lg shadow-sm">
                    <div className="h-12 w-12 rounded-full bg-accent/10 flex items-center justify-center mb-4">
                        <Upload className="h-6 w-6 text-accent-foreground" />
                    </div>
                    <h3 className="font-semibold mb-2">Submit Online</h3>
                    <p className="text-sm text-muted-foreground">Complete the form and upload your documents securely.</p>
                </div>
            </div>

            <div className="bg-muted/30 p-8 rounded-lg text-center space-y-6">
                <h2 className="text-2xl font-bold">Ready to Apply?</h2>
                <p className="text-muted-foreground">
                    The application process takes approximately 10-15 minutes. You can save your progress and return later.
                </p>
                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                    <Link
                        href="/apply/form"
                        className="inline-flex h-12 items-center justify-center rounded-md bg-primary px-8 text-lg font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    >
                        Start New Application <ArrowRight className="ml-2 h-5 w-5" />
                    </Link>
                    <Link
                        href="/login"
                        className="inline-flex h-12 items-center justify-center rounded-md border border-input bg-background px-8 text-lg font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                    >
                        Continue Application
                    </Link>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/apply/AcademicInfoStep.tsx">
interface AcademicInfoStepProps {
    updateData: (data: any) => void;
    data: any;
}

export function AcademicInfoStep({ updateData, data }: AcademicInfoStepProps) {
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        updateData({ [e.target.name]: e.target.value });
    };

    return (
        <div className="space-y-6 animate-fade-in">
            <h2 className="text-xl font-semibold mb-4">Academic Status</h2>

            <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Name of School</label>
                        <input
                            name="schoolName"
                            value={data.schoolName || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Address of School</label>
                        <input
                            name="schoolAddress"
                            value={data.schoolAddress || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Present Class</label>
                        <input
                            name="presentClass"
                            value={data.presentClass || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Position in Class</label>
                        <input
                            name="classPosition"
                            value={data.classPosition || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">No. of Children in Class</label>
                        <input
                            name="classSize"
                            type="number"
                            value={data.classSize || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Present School Fees (Amount)</label>
                        <input
                            name="schoolFees"
                            value={data.schoolFees || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Cost of Text Books (Per Year)</label>
                        <input
                            name="textBooksCost"
                            value={data.textBooksCost || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="space-y-4 border-t pt-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Do you have enough text books?</label>
                        <div className="flex gap-4">
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="enoughBooks"
                                    value="Yes"
                                    checked={data.enoughBooks === "Yes"}
                                    onChange={handleChange}
                                />
                                Yes
                            </label>
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="enoughBooks"
                                    value="No"
                                    checked={data.enoughBooks === "No"}
                                    onChange={handleChange}
                                />
                                No
                            </label>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-sm font-medium">Do you have unhindered access to libraries?</label>
                        <div className="flex gap-4">
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="libraryAccess"
                                    value="Yes"
                                    checked={data.libraryAccess === "Yes"}
                                    onChange={handleChange}
                                />
                                Yes
                            </label>
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="libraryAccess"
                                    value="No"
                                    checked={data.libraryAccess === "No"}
                                    onChange={handleChange}
                                />
                                No
                            </label>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-sm font-medium">Have you ever been sent away from school because of non-payment of fees?</label>
                        <div className="flex gap-4">
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="sentAway"
                                    value="Yes"
                                    checked={data.sentAway === "Yes"}
                                    onChange={handleChange}
                                />
                                Yes
                            </label>
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="sentAway"
                                    value="No"
                                    checked={data.sentAway === "No"}
                                    onChange={handleChange}
                                />
                                No
                            </label>
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-sm font-medium">Have you ever repeated a class?</label>
                        <div className="flex gap-4">
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="repeatedClass"
                                    value="Yes"
                                    checked={data.repeatedClass === "Yes"}
                                    onChange={handleChange}
                                />
                                Yes
                            </label>
                            <label className="flex items-center gap-2">
                                <input
                                    type="radio"
                                    name="repeatedClass"
                                    value="No"
                                    checked={data.repeatedClass === "No"}
                                    onChange={handleChange}
                                />
                                No
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/apply/StepIndicator.tsx">
import { Check } from "lucide-react";
import { cn } from "@/lib/utils";

interface StepIndicatorProps {
    steps: string[];
    currentStep: number;
}

export function StepIndicator({ steps, currentStep }: StepIndicatorProps) {
    return (
        <div className="relative flex justify-between w-full max-w-3xl mx-auto mb-8">
            <div className="absolute top-1/2 left-0 w-full h-0.5 bg-muted -z-10 -translate-y-1/2" />
            <div
                className="absolute top-1/2 left-0 h-0.5 bg-primary -z-10 -translate-y-1/2 transition-all duration-300"
                style={{ width: `${(currentStep / (steps.length - 1)) * 100}%` }}
            />
            {steps.map((step, index) => {
                const isCompleted = index < currentStep;
                const isCurrent = index === currentStep;

                return (
                    <div key={step} className="flex flex-col items-center gap-2 bg-background px-2">
                        <div
                            className={cn(
                                "flex h-8 w-8 items-center justify-center rounded-full border-2 text-sm font-semibold transition-colors",
                                isCompleted
                                    ? "border-primary bg-primary text-primary-foreground"
                                    : isCurrent
                                        ? "border-primary text-primary"
                                        : "border-muted text-muted-foreground"
                            )}
                        >
                            {isCompleted ? <Check className="h-4 w-4" /> : index + 1}
                        </div>
                        <span
                            className={cn(
                                "text-xs font-medium",
                                isCurrent ? "text-primary" : "text-muted-foreground"
                            )}
                        >
                            {step}
                        </span>
                    </div>
                );
            })}
        </div>
    );
}
</file>

<file path="src/components/AssessmentForm.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

interface AssessmentFormProps {
    applicationId: string;
    existingAssessment?: any;
    onSuccess?: () => void;
}

export default function AssessmentForm({ applicationId, existingAssessment, onSuccess }: AssessmentFormProps) {
    const router = useRouter();
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const [scores, setScores] = useState({
        financialScore: existingAssessment?.financialScore || 0,
        academicScore: existingAssessment?.academicScore || 0,
        churchScore: existingAssessment?.churchScore || 0,
        notes: existingAssessment?.notes || "",
    });

    const totalScore = (Number(scores.financialScore) || 0) + (Number(scores.academicScore) || 0) + (Number(scores.churchScore) || 0);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target;
        setScores((prev) => ({
            ...prev,
            [name]: name === "notes" ? value : Number(value),
        }));
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            const res = await fetch("/api/assessments", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    applicationId,
                    ...scores,
                }),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.error || "Failed to submit assessment");
            }

            router.refresh();
            if (onSuccess) onSuccess();
        } catch (err: any) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-sm border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
            <h3 className="text-lg font-semibold mb-4 dark:text-gray-100">Committee Assessment</h3>

            {error && (
                <div className="mb-4 p-3 bg-red-50 text-red-600 rounded-md text-sm dark:bg-red-900/30 dark:text-red-400">
                    {error}
                </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">
                        Financial Need (0-100)
                    </label>
                    <input
                        type="number"
                        name="financialScore"
                        min="0"
                        max="100"
                        value={scores.financialScore}
                        onChange={handleChange}
                        className="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">
                        Academic Perf. (0-100)
                    </label>
                    <input
                        type="number"
                        name="academicScore"
                        min="0"
                        max="100"
                        value={scores.academicScore}
                        onChange={handleChange}
                        className="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">
                        Church Part. (0-100)
                    </label>
                    <input
                        type="number"
                        name="churchScore"
                        min="0"
                        max="100"
                        value={scores.churchScore}
                        onChange={handleChange}
                        className="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    />
                </div>
            </div>

            <div className="mb-4">
                <div className="flex justify-between items-center bg-gray-50 p-3 rounded-md dark:bg-gray-700/50">
                    <span className="font-medium text-gray-700 dark:text-gray-300">Total Score:</span>
                    <span className="text-xl font-bold text-blue-600 dark:text-blue-400">{totalScore}</span>
                </div>
            </div>

            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">
                    Committee Notes / Comments
                </label>
                <textarea
                    name="notes"
                    rows={3}
                    value={scores.notes}
                    onChange={handleChange}
                    className="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    placeholder="Enter your observations..."
                />
            </div>

            <div className="flex justify-end">
                <button
                    type="submit"
                    disabled={loading}
                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors"
                >
                    {loading ? "Saving..." : "Save Assessment"}
                </button>
            </div>
        </form>
    );
}
</file>

<file path="src/components/AssessmentList.tsx">
"use client";

import { useEffect, useState } from "react";

export default function AssessmentList({ applicationId }: { applicationId: string }) {
    const [assessments, setAssessments] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchAssessments = async () => {
            try {
                const res = await fetch(`/api/applications/${applicationId}/assessments`);
                if (res.ok) {
                    const data = await res.json();
                    setAssessments(data.assessments || []);
                }
            } catch (err) {
                console.error("Failed to load assessments", err);
            } finally {
                setLoading(false);
            }
        };

        fetchAssessments();
    }, [applicationId]);

    if (loading) return <div className="text-sm text-gray-500">Loading reviews...</div>;
    if (assessments.length === 0) return <div className="text-sm text-gray-500 italic">No reviews yet.</div>;

    return (
        <div className="space-y-4">
            {assessments.map((assessment) => (
                <div key={assessment.id} className="border-b pb-3 last:border-0 last:pb-0">
                    <div className="flex justify-between items-start mb-1">
                        <span className="font-semibold text-sm dark:text-gray-200">
                            {assessment.adminUser?.name || assessment.adminUser?.email || "Committee Member"}
                        </span>
                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-200">
                            Score: {assessment.totalScore}
                        </span>
                    </div>
                    {assessment.notes && (
                        <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">&quot;{assessment.notes}&quot;</p>
                    )}
                    <div className="grid grid-cols-3 gap-2 mt-2 text-xs text-gray-500 dark:text-gray-500">
                        <div>Fin: {assessment.financialScore}</div>
                        <div>Aca: {assessment.academicScore}</div>
                        <div>Chu: {assessment.churchScore}</div>
                    </div>
                </div>
            ))}
        </div>
    );
}
</file>

<file path="src/components/layout/Footer.tsx">
export function Footer() {
    return (
        <footer className="border-t bg-muted/40 py-6 mt-auto">
            <div className="container mx-auto px-4 text-center text-sm text-muted-foreground">
                <p>&copy; {new Date().getFullYear()} CCC Central Cathedral Abuja. All rights reserved.</p>
                <p className="mt-2 text-xs">Education Trust Fund</p>
            </div>
        </footer>
    );
}
</file>

<file path="src/lib/prisma.ts">
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
    prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="src/types/index.ts">
import { Database } from './supabase';

export type Tables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Row'];
export type Enums<T extends keyof Database['public']['Enums']> = Database['public']['Enums'][T];

// Basic Table Types
export type AdminUser = Tables<'AdminUser'>;
export type Applicant = Tables<'Applicant'>;
export type Application = Tables<'Application'>;
export type Budget = Tables<'Budget'>;
export type Donation = Tables<'Donation'>;
export type FamilyInfo = Tables<'FamilyInfo'>;
export type Transaction = Tables<'Transaction'>;

// Extended Types (Joined Data)
export interface ApplicationWithApplicant extends Application {
    applicant: Applicant;
}

export interface TransactionWithBudget extends Transaction {
    budget?: Budget | null;
}

export interface DonationWithTransaction extends Donation {
    transaction: Transaction;
}

export interface ApplicantWithFamily extends Applicant {
    familyInfo?: FamilyInfo | null;
}

export interface ApplicationDetail extends Application {
    applicant: ApplicantWithFamily;
}

// Dashboard Data Types
export interface DonationResponse {
    summary: {
        totalDonations: number;
        totalDonors: number;
        averageDonation: number;
        receiptsIssued: number;
    };
    donations: DonationWithTransaction[];
    typeBreakdown: Record<string, number>;
    purposeBreakdown: Record<string, number>;
    monthlyData: { month: string; amount: number; count: number }[];
    topDonors: { name: string; count: number; amount: number }[];
}

export interface ReportResponse {
    summary: {
        totalApplications: number;
        totalDisbursed: number;
        averageAmount: number;
        approvalRate: number;
    };
    statusBreakdown: Record<string, number>;
    genderBreakdown: Record<string, number>;
    levelBreakdown: Record<string, number>;
    monthlyData: { month: string; applications: number }[];
    topSchools: { name: string; count: number; amount: number }[];
}

export interface FinanceResponse {
    summary: {
        totalBudget: number;
        totalIncome: number;
        totalExpenses: number;
        balance: number;
    };
    budgets: Budget[];
    transactions: Transaction[];
}

// API Response Wrappers
export interface ApiResponse<T> {
    success?: boolean;
    data?: T;
    error?: string;
    meta?: {
        total: number;
        page: number;
        limit: number;
        totalPages: number;
    };
}
</file>

<file path="tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
    darkMode: "class",
    content: [
        "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
        "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
        "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
    ],
    theme: {
        extend: {
            colors: {
                background: "hsl(var(--background))",
                foreground: "hsl(var(--foreground))",
                card: {
                    DEFAULT: "hsl(var(--card))",
                    foreground: "hsl(var(--card-foreground))",
                },
                popover: {
                    DEFAULT: "hsl(var(--popover))",
                    foreground: "hsl(var(--popover-foreground))",
                },
                primary: {
                    DEFAULT: "hsl(var(--primary))",
                    foreground: "hsl(var(--primary-foreground))",
                },
                secondary: {
                    DEFAULT: "hsl(var(--secondary))",
                    foreground: "hsl(var(--secondary-foreground))",
                },
                muted: {
                    DEFAULT: "hsl(var(--muted))",
                    foreground: "hsl(var(--muted-foreground))",
                },
                accent: {
                    DEFAULT: "hsl(var(--accent))",
                    foreground: "hsl(var(--accent-foreground))",
                },
                destructive: {
                    DEFAULT: "hsl(var(--destructive))",
                    foreground: "hsl(var(--destructive-foreground))",
                },
                border: "hsl(var(--border))",
                input: "hsl(var(--input))",
                ring: "hsl(var(--ring))",
                chart: {
                    "1": "hsl(var(--chart-1))",
                    "2": "hsl(var(--chart-2))",
                    "3": "hsl(var(--chart-3))",
                    "4": "hsl(var(--chart-4))",
                    "5": "hsl(var(--chart-5))",
                },
            },
            borderRadius: {
                lg: "var(--radius)",
                md: "calc(var(--radius) - 2px)",
                sm: "calc(var(--radius) - 4px)",
            },
            fontFamily: {
                sans: ["var(--font-outfit)", "sans-serif"],
            },
        },
    },
    plugins: [],
};
export default config;
</file>

<file path="vercel.json">
{
    "buildCommand": "npm run build",
    "devCommand": "npm run dev",
    "installCommand": "npm install",
    "framework": "nextjs",
    "outputDirectory": ".next"
}
</file>

<file path="src/app/admin/(dashboard)/applications/[id]/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { ArrowLeft, CheckCircle, XCircle, FileText, User, GraduationCap, Church } from "lucide-react";
import AssessmentForm from "@/components/AssessmentForm";
import AssessmentList from "@/components/AssessmentList";
import Link from "next/link";
import { useParams, useRouter } from "next/navigation";
import { ApplicationDetail, ApiResponse } from "@/types";

export default function ApplicationDetailPage() {
    const params = useParams();
    const router = useRouter();
    const [application, setApplication] = useState<ApplicationDetail | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [isSaving, setIsSaving] = useState(false);

    // Screening State replaced by AssessmentForm

    useEffect(() => {
        const fetchApplication = async () => {
            try {
                const response = await fetch(`/api/admin/applications/${params.id}`);
                const result: ApiResponse<ApplicationDetail> = await response.json();
                if (result.success && result.data) {
                    setApplication(result.data);
                }
            } catch (error) {
                console.error("Error fetching application:", error);
            } finally {
                setIsLoading(false);
            }
        };

        if (params.id) {
            fetchApplication();
        }
    }, [params.id]);

    const handleStatusUpdate = async (newStatus: string) => {
        if (!application) return;
        if (!confirm(`Are you sure you want to ${newStatus} this application?`)) return;

        setIsSaving(true);
        try {
            const response = await fetch(`/api/admin/applications/${params.id}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
            });

            if (response.ok) {
                setApplication({ ...application, status: newStatus });
                alert(`Application ${newStatus} successfully!`);
                router.refresh();
            } else {
                alert("Failed to update status.");
            }
        } catch (error) {
            console.error("Error updating status:", error);
            alert("An error occurred.");
        } finally {
            setIsSaving(false);
        }
    };

    if (isLoading) {
        return <div className="p-8 text-center">Loading application details...</div>;
    }

    if (!application) {
        return <div className="p-8 text-center">Application not found.</div>;
    }

    const { applicant } = application;
    const { familyInfo } = applicant;

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="flex items-center gap-4 mb-6">
                <Link href="/admin/applications" className="p-2 hover:bg-accent rounded-full transition-colors">
                    <ArrowLeft className="h-5 w-5" />
                </Link>
                <div>
                    <h1 className="text-2xl font-bold text-primary">
                        {applicant.surname} {applicant.firstName}
                    </h1>
                    <p className="text-muted-foreground">
                        {application.schoolName} • {application.presentClass}
                    </p>
                </div>
                <div className="ml-auto flex gap-2">
                    <span className={`px-3 py-1 rounded-full text-sm font-medium border ${application.status === 'Approved' ? 'bg-green-100 text-green-800 border-green-200' :
                        application.status === 'Rejected' ? 'bg-red-100 text-red-800 border-red-200' :
                            'bg-yellow-100 text-yellow-800 border-yellow-200'
                        }`}>
                        {application.status}
                    </span>
                    <button
                        onClick={() => handleStatusUpdate("Approved")}
                        disabled={isSaving || application.status === "Approved"}
                        className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50"
                    >
                        <CheckCircle className="h-4 w-4" /> Approve
                    </button>
                    <button
                        onClick={() => handleStatusUpdate("Rejected")}
                        disabled={isSaving || application.status === "Rejected"}
                        className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50"
                    >
                        <XCircle className="h-4 w-4" /> Reject
                    </button>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-6">
                    {/* Personal Info */}
                    <div className="bg-card border rounded-lg p-6 shadow-sm">
                        <div className="flex items-center gap-2 mb-4 border-b pb-2">
                            <User className="h-5 w-5 text-primary" />
                            <h2 className="text-lg font-semibold">Personal Information</h2>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <p className="text-muted-foreground">Full Name</p>
                                <p className="font-medium">{applicant.surname} {applicant.firstName} {applicant.middleName}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">Date of Birth</p>
                                <p className="font-medium">{new Date(applicant.dob).toLocaleDateString()}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">Gender</p>
                                <p className="font-medium">{applicant.sex}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">State of Origin</p>
                                <p className="font-medium">{applicant.stateOrigin}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">LGA</p>
                                <p className="font-medium">{applicant.lga}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">Town</p>
                                <p className="font-medium">{applicant.town}</p>
                            </div>
                        </div>
                    </div>

                    {/* Academic Info */}
                    <div className="bg-card border rounded-lg p-6 shadow-sm">
                        <div className="flex items-center gap-2 mb-4 border-b pb-2">
                            <GraduationCap className="h-5 w-5 text-primary" />
                            <h2 className="text-lg font-semibold">Academic Information</h2>
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p className="text-muted-foreground">School Name</p>
                                <p className="font-medium">{application.schoolName}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">School Address</p>
                                <p className="font-medium">{application.schoolAddress}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">Present Class</p>
                                <p className="font-medium">{application.presentClass}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">School Fees</p>
                                <p className="font-medium">{application.schoolFees}</p>
                            </div>
                            <div>
                                <p className="text-muted-foreground">Last Result</p>
                                <p className="font-medium">{application.lastResult || "N/A"}</p>
                            </div>
                        </div>
                    </div>

                    {/* Family Info */}
                    {familyInfo && (
                        <div className="bg-card border rounded-lg p-6 shadow-sm">
                            <div className="flex items-center gap-2 mb-4 border-b pb-2">
                                <Church className="h-5 w-5 text-primary" />
                                <h2 className="text-lg font-semibold">Family & Church Info</h2>
                            </div>
                            <div className="space-y-4 text-sm">
                                <div>
                                    <h3 className="font-medium text-primary mb-2">Father</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        <p><span className="text-muted-foreground">Name:</span> {familyInfo.fatherSurname} {familyInfo.fatherFirstName}</p>
                                        <p><span className="text-muted-foreground">Phone:</span> {familyInfo.fatherPhone}</p>
                                        <p><span className="text-muted-foreground">Occupation:</span> {familyInfo.fatherOccupation}</p>
                                        <p><span className="text-muted-foreground">Church Position:</span> {familyInfo.fatherChurchPosition}</p>
                                    </div>
                                </div>
                                <div className="border-t pt-2">
                                    <h3 className="font-medium text-primary mb-2">Mother</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        <p><span className="text-muted-foreground">Name:</span> {familyInfo.motherSurname} {familyInfo.motherFirstName}</p>
                                        <p><span className="text-muted-foreground">Phone:</span> {familyInfo.motherPhone}</p>
                                        <p><span className="text-muted-foreground">Occupation:</span> {familyInfo.motherOccupation}</p>
                                        <p><span className="text-muted-foreground">Church Position:</span> {familyInfo.motherChurchPosition}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>

                <div className="space-y-6">
                    {/* Documents */}
                    <div className="bg-card border rounded-lg p-6 shadow-sm">
                        <div className="flex items-center gap-2 mb-4 border-b pb-2">
                            <FileText className="h-5 w-5 text-primary" />
                            <h2 className="text-lg font-semibold">Documents</h2>
                        </div>
                        <div className="space-y-3">
                            {[
                                { label: "School Bill", value: application.schoolBillUrl },
                                { label: "Admission Letter", value: application.admissionLetterUrl },
                                { label: "Passport", value: application.passportUrl },
                                { label: "Birth Certificate", value: application.birthCertUrl },
                                { label: "School Results", value: application.schoolResultUrl },
                            ].map((doc, i) => (
                                <div key={i} className="flex items-center justify-between p-3 bg-muted/30 rounded-md">
                                    <span className="text-sm font-medium">{doc.label}</span>
                                    {doc.value ? (
                                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Uploaded</span>
                                    ) : (
                                        <span className="text-xs text-muted-foreground">Pending</span>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Committee Assessments */}
                    <div className="space-y-6">
                        <div className="bg-card border rounded-lg p-6 shadow-sm">
                            <h2 className="text-lg font-semibold mb-4">My Assessment</h2>
                            <AssessmentForm applicationId={params.id as string} onSuccess={() => router.refresh()} />
                        </div>

                        {/* List of other assessments (could be restricted to admins in future) */}
                        <div className="bg-card border rounded-lg p-6 shadow-sm">
                            <h2 className="text-lg font-semibold mb-4">Committee Reviews</h2>
                            <AssessmentList applicationId={params.id as string} />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/(dashboard)/applications/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Search, Filter, Eye, Loader2 } from "lucide-react";
import Link from "next/link";

import { ApplicationWithApplicant, ApiResponse } from "@/types";

export default function ApplicationsPage() {
    const [applications, setApplications] = useState<ApplicationWithApplicant[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState("");
    const [statusFilter, setStatusFilter] = useState("All");
    const [page, setPage] = useState(1);
    const [totalPages, setTotalPages] = useState(1);

    const fetchApplications = async () => {
        setIsLoading(true);
        try {
            const params = new URLSearchParams({
                page: page.toString(),
                limit: "10",
                status: statusFilter,
                search: searchTerm,
            });
            const response = await fetch(`/api/admin/applications?${params}`);
            const result: ApiResponse<ApplicationWithApplicant[]> = await response.json();
            if (result.success && result.data) {
                setApplications(result.data);
                setTotalPages(result.meta?.totalPages || 1);
            }
        } catch (error) {
            console.error("Error fetching applications:", error);
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        // Debounce search to avoid too many requests
        const timeoutId = setTimeout(() => {
            fetchApplications();
        }, 300);
        return () => clearTimeout(timeoutId);
    }, [page, statusFilter, searchTerm]);

    const handleExportCSV = () => {
        if (applications.length === 0) return;

        const headers = ["Applicant Name", "School", "Level", "Date", "Status"];
        const csvContent = [
            headers.join(","),
            ...applications.map(app => [
                `"${app.applicant.surname} ${app.applicant.firstName}"`,
                `"${app.schoolName}"`,
                `"${app.presentClass}"`,
                `"${new Date(app.createdAt).toLocaleDateString()}"`,
                `"${app.status}"`
            ].join(","))
        ].join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "applications_export.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold text-primary">Applications</h1>
                <div className="flex gap-2">
                    <button
                        onClick={handleExportCSV}
                        disabled={applications.length === 0}
                        className="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 text-sm disabled:opacity-50"
                    >
                        Export CSV
                    </button>
                </div>
            </div>

            <div className="flex flex-col md:flex-row gap-4 items-center bg-card p-4 rounded-lg border shadow-sm">
                <div className="relative flex-1 w-full">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                    <input
                        placeholder="Search applicants..."
                        className="pl-10 h-10 w-full rounded-md border border-input bg-background text-sm"
                        value={searchTerm}
                        onChange={(e) => {
                            setSearchTerm(e.target.value);
                            setPage(1); // Reset to page 1 on search
                        }}
                    />
                </div>
                <div className="flex items-center gap-2 w-full md:w-auto">
                    <Filter className="h-4 w-4 text-muted-foreground" />
                    <select
                        className="h-10 rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
                        value={statusFilter}
                        onChange={(e) => {
                            setStatusFilter(e.target.value);
                            setPage(1); // Reset to page 1 on filter change
                        }}
                    >
                        <option value="All">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Disbursed">Disbursed</option>
                    </select>
                </div>
            </div>

            <div className="bg-card border rounded-lg shadow-sm overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-muted/50 text-muted-foreground font-medium">
                            <tr>
                                <th className="px-6 py-3">Applicant</th>
                                <th className="px-6 py-3">School</th>
                                <th className="px-6 py-3">Level</th>
                                <th className="px-6 py-3">Date</th>
                                <th className="px-6 py-3">Status</th>
                                <th className="px-6 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {isLoading ? (
                                <tr>
                                    <td colSpan={6} className="px-6 py-8 text-center text-muted-foreground">
                                        <div className="flex justify-center items-center gap-2">
                                            <Loader2 className="h-4 w-4 animate-spin" />
                                            Loading applications...
                                        </div>
                                    </td>
                                </tr>
                            ) : applications.length === 0 ? (
                                <tr>
                                    <td colSpan={6} className="px-6 py-8 text-center text-muted-foreground">
                                        No applications found.
                                    </td>
                                </tr>
                            ) : (
                                applications.map((app) => (
                                    <tr key={app.id} className="hover:bg-muted/50 transition-colors">
                                        <td className="px-6 py-4 font-medium">
                                            {app.applicant.surname} {app.applicant.firstName}
                                        </td>
                                        <td className="px-6 py-4">{app.schoolName}</td>
                                        <td className="px-6 py-4">{app.presentClass}</td>
                                        <td className="px-6 py-4">{new Date(app.createdAt).toLocaleDateString()}</td>
                                        <td className="px-6 py-4">
                                            <span
                                                className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${app.status === "Approved"
                                                    ? "bg-green-100 text-green-800"
                                                    : app.status === "Rejected"
                                                        ? "bg-red-100 text-red-800"
                                                        : "bg-yellow-100 text-yellow-800"
                                                    }`}
                                            >
                                                {app.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            <Link
                                                href={`/admin/applications/${app.id}`}
                                                className="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-accent text-muted-foreground hover:text-primary transition-colors"
                                            >
                                                <Eye className="h-4 w-4" />
                                            </Link>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>

                {/* Pagination Controls */}
                <div className="flex items-center justify-between px-4 py-4 border-t">
                    <div className="text-sm text-muted-foreground">
                        Page {page} of {totalPages}
                    </div>
                    <div className="flex gap-2">
                        <button
                            onClick={() => setPage((p) => Math.max(1, p - 1))}
                            disabled={page === 1 || isLoading}
                            className="px-3 py-1 border rounded-md text-sm hover:bg-accent disabled:opacity-50"
                        >
                            Previous
                        </button>
                        <button
                            onClick={() => setPage((p) => Math.min(totalPages, p + 1))}
                            disabled={page === totalPages || isLoading}
                            className="px-3 py-1 border rounded-md text-sm hover:bg-accent disabled:opacity-50"
                        >
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/(dashboard)/disbursements/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Plus, X } from "lucide-react";

import { ApplicationWithApplicant, ApiResponse } from "@/types";

export default function DisbursementsPage() {
    const [disbursements, setDisbursements] = useState<ApplicationWithApplicant[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [selectedApp, setSelectedApp] = useState<ApplicationWithApplicant | null>(null);
    const [voucherCode, setVoucherCode] = useState("");
    const [paymentReference, setPaymentReference] = useState("");

    useEffect(() => {
        fetchDisbursements();
    }, []);

    const fetchDisbursements = async () => {
        try {
            const response = await fetch("/api/admin/disbursements");
            const result = await response.json();
            if (result.success) {
                setDisbursements(result.data);
            }
        } catch (error) {
            console.error("Error fetching disbursements:", error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleRecordDisbursement = async () => {
        if (!selectedApp || !voucherCode) return;

        try {
            const response = await fetch("/api/admin/disbursements", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    applicationId: selectedApp.id,
                    voucherCode,
                    paymentReference,
                }),
            });

            const result = await response.json();
            if (result.success) {
                setShowModal(false);
                setVoucherCode("");
                setPaymentReference("");
                setSelectedApp(null);
                fetchDisbursements();
            }
        } catch (error) {
            console.error("Error recording disbursement:", error);
        }
    };

    const handleExportCSV = () => {
        if (disbursements.length === 0) return;

        const headers = ["Voucher Code", "Beneficiary", "School", "Amount", "Date", "Status", "Payment Reference"];
        const csvContent = [
            headers.join(","),
            ...disbursements.map(app => [
                `"${app.voucherCode || 'N/A'}"`,
                `"${app.applicant.surname} ${app.applicant.firstName}"`,
                `"${app.schoolName}"`,
                `"${app.approvedAmount || '0'}"`,
                `"${app.disbursedDate ? new Date(app.disbursedDate).toLocaleDateString() : 'Pending'}"`,
                `"${app.status}"`,
                `"${app.paymentReference || 'N/A'}"`
            ].join(","))
        ].join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "disbursements_export.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    const totalDisbursed = disbursements
        .filter(d => d.status === "Disbursed")
        .reduce((sum, d) => sum + parseFloat(d.approvedAmount || "0"), 0);

    const pendingAmount = disbursements
        .filter(d => d.status === "Approved")
        .reduce((sum, d) => sum + parseFloat(d.approvedAmount || "0"), 0);

    if (isLoading) {
        return <div className="flex items-center justify-center h-64">Loading...</div>;
    }

    return (
        <div className="space-y-8">
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">Disbursements</h2>
                    <p className="text-muted-foreground">Manage payments and generate vouchers.</p>
                </div>
                <div className="flex gap-2">
                    <button
                        onClick={handleExportCSV}
                        disabled={disbursements.length === 0}
                        className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium hover:bg-accent hover:text-accent-foreground disabled:opacity-50"
                    >
                        Export Report
                    </button>
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-3">
                <div className="p-6 bg-card rounded-xl border shadow-sm">
                    <h3 className="text-sm font-medium text-muted-foreground mb-2">Total Disbursed (YTD)</h3>
                    <div className="text-2xl font-bold">₦{totalDisbursed.toLocaleString()}</div>
                </div>
                <div className="p-6 bg-card rounded-xl border shadow-sm">
                    <h3 className="text-sm font-medium text-muted-foreground mb-2">Pending Payments</h3>
                    <div className="text-2xl font-bold text-yellow-600">₦{pendingAmount.toLocaleString()}</div>
                </div>
                <div className="p-6 bg-card rounded-xl border shadow-sm">
                    <h3 className="text-sm font-medium text-muted-foreground mb-2">Total Applications</h3>
                    <div className="text-2xl font-bold">{disbursements.length}</div>
                </div>
            </div>

            <div className="rounded-md border bg-card shadow-sm">
                <div className="relative w-full overflow-auto">
                    <table className="w-full caption-bottom text-sm">
                        <thead className="[&_tr]:border-b">
                            <tr className="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                                <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Voucher ID</th>
                                <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Beneficiary</th>
                                <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">School</th>
                                <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Amount</th>
                                <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Date</th>
                                <th className="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Status</th>
                                <th className="h-12 px-4 text-right align-middle font-medium text-muted-foreground">Actions</th>
                            </tr>
                        </thead>
                        <tbody className="[&_tr:last-child]:border-0">
                            {disbursements.map((item) => (
                                <tr key={item.id} className="border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted">
                                    <td className="p-4 align-middle font-medium">{item.voucherCode || "—"}</td>
                                    <td className="p-4 align-middle">{item.applicant.surname} {item.applicant.firstName}</td>
                                    <td className="p-4 align-middle">{item.schoolName}</td>
                                    <td className="p-4 align-middle">₦{parseFloat(item.approvedAmount || "0").toLocaleString()}</td>
                                    <td className="p-4 align-middle">
                                        {item.disbursedDate ? new Date(item.disbursedDate).toLocaleDateString() : "—"}
                                    </td>
                                    <td className="p-4 align-middle">
                                        <span
                                            className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent ${item.status === "Disbursed"
                                                ? "bg-green-100 text-green-800"
                                                : "bg-yellow-100 text-yellow-800"
                                                }`}
                                        >
                                            {item.status}
                                        </span>
                                    </td>
                                    <td className="p-4 align-middle text-right">
                                        {item.status === "Approved" && (
                                            <button
                                                onClick={() => {
                                                    setSelectedApp(item);
                                                    setShowModal(true);
                                                }}
                                                className="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-8 px-3"
                                            >
                                                <Plus className="h-4 w-4 mr-1" />
                                                Record
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {showModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-card rounded-lg p-6 w-full max-w-md shadow-xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold">Record Disbursement</h3>
                            <button onClick={() => setShowModal(false)} className="text-muted-foreground hover:text-foreground">
                                <X className="h-5 w-5" />
                            </button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-sm font-medium">Beneficiary</label>
                                <p className="text-sm text-muted-foreground">
                                    {selectedApp?.applicant.surname} {selectedApp?.applicant.firstName}
                                </p>
                            </div>
                            <div>
                                <label className="text-sm font-medium">Amount</label>
                                <p className="text-sm text-muted-foreground">₦{parseFloat(selectedApp?.approvedAmount || "0").toLocaleString()}</p>
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-medium">Voucher Code *</label>
                                <input
                                    type="text"
                                    value={voucherCode}
                                    onChange={(e) => setVoucherCode(e.target.value)}
                                    className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    placeholder="e.g., V-2025-001"
                                />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-medium">Payment Reference (Optional)</label>
                                <input
                                    type="text"
                                    value={paymentReference}
                                    onChange={(e) => setPaymentReference(e.target.value)}
                                    className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    placeholder="e.g., TXN123456"
                                />
                            </div>
                            <div className="flex gap-2 justify-end">
                                <button
                                    onClick={() => setShowModal(false)}
                                    className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium hover:bg-accent"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleRecordDisbursement}
                                    disabled={!voucherCode}
                                    className="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 disabled:opacity-50"
                                >
                                    Record Disbursement
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/admin/(dashboard)/donations/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Heart, TrendingUp, Users, FileText, Plus, X, Download, CheckCircle } from "lucide-react";

import { DonationResponse, ApiResponse } from "@/types";

export default function DonationsPage() {
    const [donationsData, setDonationsData] = useState<DonationResponse | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
    const [showModal, setShowModal] = useState(false);
    const [formData, setFormData] = useState<{
        donorName?: string;
        donorEmail?: string;
        donorPhone?: string;
        amount?: string;
        donorAddress?: string;
        donationType: string;
        isAnonymous: boolean;
        purpose: string;
        notes?: string;
    }>({
        donationType: 'One-time',
        isAnonymous: false,
        purpose: 'General'
    });

    useEffect(() => {
        fetchDonations();
    }, [selectedYear]);

    const fetchDonations = async () => {
        setIsLoading(true);
        try {
            const response = await fetch(`/api/admin/donations?year=${selectedYear}`);
            const result: ApiResponse<DonationResponse> = await response.json();
            if (result.success && result.data) {
                setDonationsData(result.data);
            }
        } catch (error) {
            console.error("Error fetching donations:", error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            const response = await fetch('/api/admin/donations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const result = await response.json();
            if (result.success) {
                setShowModal(false);
                setFormData({ donationType: 'One-time', isAnonymous: false, purpose: 'General' });
                fetchDonations();
            }
        } catch (error) {
            console.error("Error submitting donation:", error);
        }
    };

    const handleIssueReceipt = async (donationId: string) => {
        try {
            const receiptNumber = `RCP-${new Date().getFullYear()}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
            const response = await fetch('/api/admin/donations', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: donationId,
                    receiptIssued: true,
                    receiptNumber
                })
            });
            if (response.ok) {
                fetchDonations();
            }
        } catch (error) {
            console.error("Error issuing receipt:", error);
        }
    };

    const handleExportCSV = () => {
        if (!donationsData || donationsData.donations.length === 0) return;

        const headers = ["Date", "Donor Name", "Email", "Phone", "Type", "Purpose", "Amount", "Receipt #"];
        const csvContent = [
            headers.join(","),
            ...donationsData.donations.map((d) => [
                `"${new Date(d.transaction.date).toLocaleDateString()}"`,
                `"${d.isAnonymous ? 'Anonymous' : d.donorName}"`,
                `"${d.donorEmail || 'N/A'}"`,
                `"${d.donorPhone || 'N/A'}"`,
                `"${d.donationType}"`,
                `"${d.purpose || 'General'}"`,
                `"${Number(d.transaction.amount).toLocaleString()}"`,
                `"${d.receiptNumber || 'Not Issued'}"`
            ].join(","))
        ].join("\n");

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `donations_${selectedYear}.csv`);
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    if (isLoading) {
        return <div className="flex items-center justify-center h-64">Loading donations...</div>;
    }

    if (!donationsData) {
        return <div className="flex items-center justify-center h-64">No data available</div>;
    }

    const { summary, donations, typeBreakdown, purposeBreakdown, monthlyData, topDonors } = donationsData;

    return (
        <div className="space-y-8 animate-fade-in">
            {/* Header */}
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">Donations Management</h2>
                    <p className="text-muted-foreground">Track and manage donor contributions</p>
                </div>
                <div className="flex gap-3">
                    <select
                        value={selectedYear}
                        onChange={(e) => setSelectedYear(e.target.value)}
                        className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium"
                    >
                        {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i).map(year => (
                            <option key={year} value={year}>{year}</option>
                        ))}
                    </select>
                    <button
                        onClick={handleExportCSV}
                        disabled={donations.length === 0}
                        className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium hover:bg-accent disabled:opacity-50 flex items-center gap-2"
                    >
                        <Download className="h-4 w-4" />
                        Export CSV
                    </button>
                    <button
                        onClick={() => setShowModal(true)}
                        className="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 flex items-center gap-2"
                    >
                        <Plus className="h-4 w-4" />
                        Record Donation
                    </button>
                </div>
            </div>

            {/* Summary Cards */}
            <div className="grid gap-6 md:grid-cols-4">
                <div className="relative p-6 bg-gradient-to-br from-pink-500 to-rose-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <Heart className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{summary.totalDonations.toLocaleString()}</div>
                        <div className="text-sm opacity-90">Total Donations</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <Users className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">{summary.totalDonors}</div>
                        <div className="text-sm opacity-90">Unique Donors</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <TrendingUp className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{Math.round(summary.averageDonation).toLocaleString()}</div>
                        <div className="text-sm opacity-90">Average Donation</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <FileText className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">{summary.receiptsIssued}</div>
                        <div className="text-sm opacity-90">Receipts Issued</div>
                    </div>
                </div>
            </div>

            {/* Charts Section */}
            <div className="grid gap-6 md:grid-cols-2">
                {/* Donation Type Breakdown */}
                <div className="bg-card border rounded-2xl p-6 shadow-sm">
                    <h3 className="text-lg font-semibold mb-6">Donation Types</h3>
                    <div className="space-y-4">
                        {Object.entries(typeBreakdown).map(([type, amount]) => {
                            const percentage = (amount / summary.totalDonations) * 100;
                            const colors: Record<string, string> = {
                                'One-time': 'bg-blue-500',
                                'Monthly': 'bg-green-500',
                                'Annual': 'bg-purple-500'
                            };
                            return (
                                <div key={type}>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="font-medium">{type}</span>
                                        <span className="text-muted-foreground">₦{amount.toLocaleString()} ({percentage.toFixed(1)}%)</span>
                                    </div>
                                    <div className="h-2 bg-muted rounded-full overflow-hidden">
                                        <div
                                            className={`h-full ${colors[type] || 'bg-gray-500'} transition-all duration-500`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Purpose Breakdown */}
                <div className="bg-card border rounded-2xl p-6 shadow-sm">
                    <h3 className="text-lg font-semibold mb-6">Donation Purpose</h3>
                    <div className="space-y-4">
                        {Object.entries(purposeBreakdown).map(([purpose, amount]) => {
                            const percentage = (amount / summary.totalDonations) * 100;
                            const colors: Record<string, string> = {
                                'General': 'bg-blue-500',
                                'Scholarship': 'bg-yellow-500',
                                'Infrastructure': 'bg-purple-500',
                                'Operations': 'bg-green-500'
                            };
                            return (
                                <div key={purpose}>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="font-medium">{purpose}</span>
                                        <span className="text-muted-foreground">₦{amount.toLocaleString()} ({percentage.toFixed(1)}%)</span>
                                    </div>
                                    <div className="h-2 bg-muted rounded-full overflow-hidden">
                                        <div
                                            className={`h-full ${colors[purpose] || 'bg-gray-500'} transition-all duration-500`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>

            {/* Monthly Trend */}
            <div className="bg-card border rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold mb-6">Monthly Donation Trend</h3>
                <div className="space-y-3">
                    {monthlyData.map((data) => {
                        const maxAmount = Math.max(...monthlyData.map((d) => d.amount));
                        const percentage = maxAmount > 0 ? (data.amount / maxAmount) * 100 : 0;
                        return (
                            <div key={data.month} className="flex items-center gap-3">
                                <div className="w-12 text-sm font-medium text-muted-foreground">{data.month}</div>
                                <div className="flex-1 h-10 bg-muted rounded-lg overflow-hidden">
                                    <div
                                        className="h-full bg-gradient-to-r from-pink-500 to-rose-500 flex items-center justify-between px-3 text-white text-sm font-semibold transition-all duration-500"
                                        style={{ width: `${percentage}%` }}
                                    >
                                        {data.amount > 0 && (
                                            <>
                                                <span>₦{data.amount.toLocaleString()}</span>
                                                <span className="text-xs opacity-80">{data.count} donations</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* Top Donors */}
            <div className="bg-card border rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold mb-6">Top Donors</h3>
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead>
                            <tr className="border-b">
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">#</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Donor Name</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Donations</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {topDonors.map((donor, index) => (
                                <tr key={index} className="border-b last:border-0 hover:bg-muted/50 transition-colors">
                                    <td className="py-3 px-4 font-medium">{index + 1}</td>
                                    <td className="py-3 px-4">{donor.name}</td>
                                    <td className="py-3 px-4 text-right">{donor.count}</td>
                                    <td className="py-3 px-4 text-right font-semibold text-green-600">
                                        ₦{donor.amount.toLocaleString()}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Recent Donations Table */}
            <div className="bg-card border rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold mb-6">Recent Donations</h3>
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead>
                            <tr className="border-b">
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Date</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Donor</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Type</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Purpose</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Amount</th>
                                <th className="text-center py-3 px-4 font-medium text-muted-foreground">Receipt</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {donations.length === 0 ? (
                                <tr>
                                    <td colSpan={7} className="text-center py-8 text-muted-foreground">
                                        No donations recorded
                                    </td>
                                </tr>
                            ) : (
                                donations.slice(0, 20).map((donation) => (
                                    <tr key={donation.id} className="border-b last:border-0 hover:bg-muted/50 transition-colors">
                                        <td className="py-3 px-4 text-sm">
                                            {new Date(donation.transaction.date).toLocaleDateString()}
                                        </td>
                                        <td className="py-3 px-4">
                                            {donation.isAnonymous ? (
                                                <span className="text-muted-foreground italic">Anonymous</span>
                                            ) : (
                                                <div>
                                                    <div className="font-medium">{donation.donorName}</div>
                                                    {donation.donorEmail && (
                                                        <div className="text-xs text-muted-foreground">{donation.donorEmail}</div>
                                                    )}
                                                </div>
                                            )}
                                        </td>
                                        <td className="py-3 px-4">
                                            <span className="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">
                                                {donation.donationType}
                                            </span>
                                        </td>
                                        <td className="py-3 px-4 text-sm">{donation.purpose || 'General'}</td>
                                        <td className="py-3 px-4 text-right font-semibold text-green-600">
                                            ₦{Number(donation.transaction.amount).toLocaleString()}
                                        </td>
                                        <td className="py-3 px-4 text-center">
                                            {donation.receiptIssued ? (
                                                <div className="flex items-center justify-center gap-1 text-green-600">
                                                    <CheckCircle className="h-4 w-4" />
                                                    <span className="text-xs">{donation.receiptNumber}</span>
                                                </div>
                                            ) : (
                                                <span className="text-xs text-muted-foreground">Not issued</span>
                                            )}
                                        </td>
                                        <td className="py-3 px-4 text-right">
                                            {!donation.receiptIssued && (
                                                <button
                                                    onClick={() => handleIssueReceipt(donation.id)}
                                                    className="text-xs px-3 py-1 bg-primary text-primary-foreground rounded hover:bg-primary/90"
                                                >
                                                    Issue Receipt
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Modal */}
            {showModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-card rounded-lg p-6 w-full max-w-2xl shadow-xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold">Record Donation</h3>
                            <button onClick={() => setShowModal(false)} className="text-muted-foreground hover:text-foreground">
                                <X className="h-5 w-5" />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Donor Name *</label>
                                    <input
                                        type="text"
                                        value={formData.donorName || ''}
                                        onChange={(e) => setFormData({ ...formData, donorName: e.target.value })}
                                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                        required
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Email</label>
                                    <input
                                        type="email"
                                        value={formData.donorEmail || ''}
                                        onChange={(e) => setFormData({ ...formData, donorEmail: e.target.value })}
                                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Phone</label>
                                    <input
                                        type="tel"
                                        value={formData.donorPhone || ''}
                                        onChange={(e) => setFormData({ ...formData, donorPhone: e.target.value })}
                                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Amount *</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={formData.amount || ''}
                                        onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                        required
                                    />
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-medium">Address</label>
                                <input
                                    type="text"
                                    value={formData.donorAddress || ''}
                                    onChange={(e) => setFormData({ ...formData, donorAddress: e.target.value })}
                                    className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Donation Type *</label>
                                    <select
                                        value={formData.donationType}
                                        onChange={(e) => setFormData({ ...formData, donationType: e.target.value })}
                                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                        required
                                    >
                                        <option value="One-time">One-time</option>
                                        <option value="Monthly">Monthly</option>
                                        <option value="Annual">Annual</option>
                                    </select>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Purpose</label>
                                    <select
                                        value={formData.purpose}
                                        onChange={(e) => setFormData({ ...formData, purpose: e.target.value })}
                                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                    >
                                        <option value="General">General</option>
                                        <option value="Scholarship">Scholarship</option>
                                        <option value="Infrastructure">Infrastructure</option>
                                        <option value="Operations">Operations</option>
                                    </select>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-medium">Notes</label>
                                <textarea
                                    value={formData.notes || ''}
                                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                    className="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                />
                            </div>

                            <div className="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    id="anonymous"
                                    checked={formData.isAnonymous}
                                    onChange={(e) => setFormData({ ...formData, isAnonymous: e.target.checked })}
                                    className="h-4 w-4"
                                />
                                <label htmlFor="anonymous" className="text-sm font-medium">
                                    Anonymous Donation
                                </label>
                            </div>

                            <div className="flex gap-2 justify-end pt-4">
                                <button
                                    type="button"
                                    onClick={() => setShowModal(false)}
                                    className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium hover:bg-accent"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90"
                                >
                                    Record Donation
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/admin/(dashboard)/layout.tsx">
import Link from "next/link";
import { LayoutDashboard, Users, FileText, CreditCard, Settings, LogOut, BarChart3, Wallet, Heart, Shield } from "lucide-react";

export default function AdminLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className="flex min-h-screen bg-muted/20">
            {/* Sidebar */}
            <aside className="w-64 bg-card border-r hidden md:flex flex-col fixed h-full">
                <div className="p-6 border-b">
                    <h1 className="text-xl font-bold text-primary">ETF Admin</h1>
                    <p className="text-xs text-muted-foreground">Committee Portal</p>
                </div>
                <nav className="flex-1 p-4 space-y-2">
                    <Link
                        href="/admin"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <LayoutDashboard className="h-5 w-5" />
                        Dashboard
                    </Link>
                    <Link
                        href="/admin/applications"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <FileText className="h-5 w-5" />
                        Applications
                    </Link>
                    <Link
                        href="/admin/beneficiaries"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <Users className="h-5 w-5" />
                        Beneficiaries
                    </Link>
                    <Link
                        href="/admin/disbursements"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <CreditCard className="h-5 w-5" />
                        Disbursements
                    </Link>
                    <Link
                        href="/admin/reports"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <BarChart3 className="h-5 w-5" />
                        Reports
                    </Link>
                    <Link
                        href="/admin/finance"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <Wallet className="h-5 w-5" />
                        Finance
                    </Link>
                    <Link
                        href="/admin/donations"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <Heart className="h-5 w-5" />
                        Donations
                    </Link>
                    <Link
                        href="/admin/users"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <Shield className="h-5 w-5" />
                        Committee Members
                    </Link>
                    <Link
                        href="/admin/settings"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md hover:bg-accent hover:text-accent-foreground transition-colors"
                    >
                        <Settings className="h-5 w-5" />
                        Settings
                    </Link>
                </nav>
                <div className="p-4 border-t">
                    <Link
                        href="/login"
                        className="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-md text-destructive hover:bg-destructive/10 transition-colors"
                    >
                        <LogOut className="h-5 w-5" />
                        Sign Out
                    </Link>
                </div>
            </aside>

            {/* Main Content */}
            <main className="flex-1 md:ml-64">
                <div className="p-8">
                    {children}
                </div>
            </main>
        </div>
    );
}
</file>

<file path="src/app/admin/(dashboard)/reports/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { BarChart3, TrendingUp, Users, DollarSign, Download, Calendar, PieChart } from "lucide-react";
import { ReportResponse, ApiResponse } from "@/types";

export default function ReportsPage() {
    const [reportData, setReportData] = useState<ReportResponse | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());

    useEffect(() => {
        fetchReport();
    }, [selectedYear]);

    const fetchReport = async () => {
        setIsLoading(true);
        try {
            const response = await fetch(`/api/admin/reports?year=${selectedYear}`);
            const result: ApiResponse<ReportResponse> = await response.json();
            if (result.success && result.data) {
                setReportData(result.data);
            }
        } catch (error) {
            console.error("Error fetching report:", error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleExportPDF = () => {
        // In a real implementation, this would generate a PDF
        alert("PDF export functionality would be implemented here");
    };

    if (isLoading) {
        return (
            <div className="flex items-center justify-center h-64">
                <div className="text-lg text-muted-foreground">Loading reports...</div>
            </div>
        );
    }

    if (!reportData) {
        return (
            <div className="flex items-center justify-center h-64">
                <div className="text-lg text-muted-foreground">No data available</div>
            </div>
        );
    }

    const { summary, statusBreakdown, genderBreakdown, levelBreakdown, monthlyData, topSchools } = reportData;

    return (
        <div className="space-y-8 animate-fade-in">
            {/* Header */}
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">Reports & Analytics</h2>
                    <p className="text-muted-foreground">Comprehensive insights and statistics</p>
                </div>
                <div className="flex gap-3">
                    <select
                        value={selectedYear}
                        onChange={(e) => setSelectedYear(e.target.value)}
                        className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium"
                    >
                        {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i).map(year => (
                            <option key={year} value={year}>{year}</option>
                        ))}
                    </select>
                    <button
                        onClick={handleExportPDF}
                        className="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 flex items-center gap-2"
                    >
                        <Download className="h-4 w-4" />
                        Export PDF
                    </button>
                </div>
            </div>

            {/* Summary Cards */}
            <div className="grid gap-6 md:grid-cols-4">
                <div className="relative p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg overflow-hidden group hover:shadow-xl transition-shadow">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <Users className="h-8 w-8 opacity-80" />
                            <TrendingUp className="h-5 w-5 opacity-60" />
                        </div>
                        <div className="text-3xl font-bold mb-1">{summary.totalApplications}</div>
                        <div className="text-sm opacity-90">Total Applications</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-2xl shadow-lg overflow-hidden group hover:shadow-xl transition-shadow">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <DollarSign className="h-8 w-8 opacity-80" />
                            <TrendingUp className="h-5 w-5 opacity-60" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{summary.totalDisbursed.toLocaleString()}</div>
                        <div className="text-sm opacity-90">Total Disbursed</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-2xl shadow-lg overflow-hidden group hover:shadow-xl transition-shadow">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <BarChart3 className="h-8 w-8 opacity-80" />
                            <TrendingUp className="h-5 w-5 opacity-60" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{Math.round(summary.averageAmount).toLocaleString()}</div>
                        <div className="text-sm opacity-90">Average Amount</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-yellow-500 to-orange-500 text-white rounded-2xl shadow-lg overflow-hidden group hover:shadow-xl transition-shadow">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <PieChart className="h-8 w-8 opacity-80" />
                            <TrendingUp className="h-5 w-5 opacity-60" />
                        </div>
                        <div className="text-3xl font-bold mb-1">{summary.approvalRate.toFixed(1)}%</div>
                        <div className="text-sm opacity-90">Approval Rate</div>
                    </div>
                </div>
            </div>

            {/* Charts Section */}
            <div className="grid gap-6 md:grid-cols-2">
                {/* Status Breakdown */}
                <div className="bg-card border rounded-2xl p-6 shadow-sm">
                    <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                        <PieChart className="h-5 w-5 text-primary" />
                        Application Status
                    </h3>
                    <div className="space-y-4">
                        {Object.entries(statusBreakdown).map(([status, count]) => {
                            const percentage = (count / summary.totalApplications) * 100;
                            const colors: Record<string, string> = {
                                'Pending': 'bg-yellow-500',
                                'Under Review': 'bg-blue-500',
                                'Approved': 'bg-green-500',
                                'Disbursed': 'bg-emerald-500',
                                'Rejected': 'bg-red-500'
                            };
                            return (
                                <div key={status}>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="font-medium">{status}</span>
                                        <span className="text-muted-foreground">{count} ({percentage.toFixed(1)}%)</span>
                                    </div>
                                    <div className="h-2 bg-muted rounded-full overflow-hidden">
                                        <div
                                            className={`h-full ${colors[status] || 'bg-gray-500'} transition-all duration-500`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Gender Breakdown */}
                <div className="bg-card border rounded-2xl p-6 shadow-sm">
                    <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                        <Users className="h-5 w-5 text-primary" />
                        Gender Distribution
                    </h3>
                    <div className="space-y-4">
                        {Object.entries(genderBreakdown).map(([gender, count]) => {
                            const percentage = (count / summary.totalApplications) * 100;
                            const colors: Record<string, string> = {
                                'Male': 'bg-blue-500',
                                'Female': 'bg-pink-500',
                                'Unknown': 'bg-gray-500'
                            };
                            return (
                                <div key={gender}>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="font-medium">{gender}</span>
                                        <span className="text-muted-foreground">{count} ({percentage.toFixed(1)}%)</span>
                                    </div>
                                    <div className="h-2 bg-muted rounded-full overflow-hidden">
                                        <div
                                            className={`h-full ${colors[gender] || 'bg-gray-500'} transition-all duration-500`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Education Level */}
                <div className="bg-card border rounded-2xl p-6 shadow-sm">
                    <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                        <BarChart3 className="h-5 w-5 text-primary" />
                        Education Level
                    </h3>
                    <div className="space-y-4">
                        {Object.entries(levelBreakdown).map(([level, count]) => {
                            const percentage = (count / summary.totalApplications) * 100;
                            const colors: Record<string, string> = {
                                'Primary': 'bg-green-500',
                                'Secondary': 'bg-blue-500',
                                'Tertiary': 'bg-purple-500'
                            };
                            return (
                                <div key={level}>
                                    <div className="flex justify-between text-sm mb-2">
                                        <span className="font-medium">{level}</span>
                                        <span className="text-muted-foreground">{count} ({percentage.toFixed(1)}%)</span>
                                    </div>
                                    <div className="h-2 bg-muted rounded-full overflow-hidden">
                                        <div
                                            className={`h-full ${colors[level] || 'bg-gray-500'} transition-all duration-500`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* Monthly Trend */}
                <div className="bg-card border rounded-2xl p-6 shadow-sm">
                    <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                        <Calendar className="h-5 w-5 text-primary" />
                        Monthly Applications
                    </h3>
                    <div className="space-y-3">
                        {monthlyData.map((data) => {
                            const maxCount = Math.max(...monthlyData.map((d) => d.applications));
                            const percentage = maxCount > 0 ? (data.applications / maxCount) * 100 : 0;
                            return (
                                <div key={data.month} className="flex items-center gap-3">
                                    <div className="w-12 text-sm font-medium text-muted-foreground">{data.month}</div>
                                    <div className="flex-1 h-8 bg-muted rounded-lg overflow-hidden">
                                        <div
                                            className="h-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-end pr-2 text-white text-xs font-semibold transition-all duration-500"
                                            style={{ width: `${percentage}%` }}
                                        >
                                            {data.applications > 0 && data.applications}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>

            {/* Top Schools Table */}
            <div className="bg-card border rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold mb-6">Top 10 Schools by Applications</h3>
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead>
                            <tr className="border-b">
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">#</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">School Name</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Applications</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Total Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {topSchools.map((school, index) => (
                                <tr key={school.name} className="border-b last:border-0 hover:bg-muted/50 transition-colors">
                                    <td className="py-3 px-4 font-medium">{index + 1}</td>
                                    <td className="py-3 px-4">{school.name}</td>
                                    <td className="py-3 px-4 text-right font-semibold">{school.count}</td>
                                    <td className="py-3 px-4 text-right font-semibold text-green-600">
                                        ₦{school.amount.toLocaleString()}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/api/admin/disbursements/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET() {
    try {
        // Fetch all approved applications with disbursement info
        const applications = await prisma.application.findMany({
            where: {
                status: {
                    in: ["Approved", "Disbursed"]
                }
            },
            include: {
                applicant: {
                    select: {
                        firstName: true,
                        surname: true,
                        email: true,
                    }
                }
            },
            orderBy: {
                updatedAt: 'desc'
            }
        });

        return NextResponse.json({ success: true, data: applications });
    } catch (error) {
        console.error("Error fetching disbursements:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch disbursements" }, { status: 500 });
    }
}

export async function POST(request: Request) {
    try {
        const body = await request.json();
        const { applicationId, voucherCode, paymentReference } = body;

        if (!applicationId || !voucherCode) {
            return NextResponse.json({ success: false, error: "Missing required fields" }, { status: 400 });
        }

        // Update application with disbursement details
        const application = await prisma.application.update({
            where: { id: applicationId },
            data: {
                status: "Disbursed",
                voucherCode,
                paymentReference,
                disbursedDate: new Date(),
            }
        });

        return NextResponse.json({ success: true, data: application });
    } catch (error) {
        console.error("Error recording disbursement:", error);
        return NextResponse.json({ success: false, error: "Failed to record disbursement" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/admin/donations/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { Prisma } from "@prisma/client";

// GET - Fetch donations
export async function GET(request: Request) {
    try {
        const { searchParams } = new URL(request.url);
        const year = searchParams.get('year') || new Date().getFullYear().toString();
        const startDate = new Date(`${year}-01-01`);
        const endDate = new Date(`${year}-12-31`);

        const donations = await prisma.donation.findMany({
            where: {
                transaction: {
                    date: {
                        gte: startDate,
                        lte: endDate
                    }
                }
            },
            include: {
                transaction: true
            },
            orderBy: {
                createdAt: 'desc'
            }
        });

        // Calculate statistics
        const totalDonations = donations.reduce((sum, d) => sum + Number(d.transaction.amount), 0);
        const totalDonors = new Set(donations.map(d => d.donorEmail || d.donorName)).size;

        const typeBreakdown = donations.reduce((acc: any, d) => {
            acc[d.donationType] = (acc[d.donationType] || 0) + Number(d.transaction.amount);
            return acc;
        }, {});

        const purposeBreakdown = donations.reduce((acc: any, d) => {
            const purpose = d.purpose || 'General';
            acc[purpose] = (acc[purpose] || 0) + Number(d.transaction.amount);
            return acc;
        }, {});

        // Monthly trend
        const monthlyData = Array.from({ length: 12 }, (_, i) => {
            const month = i + 1;
            const monthDonations = donations.filter(d => {
                const donationMonth = new Date(d.transaction.date).getMonth() + 1;
                return donationMonth === month;
            });
            const total = monthDonations.reduce((sum, d) => sum + Number(d.transaction.amount), 0);
            return {
                month: new Date(2024, i).toLocaleString('default', { month: 'short' }),
                amount: total,
                count: monthDonations.length
            };
        });

        // Top donors
        const donorStats = donations.reduce((acc: any, d) => {
            const key = d.isAnonymous ? 'Anonymous' : (d.donorEmail || d.donorName);
            if (!acc[key]) {
                acc[key] = { name: d.isAnonymous ? 'Anonymous' : d.donorName, amount: 0, count: 0 };
            }
            acc[key].amount += Number(d.transaction.amount);
            acc[key].count++;
            return acc;
        }, {});

        const topDonors = Object.values(donorStats)
            .sort((a: any, b: any) => b.amount - a.amount)
            .slice(0, 10);

        return NextResponse.json({
            success: true,
            data: {
                donations,
                summary: {
                    totalDonations,
                    totalDonors,
                    averageDonation: donations.length > 0 ? totalDonations / donations.length : 0,
                    receiptsIssued: donations.filter(d => d.receiptIssued).length
                },
                typeBreakdown,
                purposeBreakdown,
                monthlyData,
                topDonors
            }
        });
    } catch (error) {
        console.error("Error fetching donations:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch donations" }, { status: 500 });
    }
}

// POST - Create donation (creates both transaction and donation record)
export async function POST(request: Request) {
    try {
        const body = await request.json();

        // Create transaction first
        const transaction = await prisma.transaction.create({
            data: {
                type: 'Income',
                category: 'Donation',
                amount: new Prisma.Decimal(body.amount),
                description: `Donation from ${body.isAnonymous ? 'Anonymous' : body.donorName}`,
                reference: body.reference,
                date: new Date(body.date || new Date()),
                createdBy: body.createdBy
            }
        });

        // Create donation record
        const donation = await prisma.donation.create({
            data: {
                transactionId: transaction.id,
                donorName: body.donorName,
                donorEmail: body.donorEmail,
                donorPhone: body.donorPhone,
                donorAddress: body.donorAddress,
                donationType: body.donationType,
                isAnonymous: body.isAnonymous || false,
                purpose: body.purpose,
                receiptIssued: body.receiptIssued || false,
                receiptNumber: body.receiptNumber,
                notes: body.notes
            },
            include: {
                transaction: true
            }
        });

        return NextResponse.json({ success: true, data: donation });
    } catch (error) {
        console.error("Error creating donation:", error);
        return NextResponse.json({ success: false, error: "Failed to create donation" }, { status: 500 });
    }
}

// PATCH - Update donation (e.g., issue receipt)
export async function PATCH(request: Request) {
    try {
        const body = await request.json();
        const { id, ...updateData } = body;

        const donation = await prisma.donation.update({
            where: { id },
            data: updateData,
            include: {
                transaction: true
            }
        });

        return NextResponse.json({ success: true, data: donation });
    } catch (error) {
        console.error("Error updating donation:", error);
        return NextResponse.json({ success: false, error: "Failed to update donation" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/admin/finance/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { Prisma } from "@prisma/client";

// GET - Fetch financial overview
export async function GET(request: Request) {
    try {
        const { searchParams } = new URL(request.url);
        const year = parseInt(searchParams.get('year') || new Date().getFullYear().toString());

        // Get budgets for the year
        const budgets = await prisma.budget.findMany({
            where: { year },
            include: {
                transactions: true
            },
            orderBy: [
                { quarter: 'asc' },
                { category: 'asc' }
            ]
        });

        // Get all transactions for the year
        const transactions = await prisma.transaction.findMany({
            where: {
                date: {
                    gte: new Date(`${year}-01-01`),
                    lte: new Date(`${year}-12-31`)
                }
            },
            orderBy: {
                date: 'desc'
            },
            take: 100
        });

        // Calculate summary
        const totalBudget = budgets.reduce((sum, b) => sum + Number(b.allocated), 0);
        const totalSpent = budgets.reduce((sum, b) => sum + Number(b.spent), 0);
        const totalIncome = transactions
            .filter(t => t.type === 'Income')
            .reduce((sum, t) => sum + Number(t.amount), 0);
        const totalExpenses = transactions
            .filter(t => t.type === 'Expense')
            .reduce((sum, t) => sum + Number(t.amount), 0);

        return NextResponse.json({
            success: true,
            data: {
                budgets,
                transactions,
                summary: {
                    totalBudget,
                    totalSpent,
                    totalIncome,
                    totalExpenses,
                    balance: totalIncome - totalExpenses,
                    budgetUtilization: totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0
                }
            }
        });
    } catch (error) {
        console.error("Error fetching financial data:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch financial data" }, { status: 500 });
    }
}

// POST - Create budget or transaction
export async function POST(request: Request) {
    try {
        const body = await request.json();
        const { type, ...data } = body;

        if (type === 'budget') {
            const budget = await prisma.budget.create({
                data: {
                    year: data.year,
                    quarter: data.quarter || null,
                    category: data.category,
                    allocated: new Prisma.Decimal(data.allocated),
                    description: data.description
                }
            });
            return NextResponse.json({ success: true, data: budget });
        } else if (type === 'transaction') {
            const transaction = await prisma.transaction.create({
                data: {
                    budgetId: data.budgetId || null,
                    type: data.transactionType,
                    category: data.category,
                    amount: new Prisma.Decimal(data.amount),
                    description: data.description,
                    reference: data.reference,
                    date: new Date(data.date),
                    createdBy: data.createdBy
                }
            });

            // Update budget spent amount if linked
            if (data.budgetId && data.transactionType === 'Expense') {
                await prisma.budget.update({
                    where: { id: data.budgetId },
                    data: {
                        spent: {
                            increment: new Prisma.Decimal(data.amount)
                        }
                    }
                });
            }

            return NextResponse.json({ success: true, data: transaction });
        }

        return NextResponse.json({ success: false, error: "Invalid type" }, { status: 400 });
    } catch (error) {
        console.error("Error creating financial record:", error);
        return NextResponse.json({ success: false, error: "Failed to create record" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/admin/reports/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
    try {
        const { searchParams } = new URL(request.url);
        const year = searchParams.get('year') || new Date().getFullYear().toString();

        // Get all applications for the year
        const startDate = new Date(`${year}-01-01`);
        const endDate = new Date(`${year}-12-31`);

        const applications = await prisma.application.findMany({
            where: {
                createdAt: {
                    gte: startDate,
                    lte: endDate
                }
            },
            include: {
                applicant: {
                    select: {
                        firstName: true,
                        surname: true,
                        sex: true,
                        stateOrigin: true,
                    }
                }
            }
        });

        // Calculate statistics
        const totalApplications = applications.length;
        const statusBreakdown = applications.reduce((acc: any, app) => {
            acc[app.status] = (acc[app.status] || 0) + 1;
            return acc;
        }, {});

        const genderBreakdown = applications.reduce((acc: any, app) => {
            const gender = app.applicant.sex || 'Unknown';
            acc[gender] = (acc[gender] || 0) + 1;
            return acc;
        }, {});

        const levelBreakdown = applications.reduce((acc: any, app) => {
            const level = app.presentClass?.includes('Primary') ? 'Primary' :
                app.presentClass?.includes('JSS') || app.presentClass?.includes('SSS') ? 'Secondary' :
                    'Tertiary';
            acc[level] = (acc[level] || 0) + 1;
            return acc;
        }, {});

        // Calculate monthly trends
        const monthlyData = Array.from({ length: 12 }, (_, i) => {
            const month = i + 1;
            const count = applications.filter(app => {
                const appMonth = new Date(app.createdAt).getMonth() + 1;
                return appMonth === month;
            }).length;
            return {
                month: new Date(2024, i).toLocaleString('default', { month: 'short' }),
                applications: count
            };
        });

        // Calculate financial data
        const totalDisbursed = applications
            .filter(app => app.status === 'Disbursed' && app.approvedAmount)
            .reduce((sum, app) => sum + parseFloat(app.approvedAmount || '0'), 0);

        const totalApproved = applications
            .filter(app => (app.status === 'Approved' || app.status === 'Disbursed') && app.approvedAmount)
            .reduce((sum, app) => sum + parseFloat(app.approvedAmount || '0'), 0);

        const averageAmount = totalApproved / applications.filter(app => app.approvedAmount).length || 0;

        // Top schools
        const schoolStats = applications.reduce((acc: any, app) => {
            const school = app.schoolName;
            if (!acc[school]) {
                acc[school] = { count: 0, amount: 0 };
            }
            acc[school].count++;
            if (app.approvedAmount) {
                acc[school].amount += parseFloat(app.approvedAmount);
            }
            return acc;
        }, {});

        const topSchools = Object.entries(schoolStats)
            .map(([name, data]: [string, any]) => ({ name, ...data }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 10);

        return NextResponse.json({
            success: true,
            data: {
                summary: {
                    totalApplications,
                    totalDisbursed,
                    totalApproved,
                    averageAmount,
                    approvalRate: ((statusBreakdown['Approved'] || 0) + (statusBreakdown['Disbursed'] || 0)) / totalApplications * 100 || 0
                },
                statusBreakdown,
                genderBreakdown,
                levelBreakdown,
                monthlyData,
                topSchools
            }
        });
    } catch (error) {
        console.error("Error generating report:", error);
        return NextResponse.json({ success: false, error: "Failed to generate report" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/admin/stats/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET() {
    try {
        const totalApplications = await prisma.application.count();
        const pendingReview = await prisma.application.count({
            where: { status: "Pending" }
        });
        const approvedScholars = await prisma.application.count({
            where: { status: "Approved" }
        });
        // For beneficiaries, we might count unique applicants with approved applications
        const totalBeneficiaries = await prisma.applicant.count({
            where: {
                applications: {
                    some: {
                        status: "Approved"
                    }
                }
            }
        });

        return NextResponse.json({
            success: true,
            data: {
                totalApplications,
                pendingReview,
                approvedScholars,
                totalBeneficiaries
            }
        });
    } catch (error) {
        console.error("Error fetching stats:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch stats" }, { status: 500 });
    }
}
</file>

<file path="src/app/dashboard/page.tsx">
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { FileText, Clock, CheckCircle, AlertCircle, XCircle, Loader2 } from "lucide-react";

export default function DashboardPage() {
    const [applicant, setApplicant] = useState<any>(null);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        fetchDashboard();
    }, []);

    const fetchDashboard = async () => {
        try {
            const response = await fetch("/api/dashboard");
            const result = await response.json();
            if (result.success) {
                setApplicant(result.data);
            }
        } catch (error) {
            console.error("Error fetching dashboard:", error);
        } finally {
            setIsLoading(false);
        }
    };

    if (isLoading) {
        return (
            <div className="container mx-auto px-4 py-12 max-w-5xl flex items-center justify-center h-64">
                <Loader2 className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    // No application submitted yet
    if (!applicant || !applicant.applications || applicant.applications.length === 0) {
        return (
            <div className="container mx-auto px-4 py-12 max-w-5xl">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-bold">My Dashboard</h1>
                </div>
                <div className="bg-card border rounded-lg p-12 shadow-sm text-center">
                    <FileText className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
                    <h2 className="text-2xl font-semibold mb-2">No Application Yet</h2>
                    <p className="text-muted-foreground mb-6">
                        You typically haven&apos;t submitted a scholarship application. Start your application to get support for your education.
                    </p>
                    <Link
                        href="/apply/form"
                        className="inline-flex px-6 py-3 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 text-sm font-medium"
                    >
                        Start New Application
                    </Link>
                </div>
            </div>
        );
    }

    const latestApplication = applicant.applications[0];
    const status = latestApplication.status;

    const getStatusIcon = () => {
        switch (status) {
            case "Pending":
                return <Clock className="h-6 w-6 text-yellow-600" />;
            case "Under Review":
                return <Clock className="h-6 w-6 text-blue-600" />;
            case "Approved":
                return <CheckCircle className="h-6 w-6 text-green-600" />;
            case "Disbursed":
                return <CheckCircle className="h-6 w-6 text-green-600" />;
            case "Rejected":
                return <XCircle className="h-6 w-6 text-red-600" />;
            default:
                return <Clock className="h-6 w-6 text-gray-600" />;
        }
    };

    const getStatusColor = () => {
        switch (status) {
            case "Pending":
                return "bg-yellow-100";
            case "Under Review":
                return "bg-blue-100";
            case "Approved":
                return "bg-green-100";
            case "Disbursed":
                return "bg-green-100";
            case "Rejected":
                return "bg-red-100";
            default:
                return "bg-gray-100";
        }
    };

    const progressSteps = [
        { label: "Application Submitted", completed: true },
        { label: "Committee Review", completed: ["Under Review", "Approved", "Disbursed"].includes(status), active: status === "Under Review" },
        { label: "Verification", completed: ["Approved", "Disbursed"].includes(status), active: status === "Approved" },
        { label: "Disbursement", completed: status === "Disbursed", active: false },
    ];

    const documents = [
        { name: "School Bill", url: latestApplication.schoolBillUrl },
        { name: "Birth Certificate", url: latestApplication.birthCertUrl },
        { name: "Primary Certificate", url: latestApplication.primaryCertUrl },
        { name: "School Results", url: latestApplication.schoolResultUrl },
        { name: "Assistance Letter", url: latestApplication.assistanceLetterUrl },
    ];

    return (
        <div className="container mx-auto px-4 py-12 max-w-5xl">
            <div className="flex justify-between items-center mb-8">
                <h1 className="text-3xl font-bold">My Dashboard</h1>
                <Link
                    href="/apply/form"
                    className="px-4 py-2 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 text-sm font-medium"
                >
                    New Application
                </Link>
            </div>

            <div className="grid gap-6 md:grid-cols-3">
                {/* Status Card */}
                <div className="col-span-2 bg-card border rounded-lg p-6 shadow-sm">
                    <h2 className="text-xl font-semibold mb-4">Application Status</h2>
                    <div className={`flex items-center gap-4 p-4 ${getStatusColor()} rounded-md`}>
                        <div className={`h-12 w-12 rounded-full ${getStatusColor()} flex items-center justify-center`}>
                            {getStatusIcon()}
                        </div>
                        <div>
                            <p className="font-medium text-lg">{status}</p>
                            <p className="text-sm text-muted-foreground">
                                Submitted on {new Date(latestApplication.createdAt).toLocaleDateString()}
                            </p>
                        </div>
                    </div>

                    {status === "Approved" && latestApplication.approvedAmount && (
                        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <p className="text-sm font-medium text-green-800">
                                Approved Amount: ₦{parseFloat(latestApplication.approvedAmount).toLocaleString()}
                            </p>
                        </div>
                    )}

                    {status === "Disbursed" && (
                        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
                            <p className="text-sm font-medium text-green-800">
                                Disbursed: ₦{parseFloat(latestApplication.approvedAmount || "0").toLocaleString()}
                            </p>
                            {latestApplication.voucherCode && (
                                <p className="text-sm text-green-700 mt-1">
                                    Voucher Code: {latestApplication.voucherCode}
                                </p>
                            )}
                        </div>
                    )}

                    {status === "Rejected" && (
                        <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-md">
                            <p className="text-sm font-medium text-red-800">
                                Your application was not approved at this time.
                            </p>
                        </div>
                    )}

                    <div className="mt-6 space-y-4">
                        {progressSteps.map((step, index) => (
                            <div key={index} className="flex items-center gap-3">
                                {step.completed ? (
                                    <CheckCircle className="h-5 w-5 text-green-500" />
                                ) : step.active ? (
                                    <div className="h-5 w-5 rounded-full border-2 border-primary flex items-center justify-center">
                                        <div className="h-2.5 w-2.5 rounded-full bg-primary animate-pulse" />
                                    </div>
                                ) : (
                                    <div className="h-5 w-5 rounded-full border-2 border-muted" />
                                )}
                                <span className={`text-sm ${step.completed || step.active ? "font-medium" : "opacity-50"}`}>
                                    {step.label}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Notifications / Actions */}
                <div className="space-y-6">
                    <div className="bg-card border rounded-lg p-6 shadow-sm">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                            <AlertCircle className="h-5 w-5 text-primary" />
                            Action Required
                        </h2>
                        <p className="text-sm text-muted-foreground">
                            {status === "Pending" && "Your application is pending review. No action required."}
                            {status === "Under Review" && "Your application is currently under review. No further action is required at this time."}
                            {status === "Approved" && "Your application has been approved! Payment will be processed soon."}
                            {status === "Disbursed" && "Payment has been disbursed to your school."}
                            {status === "Rejected" && "You may contact the committee for more information."}
                        </p>
                    </div>

                    <div className="bg-card border rounded-lg p-6 shadow-sm">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                            <FileText className="h-5 w-5 text-secondary" />
                            Documents
                        </h2>
                        <ul className="space-y-2 text-sm">
                            {documents.map((doc, index) => (
                                <li key={index} className="flex justify-between">
                                    <span className="text-muted-foreground">{doc.name}</span>
                                    {doc.url ? (
                                        <a href={doc.url} target="_blank" rel="noopener noreferrer" className="text-green-600 hover:underline">
                                            View
                                        </a>
                                    ) : (
                                        <span className="text-red-600">Not Uploaded</span>
                                    )}
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="bg-card border rounded-lg p-6 shadow-sm">
                        <h2 className="text-lg font-semibold mb-2">School Details</h2>
                        <p className="text-sm text-muted-foreground">{latestApplication.schoolName}</p>
                        <p className="text-sm text-muted-foreground">{latestApplication.presentClass}</p>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";
@theme {
    --color-background: hsl(var(--background));
    --color-foreground: hsl(var(--foreground));
    --color-card: hsl(var(--card));
    --color-card-foreground: hsl(var(--card-foreground));
    --color-popover: hsl(var(--popover));
    --color-popover-foreground: hsl(var(--popover-foreground));
    --color-primary: hsl(var(--primary));
    --color-primary-foreground: hsl(var(--primary-foreground));
    --color-secondary: hsl(var(--secondary));
    --color-secondary-foreground: hsl(var(--secondary-foreground));
    --color-muted: hsl(var(--muted));
    --color-muted-foreground: hsl(var(--muted-foreground));
    --color-accent: hsl(var(--accent));
    --color-accent-foreground: hsl(var(--accent-foreground));
    --color-destructive: hsl(var(--destructive));
    --color-destructive-foreground: hsl(var(--destructive-foreground));
    --color-border: hsl(var(--border));
    --color-input: hsl(var(--input));
    --color-ring: hsl(var(--ring));
    --color-chart-1: hsl(var(--chart-1));
    --color-chart-2: hsl(var(--chart-2));
    --color-chart-3: hsl(var(--chart-3));
    --color-chart-4: hsl(var(--chart-4));
    --color-chart-5: hsl(var(--chart-5));
    --radius-lg: var(--radius);
    --radius-md: calc(var(--radius) - 2px);
    --radius-sm: calc(var(--radius) - 4px);
    --font-sans: var(--font-outfit), sans-serif;
}


/*
  The default border color has changed to `currentColor` in Tailwind CSS v4,
  so we've added these compatibility styles to make sure everything still
  looks the same as it did with Tailwind CSS v3.
*/

@layer base {
    *,
     ::after,
     ::before,
     ::backdrop,
     ::file-selector-button {
        border-color: var(--color-gray-200, currentColor);
    }
}

@layer base {
     :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --card: 0 0% 100%;
        --card-foreground: 222.2 84% 4.9%;
        --popover: 0 0% 100%;
        --popover-foreground: 222.2 84% 4.9%;
        --primary: 221.2 83.2% 53.3%;
        --primary-foreground: 210 40% 98%;
        --secondary: 47.9 95.8% 53.1%;
        --secondary-foreground: 26 83.3% 14.1%;
        --muted: 210 40% 96.1%;
        --muted-foreground: 215.4 16.3% 46.9%;
        --accent: 210 40% 96.1%;
        --accent-foreground: 222.2 47.4% 11.2%;
        --destructive: 0 84.2% 60.2%;
        --destructive-foreground: 210 40% 98%;
        --border: 214.3 31.8% 91.4%;
        --input: 214.3 31.8% 91.4%;
        --ring: 221.2 83.2% 53.3%;
        --radius: 0.5rem;
        --chart-1: 12 76% 61%;
        --chart-2: 173 58% 39%;
        --chart-3: 197 37% 24%;
        --chart-4: 43 74% 66%;
        --chart-5: 27 87% 67%;
    }
    .dark {
        --background: 222.2 84% 4.9%;
        --foreground: 210 40% 98%;
        --card: 222.2 84% 4.9%;
        --card-foreground: 210 40% 98%;
        --popover: 222.2 84% 4.9%;
        --popover-foreground: 210 40% 98%;
        --primary: 217.2 91.2% 59.8%;
        --primary-foreground: 222.2 47.4% 11.2%;
        --secondary: 47.9 95.8% 53.1%;
        --secondary-foreground: 26 83.3% 14.1%;
        --muted: 217.2 32.6% 17.5%;
        --muted-foreground: 215 20.2% 65.1%;
        --accent: 217.2 32.6% 17.5%;
        --accent-foreground: 210 40% 98%;
        --destructive: 0 62.8% 30.6%;
        --destructive-foreground: 210 40% 98%;
        --border: 217.2 32.6% 17.5%;
        --input: 217.2 32.6% 17.5%;
        --ring: 212.7 26.8% 83.9%;
        --chart-1: 220 70% 50%;
        --chart-2: 160 60% 45%;
        --chart-3: 30 80% 55%;
        --chart-4: 280 65% 60%;
        --chart-5: 340 75% 55%;
    }
}

@layer base {
    * {
        border-color: var(--border);
    }
    body {
        background-color: var(--background);
        color: var(--foreground);
    }
}

@layer utilities {
    .animate-fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.8s ease-out;
    }
    .animate-slide-in-left {
        animation: slideInLeft 0.6s ease-out;
    }
    .animate-slide-in-right {
        animation: slideInRight 0.6s ease-out;
    }
    .animate-scale-in {
        animation: scaleIn 0.5s ease-out;
    }
    .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .glass-dark {
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .gradient-primary {
        background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--secondary)) 100%);
    }
    .gradient-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
    }
    .text-gradient {
        background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--secondary)) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .shadow-glow {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    .shadow-glow-lg {
        box-shadow: 0 0 40px rgba(59, 130, 246, 0.4);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
</file>

<file path="src/app/login/page.tsx">
"use client";

export const dynamic = "force-dynamic";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { Loader2 } from "lucide-react";
import { createClient } from "@/lib/supabase/client";

export default function LoginPage() {
    const router = useRouter();
    const [isLoading, setIsLoading] = useState(false);
    const [email, setEmail] = useState("");
    const [password, setPassword] = useState("");
    const [error, setError] = useState<string | null>(null);
    const supabase = createClient();

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        setError(null);

        try {
            const { error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                setError(error.message);
            } else {
                router.push("/dashboard");
                router.refresh();
            }
        } catch (err) {
            setError("An unexpected error occurred");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="container flex h-screen w-screen flex-col items-center justify-center">
            <div className="mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]">
                <div className="flex flex-col space-y-2 text-center">
                    <h1 className="text-2xl font-semibold tracking-tight">Welcome back</h1>
                    <p className="text-sm text-muted-foreground">
                        Enter your email to sign in to your account
                    </p>
                </div>
                <div className="grid gap-6">
                    <form onSubmit={handleLogin}>
                        <div className="grid gap-4">
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="email">
                                    Email
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="email"
                                    placeholder="name@example.com"
                                    type="email"
                                    autoCapitalize="none"
                                    autoComplete="email"
                                    autoCorrect="off"
                                    disabled={isLoading}
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="password">
                                    Password
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="password"
                                    type="password"
                                    disabled={isLoading}
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>
                            {error && (
                                <div className="text-sm text-red-500 text-center">
                                    {error}
                                </div>
                            )}
                            <button
                                className="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2"
                                disabled={isLoading}
                            >
                                {isLoading && (
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                )}
                                Sign In
                            </button>
                        </div>
                    </form>
                    <div className="relative">
                        <div className="absolute inset-0 flex items-center">
                            <span className="w-full border-t" />
                        </div>
                        <div className="relative flex justify-center text-xs uppercase">
                            <span className="bg-background px-2 text-muted-foreground">
                                Or continue with
                            </span>
                        </div>
                    </div>
                    <div className="text-center text-sm text-muted-foreground">
                        <Link href="/register" className="hover:text-primary underline underline-offset-4">
                            Don&apos;t have an account? Sign Up
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/register/page.tsx">
"use client";

export const dynamic = "force-dynamic";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { Loader2 } from "lucide-react";
import { createClient } from "@/lib/supabase/client";

export default function RegisterPage() {
    const router = useRouter();
    const [isLoading, setIsLoading] = useState(false);
    const [email, setEmail] = useState("");
    const [password, setPassword] = useState("");
    const [confirmPassword, setConfirmPassword] = useState("");
    const [error, setError] = useState<string | null>(null);
    const supabase = createClient();

    const handleRegister = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        setError(null);

        if (password !== confirmPassword) {
            setError("Passwords do not match");
            setIsLoading(false);
            return;
        }

        try {
            const { error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: `${location.origin}/auth/callback`,
                },
            });

            if (error) {
                setError(error.message);
            } else {
                // Check if email confirmation is required
                alert("Registration successful! Please check your email to confirm your account.");
                router.push("/login");
            }
        } catch (err) {
            setError("An unexpected error occurred");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="container flex h-screen w-screen flex-col items-center justify-center">
            <div className="mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]">
                <div className="flex flex-col space-y-2 text-center">
                    <h1 className="text-2xl font-semibold tracking-tight">Create an account</h1>
                    <p className="text-sm text-muted-foreground">
                        Enter your email below to create your account
                    </p>
                </div>
                <div className="grid gap-6">
                    <form onSubmit={handleRegister}>
                        <div className="grid gap-4">
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="email">
                                    Email
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="email"
                                    placeholder="name@example.com"
                                    type="email"
                                    autoCapitalize="none"
                                    autoComplete="email"
                                    autoCorrect="off"
                                    disabled={isLoading}
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="password">
                                    Password
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="password"
                                    type="password"
                                    disabled={isLoading}
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="confirmPassword">
                                    Confirm Password
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="confirmPassword"
                                    type="password"
                                    disabled={isLoading}
                                    required
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                />
                            </div>
                            {error && (
                                <div className="text-sm text-red-500 text-center">
                                    {error}
                                </div>
                            )}
                            <button
                                className="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2"
                                disabled={isLoading}
                            >
                                {isLoading && (
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                )}
                                Sign Up
                            </button>
                        </div>
                    </form>
                    <div className="relative">
                        <div className="absolute inset-0 flex items-center">
                            <span className="w-full border-t" />
                        </div>
                        <div className="relative flex justify-center text-xs uppercase">
                            <span className="bg-background px-2 text-muted-foreground">
                                Or continue with
                            </span>
                        </div>
                    </div>
                    <div className="text-center text-sm text-muted-foreground">
                        <Link href="/login" className="hover:text-primary underline underline-offset-4">
                            Already have an account? Sign In
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/apply/DocumentUploadStep.tsx">
import { useState } from "react";
import { UploadCloud, CheckCircle, Loader2, XCircle } from "lucide-react";
import { createClient } from "@/lib/supabase/client";

interface DocumentUploadStepProps {
    updateData: (data: any) => void;
    data: any;
}

export function DocumentUploadStep({ updateData, data }: DocumentUploadStepProps) {
    const [uploading, setUploading] = useState<Record<string, boolean>>({});
    const [errors, setErrors] = useState<Record<string, string>>({});
    const supabase = createClient();

    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, field: string) => {
        if (!e.target.files || !e.target.files[0]) return;

        const file = e.target.files[0];
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random().toString(36).substring(2, 15)}_${Date.now()}.${fileExt}`;
        const filePath = `applications/${fileName}`;

        setUploading((prev) => ({ ...prev, [field]: true }));
        setErrors((prev) => ({ ...prev, [field]: "" }));

        try {
            const { error: uploadError } = await supabase.storage
                .from('documents')
                .upload(filePath, file);

            if (uploadError) {
                throw uploadError;
            }

            const { data: { publicUrl } } = supabase.storage
                .from('documents')
                .getPublicUrl(filePath);

            updateData({ [field]: publicUrl });
        } catch (error: any) {
            console.error("Upload error:", error);
            setErrors((prev) => ({ ...prev, [field]: "Upload failed. Please try again." }));
        } finally {
            setUploading((prev) => ({ ...prev, [field]: false }));
        }
    };

    const documents = [
        { id: "schoolFeesBill", label: "Present Annual School Fees (Bill)" },
        { id: "birthCertificate", label: "Recipient's Birth Certificate" },
        { id: "primaryCertificate", label: "Primary School Certificate" },
        { id: "schoolResults", label: "Latest School Results" },
        { id: "assistanceLetter", label: "One Page Letter Explaining Financial Need" },
    ];

    return (
        <div className="space-y-6 animate-fade-in">
            <h2 className="text-xl font-semibold mb-4">Document Upload</h2>
            <p className="text-sm text-muted-foreground mb-6">
                Please upload clear copies of the following documents. Supported formats: PDF, JPG, PNG.
            </p>

            <div className="grid gap-6">
                {documents.map((doc) => (
                    <div key={doc.id} className={`border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center text-center transition-colors ${data[doc.id] ? "bg-green-50 border-green-200" : "hover:bg-muted/50"}`}>
                        {data[doc.id] ? (
                            <>
                                <CheckCircle className="h-8 w-8 text-green-500 mb-2" />
                                <p className="text-sm font-medium text-green-700">Uploaded Successfully</p>
                                <a href={data[doc.id]} target="_blank" rel="noopener noreferrer" className="text-xs text-green-600 underline mt-1">
                                    View File
                                </a>
                            </>
                        ) : (
                            <>
                                {uploading[doc.id] ? (
                                    <Loader2 className="h-8 w-8 text-primary animate-spin mb-2" />
                                ) : (
                                    <UploadCloud className="h-8 w-8 text-muted-foreground mb-2" />
                                )}
                                <label htmlFor={doc.id} className={`text-sm font-medium ${uploading[doc.id] ? "cursor-not-allowed opacity-50" : "cursor-pointer"}`}>
                                    {uploading[doc.id] ? "Uploading..." : doc.label}
                                </label>
                                <input
                                    id={doc.id}
                                    type="file"
                                    className="hidden"
                                    accept=".pdf,.jpg,.jpeg,.png"
                                    onChange={(e) => handleFileUpload(e, doc.id)}
                                    disabled={uploading[doc.id]}
                                />
                            </>
                        )}
                        {errors[doc.id] && (
                            <div className="flex items-center gap-1 mt-2 text-red-500 text-xs">
                                <XCircle className="h-3 w-3" />
                                {errors[doc.id]}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="src/components/apply/FamilyInfoStep.tsx">
interface FamilyInfoStepProps {
    updateData: (data: any) => void;
    data: any;
}

export function FamilyInfoStep({ updateData, data }: FamilyInfoStepProps) {
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        updateData({ [e.target.name]: e.target.value });
    };

    const renderParentSection = (parentType: "Father" | "Mother") => {
        const prefix = parentType.toLowerCase();
        return (
            <div className="space-y-4 border p-4 rounded-lg bg-muted/10">
                <h3 className="text-lg font-semibold text-primary">{parentType}&apos;s Biodata</h3>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Surname</label>
                        <input
                            name={`${prefix}Surname`}
                            value={data[`${prefix}Surname`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">First Name</label>
                        <input
                            name={`${prefix}FirstName`}
                            value={data[`${prefix}FirstName`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Middle Name</label>
                        <input
                            name={`${prefix}MiddleName`}
                            value={data[`${prefix}MiddleName`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="space-y-2">
                    <label className="text-sm font-medium">Residential Address</label>
                    <input
                        name={`${prefix}Address`}
                        value={data[`${prefix}Address`] || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Telephone Number</label>
                        <input
                            name={`${prefix}Phone`}
                            value={data[`${prefix}Phone`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">State of Origin</label>
                        <input
                            name={`${prefix}State`}
                            value={data[`${prefix}State`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">LGA</label>
                        <input
                            name={`${prefix}Lga`}
                            value={data[`${prefix}Lga`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Town</label>
                        <input
                            name={`${prefix}Town`}
                            value={data[`${prefix}Town`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Occupation</label>
                        <input
                            name={`${prefix}Occupation`}
                            value={data[`${prefix}Occupation`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Employer</label>
                        <input
                            name={`${prefix}Employer`}
                            value={data[`${prefix}Employer`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Salary Grade</label>
                        <input
                            name={`${prefix}SalaryGrade`}
                            value={data[`${prefix}SalaryGrade`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Estimated Annual Income</label>
                        <input
                            name={`${prefix}Income`}
                            value={data[`${prefix}Income`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>

                <div className="space-y-2">
                    <label className="text-sm font-medium">Outstanding Obligations (if any)</label>
                    <textarea
                        name={`${prefix}Obligations`}
                        value={data[`${prefix}Obligations`] || ""}
                        onChange={handleChange}
                        className="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        placeholder="List any outstanding obligations..."
                    />
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Name of Spouse</label>
                        <input
                            name={`${prefix}Spouse`}
                            value={data[`${prefix}Spouse`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Number of Children</label>
                        <input
                            name={`${prefix}NumChildren`}
                            value={data[`${prefix}NumChildren`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Ages of Children</label>
                        <input
                            name={`${prefix}ChildrenAges`}
                            value={data[`${prefix}ChildrenAges`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                            placeholder="e.g. 5, 8, 12"
                        />
                    </div>
                </div>

                <h4 className="text-sm font-semibold mt-4 text-muted-foreground">Church Service</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Years Served</label>
                        <input
                            name={`${prefix}YearsServed`}
                            value={data[`${prefix}YearsServed`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-sm font-medium">Current Position</label>
                        <input
                            name={`${prefix}ChurchPosition`}
                            value={data[`${prefix}ChurchPosition`] || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                    <div className="col-span-2 space-y-2">
                        <label className="text-sm font-medium">Duties/Roles</label>
                        <textarea
                            name={`${prefix}ChurchDuties`}
                            value={data[`${prefix}ChurchDuties`] || ""}
                            onChange={handleChange}
                            className="flex min-h-[60px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                        />
                    </div>
                </div>
            </div>
        );
    };

    return (
        <div className="space-y-8 animate-fade-in">
            <h2 className="text-xl font-semibold mb-4">Family Information</h2>
            {renderParentSection("Father")}
            {renderParentSection("Mother")}
        </div>
    );
}
</file>

<file path="src/components/apply/PersonalInfoStep.tsx">
interface PersonalInfoStepProps {
    updateData: (data: any) => void;
    data: any;
}

export function PersonalInfoStep({ updateData, data }: PersonalInfoStepProps) {
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        updateData({ [e.target.name]: e.target.value });
    };

    return (
        <div className="space-y-6 animate-fade-in">
            <div className="text-center border-b pb-4 mb-6">
                <h2 className="text-xl font-bold text-primary">NORTHERN STATES FCT ZONAL HEADQUARTERS</h2>
                <h3 className="text-lg font-semibold">CENTRAL PARISH AREA 10 GARKI ABUJA</h3>
                <h4 className="text-md font-medium text-muted-foreground">EDUCATIONAL TRUST FUND SCHOLARSHIP APPLICATION FORM</h4>
            </div>

            <h2 className="text-xl font-semibold mb-4">Child&apos;s Personal Information</h2>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">Surname</label>
                    <input
                        name="surname"
                        value={data.surname || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">First Name</label>
                    <input
                        name="firstName"
                        value={data.firstName || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Middle Name</label>
                    <input
                        name="middleName"
                        value={data.middleName || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">Age</label>
                    <input
                        name="age"
                        type="number"
                        value={data.age || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Date of Birth</label>
                    <input
                        name="dob"
                        type="date"
                        value={data.dob || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Sex</label>
                    <select
                        name="sex"
                        value={data.sex || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    >
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">State of Origin</label>
                    <input
                        name="stateOrigin"
                        value={data.stateOrigin || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Local Government</label>
                    <input
                        name="lga"
                        value={data.lga || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-sm font-medium">Town</label>
                    <input
                        name="town"
                        value={data.town || ""}
                        onChange={handleChange}
                        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    />
                </div>
            </div>

            <div className="space-y-4 border-t pt-4">
                <div className="space-y-2">
                    <label className="text-sm font-medium">Have you been granted a CCC ETF Scholarship before?</label>
                    <div className="flex gap-4">
                        <label className="flex items-center gap-2">
                            <input
                                type="radio"
                                name="prevScholarship"
                                value="Yes"
                                checked={data.prevScholarship === "Yes"}
                                onChange={handleChange}
                            />
                            Yes
                        </label>
                        <label className="flex items-center gap-2">
                            <input
                                type="radio"
                                name="prevScholarship"
                                value="No"
                                checked={data.prevScholarship === "No"}
                                onChange={handleChange}
                            />
                            No
                        </label>
                    </div>
                </div>
                {data.prevScholarship === "Yes" && (
                    <div className="space-y-2">
                        <label className="text-sm font-medium">If yes, when?</label>
                        <input
                            name="prevScholarshipDate"
                            value={data.prevScholarshipDate || ""}
                            onChange={handleChange}
                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                            placeholder="e.g. 2023"
                        />
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/layout/UserNav.tsx">
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createClient } from "@/lib/supabase/client";
import { User, AuthChangeEvent, Session } from "@supabase/supabase-js";
import { LogOut, LayoutDashboard, Loader2 } from "lucide-react";

export function UserNav() {
    const [user, setUser] = useState<User | null>(null);
    const [loading, setLoading] = useState(true);
    const router = useRouter();
    const supabase = createClient();

    useEffect(() => {
        const getUser = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session?.user) {
                setUser(session.user);
            } else {
                setUser(null);
            }
            setLoading(false);
        };

        getUser();

        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event: AuthChangeEvent, session: Session | null) => {
            setUser(session?.user ?? null);
            setLoading(false);
            router.refresh(); // Refresh server components when auth state changes
        });

        return () => {
            subscription.unsubscribe();
        };
    }, [supabase, router]);

    const handleSignOut = async () => {
        setLoading(true);
        await supabase.auth.signOut();
        router.push("/");
        router.refresh();
    };

    if (loading) {
        return <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />;
    }

    if (user) {
        return (
            <div className="flex items-center gap-4">
                <div className="hidden md:flex flex-col items-end">
                    <span className="text-sm font-medium">{user.user_metadata?.name || user.email}</span>
                    <span className="text-xs text-muted-foreground capitalize">{user.user_metadata?.role || 'User'}</span>
                </div>

                <div className="flex items-center gap-2">
                    <Link
                        href={user.user_metadata?.role === 'SuperAdmin' || user.user_metadata?.role === 'Admin' ? "/admin/dashboard" : "/dashboard"}
                        className="inline-flex h-9 items-center justify-center rounded-md border border-input bg-background px-3 text-sm font-medium shadow-sm transition-colors hover:bg-accent hover:text-accent-foreground"
                        title="Dashboard"
                    >
                        <LayoutDashboard className="h-4 w-4 mr-2" />
                        <span className="hidden sm:inline">Dashboard</span>
                    </Link>

                    <button
                        onClick={handleSignOut}
                        className="inline-flex h-9 items-center justify-center rounded-md bg-destructive/10 px-3 text-sm font-medium text-destructive shadow-sm transition-colors hover:bg-destructive/20"
                        title="Sign Out"
                    >
                        <LogOut className="h-4 w-4 mr-2" />
                        <span className="hidden sm:inline">Sign Out</span>
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="flex items-center gap-4">
            <Link
                href="/login"
                className="text-sm font-medium hover:text-primary transition-colors"
            >
                Log In
            </Link>
            <Link
                href="/register"
                className="inline-flex h-9 items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90"
            >
                Get Started
            </Link>
        </div>
    );
}
</file>

<file path="src/lib/supabase.ts">
import { createClient as createRobustClient } from "@/lib/supabase/client";

export const createClient = () => createRobustClient();
</file>

<file path="src/lib/supabase/server.ts">
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { Database } from '@/types/supabase'

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient<Database>(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        )
                    } catch {
                        // The `setAll` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="src/middleware.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { NextResponse, type NextRequest } from "next/server";

export async function middleware(request: NextRequest) {
    let response = NextResponse.next({
        request: {
            headers: request.headers,
        },
    });

    // Check for environment variables to prevent build-time crashes
    if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
        console.warn("Supabase environment variables missing in middleware");
        return response;
    }

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
        {
            cookies: {
                getAll() {
                    return request.cookies.getAll();
                },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) => {
                        request.cookies.set({ name, value, ...options });
                        response = NextResponse.next({
                            request: {
                                headers: request.headers,
                            },
                        });
                        response.cookies.set({ name, value, ...options });
                    });
                },
            },
        }
    );

    const {
        data: { session },
    } = await supabase.auth.getSession();

    // Protect admin routes
    if (request.nextUrl.pathname.startsWith("/admin")) {
        // Exclude /admin/login from protection
        if (request.nextUrl.pathname === "/admin/login") {
            // Optional: If already logged in, redirect to admin dashboard
            if (session) {
                return NextResponse.redirect(new URL("/admin/applications", request.url));
            }
            return response;
        }

        if (!session) {
            return NextResponse.redirect(new URL("/admin/login", request.url));
        }

        // Optional: Check if user is actually an admin using Supabase RPC or metadata if available in session
        // For now, simple auth check is better than nothing, role check happens in page/layout/api
    }

    return response;
}

export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * - public folder
         */
        "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
    ],
};
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "baseUrl": "."
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="prisma/schema.prisma">
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Applicant {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Personal Info
  surname       String
  firstName     String
  middleName    String?
  age           Int
  dob           DateTime
  sex           String
  stateOrigin   String
  lga           String
  town          String
  address       String
  phone         String
  email         String?  @unique // Optional for children, but good for contact
  parish        String   @default("Central Cathedral Abuja")

  // Previous Scholarship
  prevScholarship     Boolean @default(false)
  prevScholarshipDate String?

  // Relations
  applications Application[]
  familyInfo   FamilyInfo?
}

model FamilyInfo {
  id          String    @id @default(uuid())
  applicantId String    @unique
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  // Father
  fatherSurname       String?
  fatherFirstName     String?
  fatherMiddleName    String?
  fatherAddress       String?
  fatherPhone         String?
  fatherState         String?
  fatherLga           String?
  fatherTown          String?
  fatherOccupation    String?
  fatherEmployer      String?
  fatherSalaryGrade   String?
  fatherIncome        String?
  fatherObligations   String?
  fatherSpouse        String?
  fatherNumChildren   Int?
  fatherChildrenAges  String?
  fatherYearsServed   String?
  fatherChurchPosition String?
  fatherChurchDuties  String?

  // Mother
  motherSurname       String?
  motherFirstName     String?
  motherMiddleName    String?
  motherAddress       String?
  motherPhone         String?
  motherState         String?
  motherLga           String?
  motherTown          String?
  motherOccupation    String?
  motherEmployer      String?
  motherSalaryGrade   String?
  motherIncome        String?
  motherObligations   String?
  motherSpouse        String?
  motherNumChildren   Int?
  motherChildrenAges  String?
  motherYearsServed   String?
  motherChurchPosition String?
  motherChurchDuties  String?
}

model Application {
  id          String    @id @default(uuid())
  applicantId String
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  status      String    @default("Pending") // Pending, Under Review, Approved, Rejected, Disbursed

  // Academic Info (Snapshot for this application)
  schoolName      String
  schoolAddress   String
  presentClass    String
  classPosition   String?
  classSize       Int?
  schoolFees      String
  textBooksCost   String?
  enoughBooks     Boolean @default(false)
  libraryAccess   Boolean @default(false)
  sentAway        Boolean @default(false)
  repeatedClass   Boolean @default(false)
  lastResult      String? // CGPA or Average

  // Documents (URLs or paths)
  schoolBillUrl       String?
  birthCertUrl        String?
  primaryCertUrl      String?
  schoolResultUrl     String?
  assistanceLetterUrl String?
  admissionLetterUrl  String?
  passportUrl         String?

  // Admin/Screening
  scoreFinancial    Int?
  scoreAcademic     Int?
  scoreChurch       Int?
  committeeNotes    String?
  approvedAmount  String?
  voucherCode     String?
  disbursedDate   DateTime?
  paymentReference String?

  assessments     Assessment[] // Relation to assessments
}

model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      String   @default("Admin") // Admin, SuperAdmin, Committee
  status    String   @default("Pending") // Pending, Approved, Rejected
  assessments Assessment[]
  createdAt DateTime @default(now())
}

model Assessment {
  id            String    @id @default(uuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  adminUserId   String
  adminUser     AdminUser @relation(fields: [adminUserId], references: [id])
  
  // Scores
  financialScore Int      @default(0)
  academicScore  Int      @default(0)
  churchScore    Int      @default(0)
  totalScore     Int      @default(0)
  
  notes          String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([applicationId, adminUserId]) // One assessment per admin per application
}

model Budget {
  id          String   @id @default(uuid())
  year        Int
  quarter     Int?     // 1, 2, 3, 4 or null for annual
  category    String   // Scholarships, Operations, Events, etc.
  allocated   Decimal  @db.Decimal(12, 2)
  spent       Decimal  @db.Decimal(12, 2) @default(0)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactions Transaction[]

  @@unique([year, quarter, category])
}

model Transaction {
  id            String   @id @default(uuid())
  budgetId      String?
  budget        Budget?  @relation(fields: [budgetId], references: [id])
  type          String   // Income, Expense, Transfer
  category      String   // Donation, Scholarship, Operations, etc.
  amount        Decimal  @db.Decimal(12, 2)
  description   String
  reference     String?  // Invoice number, receipt number, etc.
  date          DateTime
  createdBy     String?  // Admin user email
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  donation      Donation?
}

model Donation {
  id              String   @id @default(uuid())
  transactionId   String   @unique
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  donorName       String
  donorEmail      String?
  donorPhone      String?
  donorAddress    String?
  donationType    String   // One-time, Monthly, Annual
  isAnonymous     Boolean  @default(false)
  purpose         String?  // General, Scholarship, Infrastructure, etc.
  receiptIssued   Boolean  @default(false)
  receiptNumber   String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
</file>

<file path="src/app/admin/(dashboard)/finance/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { DollarSign, TrendingUp, TrendingDown, Plus, X, Wallet, PieChart, Calendar } from "lucide-react";

import { FinanceResponse, ApiResponse } from "@/types";

export default function FinancePage() {
    const [financeData, setFinanceData] = useState<FinanceResponse | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
    const [showModal, setShowModal] = useState(false);
    const [modalType, setModalType] = useState<'budget' | 'transaction'>('budget');
    const [formData, setFormData] = useState<{
        year?: number;
        quarter?: number | null;
        category?: string;
        allocated?: string;
        description?: string;
        transactionType?: string;
        budgetId?: string;
        amount?: string;
        date?: string;
        reference?: string;
    }>({});

    useEffect(() => {
        fetchFinanceData();
    }, [selectedYear]);

    const fetchFinanceData = async () => {
        setIsLoading(true);
        try {
            const response = await fetch(`/api/admin/finance?year=${selectedYear}`);
            const result: ApiResponse<FinanceResponse> = await response.json();
            if (result.success && result.data) {
                setFinanceData(result.data);
            }
        } catch (error) {
            console.error("Error fetching finance data:", error);
        } finally {
            setIsLoading(false);
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        try {
            const response = await fetch('/api/admin/finance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: modalType, ...formData })
            });
            const result = await response.json();
            if (result.success) {
                setShowModal(false);
                setFormData({});
                fetchFinanceData();
            }
        } catch (error) {
            console.error("Error submitting:", error);
        }
    };

    if (isLoading) {
        return <div className="flex items-center justify-center h-64">Loading financial data...</div>;
    }

    if (!financeData) {
        return <div className="flex items-center justify-center h-64">No data available</div>;
    }

    const { summary, budgets, transactions } = financeData;

    return (
        <div className="space-y-8 animate-fade-in">
            {/* Header */}
            <div className="flex justify-between items-center">
                <div>
                    <h2 className="text-3xl font-bold tracking-tight">Financial Management</h2>
                    <p className="text-muted-foreground">Track budgets, expenses, and income</p>
                </div>
                <div className="flex gap-3">
                    <select
                        value={selectedYear}
                        onChange={(e) => setSelectedYear(e.target.value)}
                        className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium"
                    >
                        {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i).map(year => (
                            <option key={year} value={year}>{year}</option>
                        ))}
                    </select>
                    <button
                        onClick={() => { setModalType('budget'); setShowModal(true); }}
                        className="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 flex items-center gap-2"
                    >
                        <Plus className="h-4 w-4" />
                        Add Budget
                    </button>
                    <button
                        onClick={() => { setModalType('transaction'); setShowModal(true); }}
                        className="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90 flex items-center gap-2"
                    >
                        <Plus className="h-4 w-4" />
                        Add Transaction
                    </button>
                </div>
            </div>

            {/* Summary Cards */}
            <div className="grid gap-6 md:grid-cols-4">
                <div className="relative p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <Wallet className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{summary.totalBudget.toLocaleString()}</div>
                        <div className="text-sm opacity-90">Total Budget</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <TrendingUp className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{summary.totalIncome.toLocaleString()}</div>
                        <div className="text-sm opacity-90">Total Income</div>
                    </div>
                </div>

                <div className="relative p-6 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <TrendingDown className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{summary.totalExpenses.toLocaleString()}</div>
                        <div className="text-sm opacity-90">Total Expenses</div>
                    </div>
                </div>

                <div className={`relative p-6 bg-gradient-to-br ${summary.balance >= 0 ? 'from-emerald-500 to-emerald-600' : 'from-orange-500 to-orange-600'} text-white rounded-2xl shadow-lg overflow-hidden`}>
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl" />
                    <div className="relative">
                        <div className="flex items-center justify-between mb-2">
                            <DollarSign className="h-8 w-8 opacity-80" />
                        </div>
                        <div className="text-3xl font-bold mb-1">₦{summary.balance.toLocaleString()}</div>
                        <div className="text-sm opacity-90">Net Balance</div>
                    </div>
                </div>
            </div>

            {/* Budgets Section */}
            <div className="bg-card border rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                    <PieChart className="h-5 w-5 text-primary" />
                    Budget Allocation
                </h3>
                <div className="space-y-4">
                    {budgets.length === 0 ? (
                        <p className="text-muted-foreground text-center py-8">No budgets created for {selectedYear}</p>
                    ) : (
                        budgets.map((budget) => {
                            const utilization = Number(budget.allocated) > 0
                                ? (Number(budget.spent) / Number(budget.allocated)) * 100
                                : 0;
                            const isOverBudget = utilization > 100;

                            return (
                                <div key={budget.id} className="border rounded-lg p-4">
                                    <div className="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 className="font-semibold">{budget.category}</h4>
                                            {budget.description && (
                                                <p className="text-sm text-muted-foreground">{budget.description}</p>
                                            )}
                                            {budget.quarter && (
                                                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mt-1 inline-block">
                                                    Q{budget.quarter}
                                                </span>
                                            )}
                                        </div>
                                        <div className="text-right">
                                            <div className="text-sm text-muted-foreground">
                                                ₦{Number(budget.spent).toLocaleString()} / ₦{Number(budget.allocated).toLocaleString()}
                                            </div>
                                            <div className={`text-sm font-semibold ${isOverBudget ? 'text-red-600' : 'text-green-600'}`}>
                                                {utilization.toFixed(1)}% used
                                            </div>
                                        </div>
                                    </div>
                                    <div className="h-2 bg-muted rounded-full overflow-hidden">
                                        <div
                                            className={`h-full transition-all duration-500 ${isOverBudget ? 'bg-red-500' : 'bg-green-500'}`}
                                            style={{ width: `${Math.min(utilization, 100)}%` }}
                                        />
                                    </div>
                                </div>
                            );
                        })
                    )}
                </div>
            </div>

            {/* Recent Transactions */}
            <div className="bg-card border rounded-2xl p-6 shadow-sm">
                <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                    <Calendar className="h-5 w-5 text-primary" />
                    Recent Transactions
                </h3>
                <div className="overflow-x-auto">
                    <table className="w-full">
                        <thead>
                            <tr className="border-b">
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Date</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Type</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Category</th>
                                <th className="text-left py-3 px-4 font-medium text-muted-foreground">Description</th>
                                <th className="text-right py-3 px-4 font-medium text-muted-foreground">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {transactions.length === 0 ? (
                                <tr>
                                    <td colSpan={5} className="text-center py-8 text-muted-foreground">
                                        No transactions recorded
                                    </td>
                                </tr>
                            ) : (
                                transactions.slice(0, 20).map((transaction) => (
                                    <tr key={transaction.id} className="border-b last:border-0 hover:bg-muted/50 transition-colors">
                                        <td className="py-3 px-4 text-sm">
                                            {new Date(transaction.date).toLocaleDateString()}
                                        </td>
                                        <td className="py-3 px-4">
                                            <span className={`text-xs px-2 py-1 rounded ${transaction.type === 'Income' ? 'bg-green-100 text-green-800' :
                                                transaction.type === 'Expense' ? 'bg-red-100 text-red-800' :
                                                    'bg-blue-100 text-blue-800'
                                                }`}>
                                                {transaction.type}
                                            </span>
                                        </td>
                                        <td className="py-3 px-4 text-sm">{transaction.category}</td>
                                        <td className="py-3 px-4 text-sm">{transaction.description}</td>
                                        <td className={`py-3 px-4 text-right font-semibold ${transaction.type === 'Income' ? 'text-green-600' : 'text-red-600'
                                            }`}>
                                            {transaction.type === 'Income' ? '+' : '-'}₦{Number(transaction.amount).toLocaleString()}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* Modal */}
            {showModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-card rounded-lg p-6 w-full max-w-md shadow-xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold">
                                {modalType === 'budget' ? 'Create Budget' : 'Add Transaction'}
                            </h3>
                            <button onClick={() => setShowModal(false)} className="text-muted-foreground hover:text-foreground">
                                <X className="h-5 w-5" />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {modalType === 'budget' ? (
                                <>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Year</label>
                                        <input
                                            type="number"
                                            value={formData.year || selectedYear}
                                            onChange={(e) => setFormData({ ...formData, year: parseInt(e.target.value) })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Quarter (Optional)</label>
                                        <select
                                            value={formData.quarter || ''}
                                            onChange={(e) => setFormData({ ...formData, quarter: e.target.value ? parseInt(e.target.value) : null })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                        >
                                            <option value="">Annual</option>
                                            <option value="1">Q1</option>
                                            <option value="2">Q2</option>
                                            <option value="3">Q3</option>
                                            <option value="4">Q4</option>
                                        </select>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Category</label>
                                        <input
                                            type="text"
                                            value={formData.category || ''}
                                            onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            placeholder="e.g., Scholarships"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Allocated Amount</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.allocated || ''}
                                            onChange={(e) => setFormData({ ...formData, allocated: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Description (Optional)</label>
                                        <textarea
                                            value={formData.description || ''}
                                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                            className="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                        />
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Type</label>
                                        <select
                                            value={formData.transactionType || 'Expense'}
                                            onChange={(e) => setFormData({ ...formData, transactionType: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            required
                                        >
                                            <option value="Income">Income</option>
                                            <option value="Expense">Expense</option>
                                            <option value="Transfer">Transfer</option>
                                        </select>
                                    </div>

                                    {(formData.transactionType === 'Expense' || !formData.transactionType) && (
                                        <div className="space-y-2">
                                            <label className="text-sm font-medium">Link to Budget (Optional)</label>
                                            <select
                                                value={formData.budgetId || ''}
                                                onChange={(e) => setFormData({ ...formData, budgetId: e.target.value })}
                                                className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            >
                                                <option value="">Select a Budget</option>
                                                {budgets.map((b) => (
                                                    <option key={b.id} value={b.id}>
                                                        {b.category} {b.quarter ? `(Q${b.quarter})` : '(Annual)'} - ₦{Number(b.allocated).toLocaleString()}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}

                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Category</label>
                                        <input
                                            type="text"
                                            value={formData.category || ''}
                                            onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            placeholder="e.g., Donation, Scholarship"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Amount</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.amount || ''}
                                            onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Description</label>
                                        <input
                                            type="text"
                                            value={formData.description || ''}
                                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Date</label>
                                        <input
                                            type="date"
                                            value={formData.date || new Date().toISOString().split('T')[0]}
                                            onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            required
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium">Reference (Optional)</label>
                                        <input
                                            type="text"
                                            value={formData.reference || ''}
                                            onChange={(e) => setFormData({ ...formData, reference: e.target.value })}
                                            className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                                            placeholder="Invoice/Receipt number"
                                        />
                                    </div>
                                </>
                            )}
                            <div className="flex gap-2 justify-end pt-4">
                                <button
                                    type="button"
                                    onClick={() => setShowModal(false)}
                                    className="px-4 py-2 border border-input bg-background rounded-md text-sm font-medium hover:bg-accent"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:bg-primary/90"
                                >
                                    {modalType === 'budget' ? 'Create Budget' : 'Add Transaction'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/admin/login/page.tsx">
"use client";

export const dynamic = "force-dynamic";

import { useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { Loader2, ShieldCheck } from "lucide-react";
import { createClient } from "@/lib/supabase/client";

export default function AdminLoginPage() {
    const router = useRouter();
    const [isLoading, setIsLoading] = useState(false);
    const [email, setEmail] = useState("");
    const [password, setPassword] = useState("");
    const [error, setError] = useState<string | null>(null);
    const supabase = createClient();

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        setError(null);

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                setError(error.message);
                return;
            }

            // Check if user is approved
            const statusResponse = await fetch("/api/admin/users/check-status");
            const statusData = await statusResponse.json();

            if (!statusResponse.ok || !statusData.approved) {
                // Sign out the user
                await supabase.auth.signOut();

                if (statusData.status === "Pending") {
                    setError("Your account is pending approval by a Super Admin. Please wait for confirmation.");
                } else if (statusData.status === "Rejected") {
                    setError("Your account registration has been rejected. Please contact support.");
                } else {
                    setError("You are not authorized to access this portal.");
                }
                return;
            }

            router.push("/admin/applications");
            router.refresh();
        } catch (err) {
            setError("An unexpected error occurred");
            console.error(err);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="container flex h-screen w-screen flex-col items-center justify-center bg-muted/20">
            <div className="mx-auto flex w-full flex-col justify-center space-y-6 sm:w-[350px]">
                <div className="flex flex-col space-y-2 text-center items-center">
                    <div className="h-12 w-12 bg-primary/10 rounded-full flex items-center justify-center mb-2">
                        <ShieldCheck className="h-6 w-6 text-primary" />
                    </div>
                    <h1 className="text-2xl font-semibold tracking-tight">Committee Access</h1>
                    <p className="text-sm text-muted-foreground">
                        Authorized personnel only. Please sign in.
                    </p>
                </div>
                <div className="grid gap-6 bg-card p-6 border rounded-lg shadow-sm">
                    <form onSubmit={handleLogin}>
                        <div className="grid gap-4">
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="email">
                                    Official Email
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="email"
                                    placeholder="committee@ccchet.org"
                                    type="email"
                                    autoCapitalize="none"
                                    autoComplete="email"
                                    autoCorrect="off"
                                    disabled={isLoading}
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                />
                            </div>
                            <div className="grid gap-2">
                                <label className="text-sm font-medium leading-none" htmlFor="password">
                                    Password
                                </label>
                                <input
                                    className="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                                    id="password"
                                    type="password"
                                    disabled={isLoading}
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                />
                            </div>
                            {error && (
                                <div className="text-sm text-red-500 text-center">
                                    {error}
                                </div>
                            )}
                            <button
                                className="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2"
                                disabled={isLoading}
                            >
                                {isLoading && (
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                )}
                                Access Dashboard
                            </button>
                        </div>
                    </form>
                </div>
                <div className="text-center text-sm text-muted-foreground">
                    <Link href="/" className="hover:text-primary underline underline-offset-4">
                        Return to Public Portal
                    </Link>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/users/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { Shield, UserPlus, Edit2, Trash2, Loader2, CheckCircle, XCircle } from "lucide-react";

interface AdminUser {
    id: string;
    email: string;
    name: string | null;
    role: string;
    status: string;
    createdAt: string;
    isActive: boolean;
    lastSignIn: string | null;
}

export default function AdminUsersPage() {
    const [users, setUsers] = useState<AdminUser[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [selectedUser, setSelectedUser] = useState<AdminUser | null>(null);
    const [error, setError] = useState<string | null>(null);
    const [success, setSuccess] = useState<string | null>(null);
    const [filter, setFilter] = useState<"all" | "pending" | "approved">("all");

    // Form states
    const [formData, setFormData] = useState({
        email: "",
        name: "",
        role: "Admin",
        password: "",
    });

    useEffect(() => {
        fetchUsers();
    }, []);

    const fetchUsers = async () => {
        try {
            setIsLoading(true);
            const response = await fetch("/api/admin/users");

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || "Failed to fetch users");
            }

            const data = await response.json();
            setUsers(data.users);
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        } finally {
            setIsLoading(false);
        }
    };

    const handleCreateUser = async (e: React.FormEvent) => {
        e.preventDefault();
        setError(null);
        setSuccess(null);

        try {
            const response = await fetch("/api/admin/users", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Failed to create user");
            }

            setSuccess("Committee member created successfully!");
            setShowCreateModal(false);
            setFormData({ email: "", name: "", role: "Admin", password: "" });
            fetchUsers();
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        }
    };

    const handleUpdateUser = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!selectedUser) return;

        setError(null);
        setSuccess(null);

        try {
            const response = await fetch("/api/admin/users", {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: selectedUser.id,
                    name: formData.name,
                    role: formData.role,
                }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Failed to update user");
            }

            setSuccess("Committee member updated successfully!");
            setShowEditModal(false);
            setSelectedUser(null);
            fetchUsers();
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        }
    };

    const handleDeleteUser = async (userId: string) => {
        if (!confirm("Are you sure you want to deactivate this committee member? This action cannot be undone.")) {
            return;
        }

        setError(null);
        setSuccess(null);

        try {
            const response = await fetch(`/api/admin/users?id=${userId}`, {
                method: "DELETE",
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Failed to delete user");
            }

            setSuccess("Committee member deactivated successfully!");
            fetchUsers();
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        }
    };

    const handleApproveUser = async (userId: string) => {
        setError(null);
        setSuccess(null);

        try {
            const response = await fetch("/api/admin/users", {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: userId, status: "Approved" }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Failed to approve user");
            }

            setSuccess("User approved successfully!");
            fetchUsers();
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        }
    };

    const handleRejectUser = async (userId: string) => {
        if (!confirm("Are you sure you want to reject this registration?")) {
            return;
        }

        setError(null);
        setSuccess(null);

        try {
            const response = await fetch("/api/admin/users", {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: userId, status: "Rejected" }),
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || "Failed to reject user");
            }

            setSuccess("User rejected successfully!");
            fetchUsers();
        } catch (err: unknown) {
            setError(err instanceof Error ? err.message : "An unknown error occurred");
        }
    };

    const openEditModal = (user: AdminUser) => {
        setSelectedUser(user);
        setFormData({
            email: user.email,
            name: user.name || "",
            role: user.role,
            password: "",
        });
        setShowEditModal(true);
    };

    return (
        <div className="p-6 space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold flex items-center gap-2">
                        <Shield className="h-8 w-8 text-primary" />
                        Committee Members
                    </h1>
                    <p className="text-muted-foreground mt-1">
                        Manage admin users and their access levels
                    </p>
                </div>
                <button
                    onClick={() => {
                        setFormData({ email: "", name: "", role: "Admin", password: "" });
                        setShowCreateModal(true);
                    }}
                    className="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
                >
                    <UserPlus className="h-4 w-4" />
                    Add Committee Member
                </button>
            </div>

            {/* Filter Tabs */}
            <div className="flex gap-2 border-b">
                <button
                    onClick={() => setFilter("all")}
                    className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${filter === "all"
                        ? "border-primary text-primary"
                        : "border-transparent text-muted-foreground hover:text-foreground"
                        }`}
                >
                    All Users ({users.length})
                </button>
                <button
                    onClick={() => setFilter("pending")}
                    className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${filter === "pending"
                        ? "border-primary text-primary"
                        : "border-transparent text-muted-foreground hover:text-foreground"
                        }`}
                >
                    Pending Approval ({users.filter(u => u.status === "Pending").length})
                </button>
                <button
                    onClick={() => setFilter("approved")}
                    className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${filter === "approved"
                        ? "border-primary text-primary"
                        : "border-transparent text-muted-foreground hover:text-foreground"
                        }`}
                >
                    Approved ({users.filter(u => u.status === "Approved").length})
                </button>
            </div>

            {/* Alerts */}
            {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md flex items-center gap-2">
                    <XCircle className="h-5 w-5" />
                    {error}
                </div>
            )}

            {success && (
                <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md flex items-center gap-2">
                    <CheckCircle className="h-5 w-5" />
                    {success}
                </div>
            )}

            {/* Users Table */}
            <div className="bg-card border rounded-lg shadow-sm overflow-hidden">
                {isLoading ? (
                    <div className="flex items-center justify-center py-12">
                        <Loader2 className="h-8 w-8 animate-spin text-primary" />
                    </div>
                ) : users.length === 0 ? (
                    <div className="text-center py-12 text-muted-foreground">
                        <Shield className="h-12 w-12 mx-auto mb-4 opacity-50" />
                        <p>No committee members found</p>
                    </div>
                ) : (
                    <table className="w-full">
                        <thead className="bg-muted/50 border-b">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    Name
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    Email
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    Role
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    Status
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    Last Sign In
                                </th>
                                <th className="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-border">
                            {users
                                .filter(user => {
                                    if (filter === "pending") return user.status === "Pending";
                                    if (filter === "approved") return user.status === "Approved";
                                    return true;
                                })
                                .map((user) => (
                                    <tr key={user.id} className="hover:bg-muted/20 transition-colors">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="font-medium">{user.name || "—"}</div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                                            {user.email}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span
                                                className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${user.role === "SuperAdmin"
                                                    ? "bg-purple-100 text-purple-800"
                                                    : "bg-blue-100 text-blue-800"
                                                    }`}
                                            >
                                                {user.role}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span
                                                className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${user.status === "Approved"
                                                        ? "bg-green-100 text-green-800"
                                                        : user.status === "Pending"
                                                            ? "bg-yellow-100 text-yellow-800"
                                                            : "bg-red-100 text-red-800"
                                                    }`}
                                            >
                                                {user.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                                            {user.lastSignIn
                                                ? new Date(user.lastSignIn).toLocaleDateString()
                                                : "Never"}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            {user.status === "Pending" ? (
                                                <div className="flex justify-end gap-2">
                                                    <button
                                                        onClick={() => handleApproveUser(user.id)}
                                                        className="text-green-600 hover:text-green-900 font-medium"
                                                    >
                                                        Approve
                                                    </button>
                                                    <button
                                                        onClick={() => handleRejectUser(user.id)}
                                                        className="text-red-600 hover:text-red-900 font-medium"
                                                    >
                                                        Reject
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="flex justify-end gap-2">
                                                    <button
                                                        onClick={() => openEditModal(user)}
                                                        className="text-blue-600 hover:text-blue-900 mr-4"
                                                    >
                                                        <Edit2 className="h-4 w-4" />
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteUser(user.id)}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        <Trash2 className="h-4 w-4" />
                                                    </button>
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                        </tbody>
                    </table>
                )}
            </div>

            {/* Create Modal */}
            {showCreateModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-card rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 className="text-2xl font-bold mb-4">Add Committee Member</h2>
                        <form onSubmit={handleCreateUser} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Name</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    placeholder="John Doe"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Email</label>
                                <input
                                    type="email"
                                    required
                                    value={formData.email}
                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    placeholder="john@cccabuja.org"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Password</label>
                                <input
                                    type="password"
                                    required
                                    minLength={8}
                                    value={formData.password}
                                    onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    placeholder="Min. 8 characters"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Role</label>
                                <select
                                    value={formData.role}
                                    onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                >
                                    <option value="Admin">Admin</option>
                                    <option value="SuperAdmin">SuperAdmin</option>
                                </select>
                            </div>
                            <div className="flex gap-2 pt-4">
                                <button
                                    type="button"
                                    onClick={() => setShowCreateModal(false)}
                                    className="flex-1 px-4 py-2 border rounded-md hover:bg-muted transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
                                >
                                    Create
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Edit Modal */}
            {showEditModal && selectedUser && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-card rounded-lg shadow-xl max-w-md w-full p-6">
                        <h2 className="text-2xl font-bold mb-4">Edit Committee Member</h2>
                        <form onSubmit={handleUpdateUser} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Email</label>
                                <input
                                    type="email"
                                    disabled
                                    value={formData.email}
                                    className="w-full px-3 py-2 border rounded-md bg-muted cursor-not-allowed"
                                />
                                <p className="text-xs text-muted-foreground mt-1">Email cannot be changed</p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Name</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Role</label>
                                <select
                                    value={formData.role}
                                    onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                >
                                    <option value="Admin">Admin</option>
                                    <option value="SuperAdmin">SuperAdmin</option>
                                </select>
                            </div>
                            <div className="flex gap-2 pt-4">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setShowEditModal(false);
                                        setSelectedUser(null);
                                    }}
                                    className="flex-1 px-4 py-2 border rounded-md hover:bg-muted transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
                                >
                                    Update
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/app/api/admin/applications/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
    try {
        const { searchParams } = new URL(request.url);
        const page = parseInt(searchParams.get("page") || "1");
        const limit = parseInt(searchParams.get("limit") || "10");
        const status = searchParams.get("status");
        const search = searchParams.get("search");

        const skip = (page - 1) * limit;

        const where: any = {};

        if (status && status !== "All") {
            where.status = status;
        }

        if (search) {
            where.OR = [
                { applicant: { firstName: { contains: search, mode: "insensitive" } } },
                { applicant: { surname: { contains: search, mode: "insensitive" } } },
                { schoolName: { contains: search, mode: "insensitive" } },
            ];
        }

        const [total, applications] = await Promise.all([
            prisma.application.count({ where }),
            prisma.application.findMany({
                where,
                include: {
                    applicant: {
                        select: {
                            firstName: true,
                            surname: true,
                            email: true,
                            phone: true,
                        }
                    }
                },
                orderBy: {
                    createdAt: 'desc'
                },
                skip,
                take: limit,
            })
        ]);

        return NextResponse.json({
            success: true,
            data: applications,
            meta: {
                total,
                page,
                limit,
                totalPages: Math.ceil(total / limit)
            }
        });
    } catch (error) {
        console.error("Error fetching applications:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch applications" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/apply/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { sendApplicantNotification, sendAdminNotification } from "@/lib/email";

export async function POST(request: Request) {
    try {
        const body = await request.json();

        // Destructure body to separate Applicant, Family, and Application data
        const {
            // Personal Info
            surname, firstName, middleName, age, dob, sex, stateOrigin, lga, town,
            // Contact
            address = "See Family Info", phone = "See Family Info", email,
            parish, // Allow parish to be passed, or default will be used
            prevScholarship, prevScholarshipDate,

            // Academic Info
            schoolName, schoolAddress, presentClass, classPosition, classSize,
            schoolFees, textBooksCost, enoughBooks, libraryAccess, sentAway, repeatedClass, lastResult,

            // Family Info
            fatherSurname, fatherFirstName, fatherMiddleName, fatherAddress, fatherPhone, fatherState, fatherLga, fatherTown,
            fatherOccupation, fatherEmployer, fatherSalaryGrade, fatherIncome, fatherObligations, fatherSpouse, fatherNumChildren, fatherChildrenAges,
            fatherYearsServed, fatherChurchPosition, fatherChurchDuties,

            motherSurname, motherFirstName, motherMiddleName, motherAddress, motherPhone, motherState, motherLga, motherTown,
            motherOccupation, motherEmployer, motherSalaryGrade, motherIncome, motherObligations, motherSpouse, motherNumChildren, motherChildrenAges,
            motherYearsServed, motherChurchPosition, motherChurchDuties,

            // Documents (keys match the frontend state)
            schoolFeesBill, birthCertificate, primaryCertificate, schoolResults, assistanceLetter
        } = body;

        // Basic validation
        if (!surname || !firstName || !dob || !schoolName) {
            return NextResponse.json({ success: false, error: "Missing required fields: surname, firstName, dob, or schoolName" }, { status: 400 });
        }

        // Validate Date
        const dateOfBirth = new Date(dob);
        if (isNaN(dateOfBirth.getTime())) {
            return NextResponse.json({ success: false, error: "Invalid Date of Birth format" }, { status: 400 });
        }

        // Helper to safe parse Int
        const safeInt = (val: any) => {
            if (!val || val === "") return null;
            const parsed = parseInt(val);
            return isNaN(parsed) ? null : parsed;
        };

        // Create Applicant with nested relations
        const applicant = await prisma.applicant.create({
            data: {
                surname: surname || "",
                firstName: firstName || "",
                middleName: middleName || "",
                age: safeInt(age) || 0,
                dob: dateOfBirth,
                sex: sex || "Not Specified",
                stateOrigin: stateOrigin || "",
                lga: lga || "",
                town: town || "",
                address: address || "",
                phone: phone || "",
                email: email === "" ? null : email, // Convert empty string to null to avoid unique constraint violations
                parish: parish || undefined, // undefined triggers default value
                prevScholarship: prevScholarship === "Yes",
                prevScholarshipDate: prevScholarshipDate || null,
                familyInfo: {
                    create: {
                        fatherSurname, fatherFirstName, fatherMiddleName, fatherAddress, fatherPhone, fatherState, fatherLga, fatherTown,
                        fatherOccupation, fatherEmployer, fatherSalaryGrade, fatherIncome, fatherObligations, fatherSpouse,
                        fatherNumChildren: safeInt(fatherNumChildren),
                        fatherChildrenAges, fatherYearsServed, fatherChurchPosition, fatherChurchDuties,

                        motherSurname, motherFirstName, motherMiddleName, motherAddress, motherPhone, motherState, motherLga, motherTown,
                        motherOccupation, motherEmployer, motherSalaryGrade, motherIncome, motherObligations, motherSpouse,
                        motherNumChildren: safeInt(motherNumChildren),
                        motherChildrenAges, motherYearsServed, motherChurchPosition, motherChurchDuties,
                    }
                },
                applications: {
                    create: {
                        schoolName: schoolName || "",
                        schoolAddress: schoolAddress || "",
                        presentClass: presentClass || "",
                        classPosition,
                        classSize: safeInt(classSize),
                        schoolFees: schoolFees || "0",
                        textBooksCost,
                        enoughBooks: enoughBooks === "Yes",
                        libraryAccess: libraryAccess === "Yes",
                        sentAway: sentAway === "Yes",
                        repeatedClass: repeatedClass === "Yes",
                        lastResult,
                        // Map frontend document keys to schema fields
                        schoolBillUrl: schoolFeesBill,
                        birthCertUrl: birthCertificate,
                        primaryCertUrl: primaryCertificate,
                        schoolResultUrl: schoolResults,
                        assistanceLetterUrl: assistanceLetter,
                    }
                }
            }
        });

        // Send notifications
        if (email) {
            await sendApplicantNotification(email, `${firstName} ${surname}`, applicant.id);
        }
        await sendAdminNotification(`${firstName} ${surname}`, applicant.id);

        return NextResponse.json({ success: true, applicantId: applicant.id });
    } catch (error: any) {
        console.error("Error submitting application:", error);
        // Clean up prisma error message for client if possible, or just return it
        const errorMessage = error.message || "Failed to submit application";
        return NextResponse.json({ success: false, error: errorMessage }, { status: 500 });
    }
}
</file>

<file path="src/app/api/dashboard/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { createClient } from "@/lib/supabase/server";

export async function GET() {
    try {
        const supabase = await createClient();
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ success: false, error: "Unauthorized" }, { status: 401 });
        }

        // Find applicant by email
        const applicant = await prisma.applicant.findUnique({
            where: { email: session.user.email },
            include: {
                applications: {
                    orderBy: {
                        createdAt: 'desc'
                    }
                }
            }
        });

        if (!applicant) {
            return NextResponse.json({ success: true, data: null });
        }

        return NextResponse.json({ success: true, data: applicant });
    } catch (error) {
        console.error("Error fetching user dashboard:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch dashboard data" }, { status: 500 });
    }
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from "next";
// import { Outfit } from "next/font/google";
import "./globals.css";
import { cn } from "@/lib/utils";

// const outfit = Outfit({
//   subsets: ["latin"],
//   variable: "--font-outfit",
// });

export const metadata: Metadata = {
  title: "CCC Central Cathedral Abuja - ETF",
  description: "Education Trust Fund Portal",
};

import { Header } from "@/components/layout/Header";
import { Footer } from "@/components/layout/Footer";

// ... imports ...

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={cn(
          "min-h-screen bg-background font-sans antialiased flex flex-col"
          // outfit.variable
        )}
      >
        <Header />
        <main className="flex-1">{children}</main>
        <Footer />
      </body>
    </html>
  );
}
</file>

<file path="src/components/layout/Header.tsx">
import Link from "next/link";
import { UserNav } from "./UserNav";

export function Header() {
    return (
        <header className="sticky top-0 z-50 w-full border-b bg-background/80 backdrop-blur-md">
            <div className="container mx-auto flex h-16 items-center justify-between px-4">
                <Link href="/" className="flex items-center gap-2">
                    <span className="text-xl font-bold text-primary">CCC ETF</span>
                </Link>
                <nav className="hidden md:flex items-center gap-6">
                    <Link href="/" className="text-sm font-medium hover:text-primary transition-colors">
                        Home
                    </Link>
                    <Link href="/about" className="text-sm font-medium hover:text-primary transition-colors">
                        About
                    </Link>
                    <Link href="/apply" className="text-sm font-medium hover:text-primary transition-colors">
                        Apply
                    </Link>
                    <Link href="/admin/login" className="text-sm font-medium hover:text-primary transition-colors">
                        Committee
                    </Link>
                </nav>
                <UserNav />
            </div>
        </header>
    );
}
</file>

<file path="src/lib/email.ts">
import { Resend } from 'resend';

// Lazy initialize to avoid build-time errors
let resend: Resend | null = null;

function getResendClient() {
    if (!resend && process.env.RESEND_API_KEY) {
        resend = new Resend(process.env.RESEND_API_KEY);
    }
    return resend;
}

export async function sendApplicantNotification(email: string, name: string, applicationId: string) {
    if (!process.env.RESEND_API_KEY) {
        console.warn("RESEND_API_KEY is not set. Email not sent.");
        return;
    }

    const client = getResendClient();
    if (!client) return;

    try {
        await client.emails.send({
            from: 'Antigrav ETF <onboarding@resend.dev>', // Default Resend testing domain
            to: email,
            subject: 'Application Received - Antigrav ETF',
            html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #0f172a;">Application Received</h1>
            <p>Dear ${name},</p>
            <p>We have successfully received your scholarship application.</p>
            <div style="background-color: #f1f5f9; padding: 16px; border-radius: 8px; margin: 20px 0;">
                <p style="margin: 0; font-weight: bold;">Application ID: ${applicationId}</p>
            </div>
            <p>Our committee will review your submission and verify your documents. We will contact you regarding the next steps.</p>
            <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;" />
            <p style="color: #64748b; font-size: 14px;">Best regards,<br/>Antigrav ETF Team</p>
        </div>
      `
        });
    } catch (error) {
        console.error("Failed to send applicant email:", error);
    }
}

export async function sendAdminNotification(applicantName: string, applicationId: string) {
    if (!process.env.RESEND_API_KEY) {
        console.warn("RESEND_API_KEY is not set. Email not sent.");
        return;
    }

    try {
        // Default to the known admin email if not specified in env
        const adminEmail = process.env.ADMIN_EMAIL || 'akin4u@gmail.com';
        const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
        const client = getResendClient();
        if (!client) return;

        await client.emails.send({
            from: 'Antigrav ETF <onboarding@resend.dev>',
            to: adminEmail,
            subject: `New Application: ${applicantName}`,
            html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #0f172a;">New Scholarship Application</h1>
            <p>A new application has been submitted.</p>
            <div style="background-color: #f1f5f9; padding: 16px; border-radius: 8px; margin: 20px 0;">
                <p style="margin: 0;"><strong>Applicant:</strong> ${applicantName}</p>
                <p style="margin: 8px 0 0 0;"><strong>Application ID:</strong> ${applicationId}</p>
            </div>
            <a href="${appUrl}/admin/applications/${applicationId}" style="display: inline-block; background-color: #0f172a; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;">View Application</a>
        </div>
      `
        });
    } catch (error) {
        console.error("Failed to send admin email:", error);
    }
}

export async function sendStatusUpdateEmail(email: string, name: string, status: string) {
    if (!process.env.RESEND_API_KEY) {
        console.warn("RESEND_API_KEY is not set. Email not sent.");
        return;
    }

    const client = getResendClient();
    if (!client) return;

    try {
        await client.emails.send({
            from: 'Antigrav ETF <onboarding@resend.dev>',
            to: email,
            subject: `Application Update - Antigrav ETF`,
            html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
            <h1 style="color: #0f172a;">Application Update</h1>
            <p>Dear ${name},</p>
            <p>Your scholarship application status has been updated to: <strong>${status}</strong>.</p>
            <p>Please log in to your dashboard for more details.</p>
            <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;" />
            <p style="color: #64748b; font-size: 14px;">Best regards,<br/>Antigrav ETF Team</p>
        </div>
      `
        });
    } catch (error) {
        console.error("Failed to send status update email:", error);
    }
}
</file>

<file path="src/lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'
import type { Database } from '@/types/supabase'
import { SupabaseClient } from '@supabase/supabase-js'

let cachedClient: SupabaseClient<Database> | null = null

export function createClient(): SupabaseClient<Database> {
    // Return cached client if available
    if (cachedClient) {
        return cachedClient
    }

    // Only create client in browser environment
    if (typeof window === 'undefined') {
        // During build/SSR, return a mock client that won't be used
        // We cast to unknown first to avoid partial type errors, then to SupabaseClient
        return {
            auth: {
                signUp: async () => ({ data: null, error: new Error('Client not available during build') }),
                signInWithPassword: async () => ({ data: null, error: new Error('Client not available during build') }),
                signOut: async () => ({ error: new Error('Client not available during build') }),
                getSession: async () => ({ data: { session: null }, error: null }),
                getUser: async () => ({ data: { user: null }, error: null }),
                onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => { } } } }),
            }
        } as unknown as SupabaseClient<Database>
    }

    try {
        cachedClient = createBrowserClient<Database>(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
        )
        return cachedClient
    } catch (e) {
        console.error("Failed to create Supabase client:", e);
        // Return a mock client with error methods
        return {
            auth: {
                signUp: async () => ({ data: null, error: new Error('Failed to initialize Supabase client') }),
                signInWithPassword: async () => ({ data: null, error: new Error('Failed to initialize Supabase client') }),
                signOut: async () => ({ error: new Error('Failed to initialize Supabase client') }),
                getSession: async () => ({ data: { session: null }, error: new Error('Failed to initialize Supabase client') }),
                getUser: async () => ({ data: { user: null }, error: new Error('Failed to initialize Supabase client') }),
                onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => { } } } }),
            }
        } as unknown as SupabaseClient<Database>
    }
}
</file>

<file path=".gitignore">
# Dependencies
/node_modules
/.pnp
.pnp.js

# Testing
/coverage

# Next.js
/.next/
/out/

# Production
/build

# Misc
.DS_Store
*.pem

# Vercel
.vercel

# Local Environment Variables
.env.local
.env

# Prisma
# Keep dev.db in gitignore for local development
prisma/dev.db
prisma/dev.db-journal

# Logs & Build Artifacts
*.log
*.txt
*.patch

# PNPM (NEW)
pnpm-debug.log*
</file>

<file path="src/app/page.tsx">
import Image from "next/image";
import Link from "next/link";
import { ArrowRight, BookOpen, Award, Heart, Shield, GraduationCap, Sparkles } from "lucide-react";

export default function Home() {
  return (
    <div className="flex flex-col min-h-screen bg-white">
      {/* ===== Hero Section ===== */}
      <section className="relative flex min-h-175 w-full items-center justify-center text-center text-white">
        {/* Background Image with Solid Overlay */}
        <div className="absolute inset-0 z-0">
          <Image
            src="/hero.png"
            alt="Students in a church community"
            fill
            className="object-cover"
            priority
          />
          <div className="absolute inset-0 bg-slate-900/70" />
        </div>

        {/* Hero Content */}
        <div className="relative z-10 container px-4 py-20 -mt-35 flex flex-col items-center space-y-6">
          <div className="inline-flex items-center gap-2 px-4 py-2 -mb-1 rounded-full border border-white/20 bg-white/10 text-sm font-medium backdrop-blur-sm">
            <Sparkles className="h-4 w-4 text-amber-300" />
            <span className="tracking-wide text-md">Empowering Education Since 2021</span>
          </div>

          <h1 className="text-5xl md:text-7xl font-extrabold tracking-tight leading-tight max-w-4xl">
            Transforming Lives Through <br />
            <span className="text-blue-400">Education & Faith</span>
          </h1>

          <p className="text-lg md:text-xl max-w-3xl mx-auto text-slate-200/90 leading-relaxed font-light">
            The CCC Central Cathedral Abuja Education Trust Fund nurtures the next generation of leaders through scholarships and spiritual guidance.
          </p>

          <div className="flex flex-col sm:flex-row items-center justify-center gap-4 pt-6 w-full max-w-md">
            <Link
              href="/apply"
              className="group inline-flex h-12 w-full sm:w-auto items-center justify-center rounded-xl bg-amber-500 px-8 text-base font-bold text-white shadow-lg transition-all hover:bg-amber-400 hover:shadow-xl hover:-translate-y-0.5"
            >
              Apply for Scholarship
              <ArrowRight className="ml-2 h-5 w-5 transition-transform group-hover:translate-x-1" />
            </Link>
            <Link
              href="/about"
              className="inline-flex h-12 w-full sm:w-auto items-center justify-center rounded-xl border border-white/40 bg-white/10 px-8 text-base font-semibold text-white shadow-md transition-all hover:bg-white/20 hover:-translate-y-0.5 backdrop-blur-sm"
            >
              Learn More
            </Link>
          </div>
        </div>
      </section>
      
      {/* ===== Features Section ===== */}
      <section className="py-20 sm:py-24 bg-slate-50">
        <div className="container px-4 mx-auto">
          <div className="text-center mb-16 max-w-3xl mx-auto">
            <h2 className="text-4xl md:text-5xl font-bold text-slate-900 mb-4">
              Our Commitment to the Community
            </h2>
            <p className="text-lg text-slate-600">
              We are dedicated to making quality education accessible to every deserving student in our church community.
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {/* Feature Card 1 */}
            <div className="group relative p-8 rounded-xl bg-white border border-slate-200 shadow-md transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div className="flex items-center justify-center w-14 h-14 mb-6 rounded-lg bg-blue-600 text-white shadow-md">
                <GraduationCap className="h-7 w-7" />
              </div>
              <h3 className="text-2xl font-bold mb-3 text-slate-900">Comprehensive Scholarships</h3>
              <p className="text-slate-600 leading-relaxed">
                Financial support covering tuition, books, and materials for Primary, Secondary, and Tertiary levels.
              </p>
            </div>

            {/* Feature Card 2 */}
            <div className="group relative p-8 rounded-xl bg-white border border-slate-200 shadow-md transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div className="flex items-center justify-center w-14 h-14 mb-6 rounded-lg bg-rose-600 text-white shadow-md">
                <Heart className="h-7 w-7" />
              </div>
              <h3 className="text-2xl font-bold mb-3 text-slate-900">Community Focused</h3>
              <p className="text-slate-600 leading-relaxed">
                Supporting indigent members of CCC Central Cathedral Abuja with a focus on spiritual and academic growth.
              </p>
            </div>

            {/* Feature Card 3 */}
            <div className="group relative p-8 rounded-xl bg-white border border-slate-200 shadow-md transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
              <div className="flex items-center justify-center w-14 h-14 mb-6 rounded-lg bg-indigo-600 text-white shadow-md">
                <Award className="h-7 w-7" />
              </div>
              <h3 className="text-2xl font-bold mb-3 text-slate-900">Excellence & Integrity</h3>
              <p className="text-slate-600 leading-relaxed">
                Promoting academic excellence, moral standards, and character development in every beneficiary.
              </p>
            </div>
          </div>
        </div>
      </section>

      {/* ===== CTA Section ===== */}
      <section className="py-20 sm:py-24 bg-slate-900 text-white">
        <div className="container px-4 mx-auto text-center">
          <h2 className="text-4xl md:text-5xl font-bold mb-5">
            Ready to Start Your Journey?
          </h2>
          <p className="text-lg text-slate-300 mb-10 max-w-2xl mx-auto">
            Join hundreds of students who have transformed their lives. Apply today and take the first step towards a brighter future.
          </p>
          <Link
            href="/apply"
            className="group inline-flex h-12 items-center justify-center rounded-xl bg-amber-500 px-10 text-base font-bold text-slate-900 shadow-lg transition-transform hover:scale-105"
          >
            Start Your Application
            <ArrowRight className="ml-2 h-5 w-5 transition-transform group-hover:translate-x-1" />
          </Link>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="src/app/api/admin/applications/[id]/route.ts">
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { sendStatusUpdateEmail } from "@/lib/email";

export async function GET(request: Request, { params }: { params: Promise<{ id: string }> }) {
    try {
        const { id } = await params;
        const application = await prisma.application.findUnique({
            where: { id },
            include: {
                applicant: {
                    include: {
                        familyInfo: true
                    }
                }
            }
        });

        if (!application) {
            return NextResponse.json({ success: false, error: "Application not found" }, { status: 404 });
        }

        return NextResponse.json({ success: true, data: application });
    } catch (error) {
        console.error("Error fetching application:", error);
        return NextResponse.json({ success: false, error: "Failed to fetch application" }, { status: 500 });
    }
}

export async function PATCH(request: Request, { params }: { params: Promise<{ id: string }> }) {
    try {
        const { id } = await params;
        const body = await request.json();

        // Extract applicant info if present (for email) and remove from update data
        const { applicant, ...updateData } = body;

        // Ensure numeric fields are actually numbers if present
        if (updateData.scoreFinancial) updateData.scoreFinancial = parseInt(updateData.scoreFinancial);
        if (updateData.scoreAcademic) updateData.scoreAcademic = parseInt(updateData.scoreAcademic);
        if (updateData.scoreChurch) updateData.scoreChurch = parseInt(updateData.scoreChurch);

        const updatedApplication = await prisma.application.update({
            where: { id },
            data: updateData,
            include: {
                applicant: true
            }
        });

        // Send email if status changed and we have an email
        if (updateData.status && updatedApplication.applicant?.email) {
            await sendStatusUpdateEmail(
                updatedApplication.applicant.email,
                updatedApplication.applicant.firstName,
                updateData.status
            );
        }

        return NextResponse.json({ success: true, data: updatedApplication });
    } catch (error) {
        console.error("Error updating application:", error);
        return NextResponse.json({ success: false, error: "Failed to update application" }, { status: 500 });
    }
}
</file>

<file path="src/types/supabase.ts">
export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  public: {
    Tables: {
      AdminUser: {
        Row: {
          createdAt: string
          email: string
          id: string
          name: string | null
          role: string
        }
        Insert: {
          createdAt?: string
          email: string
          id: string
          name?: string | null
          role?: string
        }
        Update: {
          createdAt?: string
          email?: string
          id?: string
          name?: string | null
          role?: string
        }
        Relationships: []
      }
      Applicant: {
        Row: {
          address: string
          age: number
          createdAt: string
          dob: string
          email: string | null
          firstName: string
          id: string
          lga: string
          middleName: string | null
          parish: string
          phone: string
          prevScholarship: boolean
          prevScholarshipDate: string | null
          sex: string
          stateOrigin: string
          surname: string
          town: string
          updatedAt: string
        }
        Insert: {
          address: string
          age: number
          createdAt?: string
          dob: string
          email?: string | null
          firstName: string
          id: string
          lga: string
          middleName?: string | null
          parish?: string
          phone: string
          prevScholarship?: boolean
          prevScholarshipDate?: string | null
          sex: string
          stateOrigin: string
          surname: string
          town: string
          updatedAt: string
        }
        Update: {
          address?: string
          age?: number
          createdAt?: string
          dob?: string
          email?: string | null
          firstName?: string
          id?: string
          lga?: string
          middleName?: string | null
          parish?: string
          phone?: string
          prevScholarship?: boolean
          prevScholarshipDate?: string | null
          sex?: string
          stateOrigin?: string
          surname?: string
          town?: string
          updatedAt?: string
        }
        Relationships: []
      }
      Application: {
        Row: {
          admissionLetterUrl: string | null
          applicantId: string
          approvedAmount: string | null
          assistanceLetterUrl: string | null
          birthCertUrl: string | null
          classPosition: string | null
          classSize: number | null
          committeeNotes: string | null
          createdAt: string
          disbursedDate: string | null
          enoughBooks: boolean
          id: string
          lastResult: string | null
          libraryAccess: boolean
          passportUrl: string | null
          paymentReference: string | null
          presentClass: string
          primaryCertUrl: string | null
          repeatedClass: boolean
          schoolAddress: string
          schoolBillUrl: string | null
          schoolFees: string
          schoolName: string
          schoolResultUrl: string | null
          scoreAcademic: number | null
          scoreChurch: number | null
          scoreFinancial: number | null
          sentAway: boolean
          status: string
          textBooksCost: string | null
          updatedAt: string
          voucherCode: string | null
        }
        Insert: {
          admissionLetterUrl?: string | null
          applicantId: string
          approvedAmount?: string | null
          assistanceLetterUrl?: string | null
          birthCertUrl?: string | null
          classPosition?: string | null
          classSize?: number | null
          committeeNotes?: string | null
          createdAt?: string
          disbursedDate?: string | null
          enoughBooks?: boolean
          id: string
          lastResult?: string | null
          libraryAccess?: boolean
          passportUrl?: string | null
          paymentReference?: string | null
          presentClass: string
          primaryCertUrl?: string | null
          repeatedClass?: boolean
          schoolAddress: string
          schoolBillUrl?: string | null
          schoolFees: string
          schoolName: string
          schoolResultUrl?: string | null
          scoreAcademic?: number | null
          scoreChurch?: number | null
          scoreFinancial?: number | null
          sentAway?: boolean
          status?: string
          textBooksCost?: string | null
          updatedAt: string
          voucherCode?: string | null
        }
        Update: {
          admissionLetterUrl?: string | null
          applicantId?: string
          approvedAmount?: string | null
          assistanceLetterUrl?: string | null
          birthCertUrl?: string | null
          classPosition?: string | null
          classSize?: number | null
          committeeNotes?: string | null
          createdAt?: string
          disbursedDate?: string | null
          enoughBooks?: boolean
          id?: string
          lastResult?: string | null
          libraryAccess?: boolean
          passportUrl?: string | null
          paymentReference?: string | null
          presentClass?: string
          primaryCertUrl?: string | null
          repeatedClass?: boolean
          schoolAddress?: string
          schoolBillUrl?: string | null
          schoolFees?: string
          schoolName?: string
          schoolResultUrl?: string | null
          scoreAcademic?: number | null
          scoreChurch?: number | null
          scoreFinancial?: number | null
          sentAway?: boolean
          status?: string
          textBooksCost?: string | null
          updatedAt?: string
          voucherCode?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "Application_applicantId_fkey"
            columns: ["applicantId"]
            isOneToOne: false
            referencedRelation: "Applicant"
            referencedColumns: ["id"]
          },
        ]
      }
      Budget: {
        Row: {
          allocated: number
          category: string
          createdAt: string
          description: string | null
          id: string
          quarter: number | null
          spent: number
          updatedAt: string
          year: number
        }
        Insert: {
          allocated: number
          category: string
          createdAt?: string
          description?: string | null
          id: string
          quarter?: number | null
          spent?: number
          updatedAt: string
          year: number
        }
        Update: {
          allocated?: number
          category?: string
          createdAt?: string
          description?: string | null
          id?: string
          quarter?: number | null
          spent?: number
          updatedAt?: string
          year?: number
        }
        Relationships: []
      }
      Donation: {
        Row: {
          createdAt: string
          donationType: string
          donorAddress: string | null
          donorEmail: string | null
          donorName: string
          donorPhone: string | null
          id: string
          isAnonymous: boolean
          notes: string | null
          purpose: string | null
          receiptIssued: boolean
          receiptNumber: string | null
          transactionId: string
          updatedAt: string
        }
        Insert: {
          createdAt?: string
          donationType: string
          donorAddress?: string | null
          donorEmail?: string | null
          donorName: string
          donorPhone?: string | null
          id: string
          isAnonymous?: boolean
          notes?: string | null
          purpose?: string | null
          receiptIssued?: boolean
          receiptNumber?: string | null
          transactionId: string
          updatedAt: string
        }
        Update: {
          createdAt?: string
          donationType?: string
          donorAddress?: string | null
          donorEmail?: string | null
          donorName?: string
          donorPhone?: string | null
          id?: string
          isAnonymous?: boolean
          notes?: string | null
          purpose?: string | null
          receiptIssued?: boolean
          receiptNumber?: string | null
          transactionId?: string
          updatedAt?: string
        }
        Relationships: [
          {
            foreignKeyName: "Donation_transactionId_fkey"
            columns: ["transactionId"]
            isOneToOne: true
            referencedRelation: "Transaction"
            referencedColumns: ["id"]
          },
        ]
      }
      FamilyInfo: {
        Row: {
          applicantId: string
          fatherAddress: string | null
          fatherChildrenAges: string | null
          fatherChurchDuties: string | null
          fatherChurchPosition: string | null
          fatherEmployer: string | null
          fatherFirstName: string | null
          fatherIncome: string | null
          fatherLga: string | null
          fatherMiddleName: string | null
          fatherNumChildren: number | null
          fatherObligations: string | null
          fatherOccupation: string | null
          fatherPhone: string | null
          fatherSalaryGrade: string | null
          fatherSpouse: string | null
          fatherState: string | null
          fatherSurname: string | null
          fatherTown: string | null
          fatherYearsServed: string | null
          id: string
          motherAddress: string | null
          motherChildrenAges: string | null
          motherChurchDuties: string | null
          motherChurchPosition: string | null
          motherEmployer: string | null
          motherFirstName: string | null
          motherIncome: string | null
          motherLga: string | null
          motherMiddleName: string | null
          motherNumChildren: number | null
          motherObligations: string | null
          motherOccupation: string | null
          motherPhone: string | null
          motherSalaryGrade: string | null
          motherSpouse: string | null
          motherState: string | null
          motherSurname: string | null
          motherTown: string | null
          motherYearsServed: string | null
        }
        Insert: {
          applicantId: string
          fatherAddress?: string | null
          fatherChildrenAges?: string | null
          fatherChurchDuties?: string | null
          fatherChurchPosition?: string | null
          fatherEmployer?: string | null
          fatherFirstName?: string | null
          fatherIncome?: string | null
          fatherLga?: string | null
          fatherMiddleName?: string | null
          fatherNumChildren?: number | null
          fatherObligations?: string | null
          fatherOccupation?: string | null
          fatherPhone?: string | null
          fatherSalaryGrade?: string | null
          fatherSpouse?: string | null
          fatherState?: string | null
          fatherSurname?: string | null
          fatherTown?: string | null
          fatherYearsServed?: string | null
          id: string
          motherAddress?: string | null
          motherChildrenAges?: string | null
          motherChurchDuties?: string | null
          motherChurchPosition?: string | null
          motherEmployer?: string | null
          motherFirstName?: string | null
          motherIncome?: string | null
          motherLga?: string | null
          motherMiddleName?: string | null
          motherNumChildren?: number | null
          motherObligations?: string | null
          motherOccupation?: string | null
          motherPhone?: string | null
          motherSalaryGrade?: string | null
          motherSpouse?: string | null
          motherState?: string | null
          motherSurname?: string | null
          motherTown?: string | null
          motherYearsServed?: string | null
        }
        Update: {
          applicantId?: string
          fatherAddress?: string | null
          fatherChildrenAges?: string | null
          fatherChurchDuties?: string | null
          fatherChurchPosition?: string | null
          fatherEmployer?: string | null
          fatherFirstName?: string | null
          fatherIncome?: string | null
          fatherLga?: string | null
          fatherMiddleName?: string | null
          fatherNumChildren?: number | null
          fatherObligations?: string | null
          fatherOccupation?: string | null
          fatherPhone?: string | null
          fatherSalaryGrade?: string | null
          fatherSpouse?: string | null
          fatherState?: string | null
          fatherSurname?: string | null
          fatherTown?: string | null
          fatherYearsServed?: string | null
          id?: string
          motherAddress?: string | null
          motherChildrenAges?: string | null
          motherChurchDuties?: string | null
          motherChurchPosition?: string | null
          motherEmployer?: string | null
          motherFirstName?: string | null
          motherIncome?: string | null
          motherLga?: string | null
          motherMiddleName?: string | null
          motherNumChildren?: number | null
          motherObligations?: string | null
          motherOccupation?: string | null
          motherPhone?: string | null
          motherSalaryGrade?: string | null
          motherSpouse?: string | null
          motherState?: string | null
          motherSurname?: string | null
          motherTown?: string | null
          motherYearsServed?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "FamilyInfo_applicantId_fkey"
            columns: ["applicantId"]
            isOneToOne: false
            referencedRelation: "Applicant"
            referencedColumns: ["id"]
          },
        ]
      }
      Transaction: {
        Row: {
          amount: number
          budgetId: string | null
          category: string
          createdAt: string
          createdBy: string | null
          date: string
          description: string
          id: string
          reference: string | null
          type: string
          updatedAt: string
        }
        Insert: {
          amount: number
          budgetId?: string | null
          category: string
          createdAt?: string
          createdBy?: string | null
          date: string
          description: string
          id: string
          reference?: string | null
          type: string
          updatedAt: string
        }
        Update: {
          amount?: number
          budgetId?: string | null
          category?: string
          createdAt?: string
          createdBy?: string | null
          date?: string
          description?: string
          id?: string
          reference?: string | null
          type?: string
          updatedAt?: string
        }
        Relationships: [
          {
            foreignKeyName: "Transaction_budgetId_fkey"
            columns: ["budgetId"]
            isOneToOne: false
            referencedRelation: "Budget"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      [_ in never]: never
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}
export type Tables<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Row']
export type TablesInsert<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Insert']
export type TablesUpdate<T extends keyof Database['public']['Tables']> = Database['public']['Tables'][T]['Update']
export type Enums<T extends keyof Database['public']['Enums']> = Database['public']['Enums'][T]
</file>

<file path="src/app/api/admin/users/route.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr";
import { cookies } from "next/headers";
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

export const dynamic = "force-dynamic";

// Initialize Supabase Admin Client for Admin Auth Operations
// This requires SUPABASE_SERVICE_ROLE_KEY to be set in environment variables
// Initialize Supabase Admin Client for Admin Auth Operations
// Lazily initialized to avoid build-time errors if env vars are missing
const getSupabaseAdmin = () => {
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY || "",
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false,
            },
        }
    );
};

// Helper to check for configuration
function checkConfig() {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        throw new Error("SUPABASE_SERVICE_ROLE_KEY is not defined");
    }
}

// Helper to create a Supabase client ensuring async cookies are handled
async function createSupabaseServerClient() {
    const cookieStore = await cookies();

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value;
                },
                set(name: string, value: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value, ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
                remove(name: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value: "", ...options });
                    } catch (error) {
                        // Handle server action/component restrictions
                    }
                },
            },
        }
    );
}

// GET - List all admin users
export async function GET(req: NextRequest) {
    try {
        const supabase = await createSupabaseServerClient();

        // Check if user is authenticated
        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: "Unauthorized: No active session found" }, { status: 401 });
        }

        if (!session.user?.email) {
            return NextResponse.json({ error: "Unauthorized: Session has no email" }, { status: 401 });
        }

        // Verify SuperAdmin role
        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("role")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin) {
            return NextResponse.json(
                { error: "Forbidden: You are not registered as an AdminUser" },
                { status: 403 }
            );
        }

        if (currentAdmin.role !== "SuperAdmin") {
            return NextResponse.json(
                { error: `Forbidden: Requires SuperAdmin role (Current: ${currentAdmin.role})` },
                { status: 403 }
            );
        }

        // Get all admin users
        const { data: adminUsers, error } = await supabase
            .from("AdminUser")
            .select("*")
            .order("createdAt", { ascending: false });

        if (error) {
            console.error("Error fetching admin users:", error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // Get Supabase Auth users to check if accounts are active
        // Use getSupabaseAdmin because listUsers requires service_role permissions
        const { data: authUsers, error: listUsersError } = await getSupabaseAdmin().auth.admin.listUsers();

        if (listUsersError) {
            console.error("Error fetching auth users:", listUsersError);
            // We continue, but status might be inaccurate
        }

        // Merge data to show account status
        const usersWithStatus = adminUsers.map((admin: any) => {
            const authUser = authUsers?.users?.find((u: any) => u.email === admin.email);
            return {
                ...admin,
                isActive: !!authUser,
                lastSignIn: authUser?.last_sign_in_at || null,
            };
        });

        return NextResponse.json({ users: usersWithStatus });
    } catch (error: any) {
        console.error("Error in GET /api/admin/users:", error);
        return NextResponse.json(
            { error: `Internal server error: ${error.message}` },
            { status: 500 }
        );
    }
}

// POST - Create new admin user
export async function POST(req: NextRequest) {
    try {
        checkConfig();
        const supabase = await createSupabaseServerClient();

        // Check if user is authenticated
        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        if (!session.user?.email) {
            return NextResponse.json({ error: "User email not found" }, { status: 401 });
        }

        // Verify SuperAdmin role
        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("role")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin || currentAdmin.role !== "SuperAdmin") {
            return NextResponse.json(
                { error: "Forbidden - SuperAdmin access required" },
                { status: 403 }
            );
        }

        const body = await req.json();
        const { email, name, role, password } = body;

        // Validate input
        if (!email || !name || !role || !password) {
            return NextResponse.json(
                { error: "Email, name, role, and password are required" },
                { status: 400 }
            );
        }

        if (!["Admin", "SuperAdmin"].includes(role)) {
            return NextResponse.json(
                { error: "Role must be either 'Admin' or 'SuperAdmin'" },
                { status: 400 }
            );
        }

        // Check if user already exists in AdminUser table
        const { data: existingAdmin } = await supabase
            .from("AdminUser")
            .select("id")
            .eq("email", email)
            .single();

        if (existingAdmin) {
            return NextResponse.json(
                { error: "Admin user with this email already exists" },
                { status: 409 }
            );
        }

        // Create Supabase Auth user
        // Use getSupabaseAdmin for privileged creation
        const { data: authUser, error: authError } = await getSupabaseAdmin().auth.admin.createUser({
            email,
            password,
            email_confirm: true, // Auto-confirm email
            user_metadata: {
                name,
                role,
            },
        });

        if (authError) {
            console.error("Error creating auth user:", authError);
            return NextResponse.json(
                { error: `Failed to create auth user: ${authError.message}` },
                { status: 500 }
            );
        }

        // Add to AdminUser table
        const { data: newAdmin, error: dbError } = await supabase
            .from("AdminUser")
            .insert({
                email,
                name,
                role,
            })
            .select()
            .single();

        if (dbError) {
            console.error("Error creating admin user in database:", dbError);
            // Rollback: Delete the auth user
            await getSupabaseAdmin().auth.admin.deleteUser(authUser.user.id);
            return NextResponse.json(
                { error: `Failed to create admin user: ${dbError.message}` },
                { status: 500 }
            );
        }

        return NextResponse.json(
            {
                message: "Admin user created successfully",
                user: newAdmin,
            },
            { status: 201 }
        );
    } catch (error: any) {
        console.error("Error in POST /api/admin/users:", error);
        return NextResponse.json(
            { error: `Internal server error: ${error.message}` },
            { status: 500 }
        );
    }
}

// PATCH - Update admin user role
export async function PATCH(req: NextRequest) {
    try {
        const supabase = await createSupabaseServerClient();

        // Check if user is authenticated
        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        if (!session.user?.email) {
            return NextResponse.json({ error: "User email not found" }, { status: 401 });
        }

        // Verify SuperAdmin role
        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("role")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin || currentAdmin.role !== "SuperAdmin") {
            return NextResponse.json(
                { error: "Forbidden - SuperAdmin access required" },
                { status: 403 }
            );
        }

        const body = await req.json();
        const { id, role, name, status } = body;

        if (!id) {
            return NextResponse.json(
                { error: "User ID is required" },
                { status: 400 }
            );
        }

        if (role && !["Admin", "SuperAdmin", "Committee"].includes(role)) {
            return NextResponse.json(
                { error: "Role must be Admin, SuperAdmin, or Committee" },
                { status: 400 }
            );
        }

        if (status && !["Pending", "Approved", "Rejected"].includes(status)) {
            return NextResponse.json(
                { error: "Status must be Pending, Approved, or Rejected" },
                { status: 400 }
            );
        }

        // Update AdminUser table
        const updateData: any = {};
        if (role) updateData.role = role;
        if (name) updateData.name = name;
        if (status) updateData.status = status;

        const { data: updatedAdmin, error } = await supabase
            .from("AdminUser")
            .update(updateData)
            .eq("id", id)
            .select()
            .single();

        if (error) {
            console.error("Error updating admin user:", error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({
            message: "Admin user updated successfully",
            user: updatedAdmin,
        });
    } catch (error: any) {
        console.error("Error in PATCH /api/admin/users:", error);
        return NextResponse.json(
            { error: "Internal server error" },
            { status: 500 }
        );
    }
}

// DELETE - Deactivate admin user
export async function DELETE(req: NextRequest) {
    try {
        const supabase = await createSupabaseServerClient();

        // Check if user is authenticated
        const {
            data: { session },
        } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        if (!session.user?.email) {
            return NextResponse.json({ error: "User email not found" }, { status: 401 });
        }

        // Verify SuperAdmin role
        const { data: currentAdmin } = await supabase
            .from("AdminUser")
            .select("role, email")
            .eq("email", session.user.email)
            .single();

        if (!currentAdmin || currentAdmin.role !== "SuperAdmin") {
            return NextResponse.json(
                { error: "Forbidden - SuperAdmin access required" },
                { status: 403 }
            );
        }

        const { searchParams } = new URL(req.url);
        const userId = searchParams.get("id");

        if (!userId) {
            return NextResponse.json(
                { error: "User ID is required" },
                { status: 400 }
            );
        }

        // Get the admin user to delete
        const { data: adminToDelete } = await supabase
            .from("AdminUser")
            .select("email")
            .eq("id", userId)
            .single();

        if (!adminToDelete) {
            return NextResponse.json(
                { error: "Admin user not found" },
                { status: 404 }
            );
        }

        // Prevent self-deletion
        if (adminToDelete.email === currentAdmin.email) {
            return NextResponse.json(
                { error: "Cannot delete your own account" },
                { status: 400 }
            );
        }

        // Get the auth user ID
        // Use getSupabaseAdmin
        const { data: authUsers } = await getSupabaseAdmin().auth.admin.listUsers();
        const authUser = authUsers?.users?.find((u: any) => u.email === adminToDelete.email);

        // Delete from AdminUser table
        const { error: dbError } = await supabase
            .from("AdminUser")
            .delete()
            .eq("id", userId);

        if (dbError) {
            console.error("Error deleting admin user from database:", dbError);
            return NextResponse.json({ error: dbError.message }, { status: 500 });
        }

        // Delete from Supabase Auth if exists
        // Use getSupabaseAdmin
        if (authUser) {
            const { error: authError } = await getSupabaseAdmin().auth.admin.deleteUser(authUser.id);
            if (authError) {
                console.error("Error deleting auth user:", authError);
                // Don't fail the request if auth deletion fails
            }
        }

        return NextResponse.json({
            message: "Admin user deactivated successfully",
        });
    } catch (error: any) {
        console.error("Error in DELETE /api/admin/users:", error);
        return NextResponse.json(
            { error: "Internal server error" },
            { status: 500 }
        );
    }
}
</file>

<file path="package.json">
{
  "name": "etf-platform",
  "version": "0.1.0",
  "private": true,
  "engines": {
    "node": ">=24.0.0"
  },
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "postinstall": "prisma generate"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.84.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "dotenv": "^17.2.3",
    "lucide-react": "^0.554.0",
    "next": "16.0.7",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "resend": "^6.5.2",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@prisma/client": "^5.22.0",
    "@tailwindcss/postcss": "^4",
    "@types/node": "^25.0.3",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.7",
    "prisma": "^5.22.0",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

</files>
